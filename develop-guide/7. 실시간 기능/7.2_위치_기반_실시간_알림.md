# ğŸ“ 7.2 ìœ„ì¹˜ ê¸°ë°˜ ì‹¤ì‹œê°„ ì•Œë¦¼

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ìœ„ì¹˜ ì„œë¹„ìŠ¤ ì„¤ì •](#2-ìœ„ì¹˜-ì„œë¹„ìŠ¤-ì„¤ì •)
3. [êµ¬í˜„](#3-êµ¬í˜„)
4. [ê²€ì¦](#4-ê²€ì¦)

## 1. ê°œìš”
ì‚¬ìš©ì ìœ„ì¹˜ ë³€ê²½ì„ ê°ì§€í•˜ê³  ê·¼ì²˜ì˜ íŠ¹ë³„í•œ ì •ë³´(ì´ë²¤íŠ¸, ì¸í”Œë£¨ì–¸ì„œ)ì— ëŒ€í•œ ì‹¤ì‹œê°„ ì•Œë¦¼ì„ ì œê³µí•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ìœ„ì¹˜ ë³€ê²½ ê°ì§€
- âœ… ê·¼ì ‘ ì•Œë¦¼ ë¡œì§
- âœ… ë°°í„°ë¦¬ ìµœì í™”
- âœ… ì•Œë¦¼ ë¹ˆë„ ì œì–´

## 2. ìœ„ì¹˜ ì„œë¹„ìŠ¤ ì„¤ì •

### [í•„ìˆ˜] íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
```yaml
# íŒŒì¼: pubspec.yaml
dependencies:
  geolocator: ^10.1.0
  flutter_local_notifications: ^16.1.0
  workmanager: ^0.5.1  # ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…
```

### [í•„ìˆ˜] í”Œë«í¼ë³„ ì„¤ì •

#### iOS ë°±ê·¸ë¼ìš´ë“œ ìœ„ì¹˜
```xml
<!-- íŒŒì¼: ios/Runner/Info.plist -->
<key>UIBackgroundModes</key>
<array>
    <string>location</string>
    <string>fetch</string>
</array>
<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>ì£¼ë³€ì˜ íŠ¹ë³„í•œ ë§›ì§‘ ì •ë³´ë¥¼ ì•Œë ¤ë“œë¦¬ê¸° ìœ„í•´ ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</string>
```

#### Android ë°±ê·¸ë¼ìš´ë“œ ìœ„ì¹˜
```xml
<!-- íŒŒì¼: android/app/src/main/AndroidManifest.xml -->
<uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
```

## 3. êµ¬í˜„

### [í•„ìˆ˜] ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/core/services/location_monitoring_service.dart
import 'package:geolocator/geolocator.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class LocationMonitoringService {
  static final LocationMonitoringService _instance = LocationMonitoringService._internal();
  factory LocationMonitoringService() => _instance;
  LocationMonitoringService._internal();
  
  // ìœ„ì¹˜ ìŠ¤íŠ¸ë¦¼
  StreamSubscription<Position>? _positionStream;
  Position? _lastPosition;
  DateTime? _lastNotificationTime;
  
  // ì„¤ì • ìƒìˆ˜
  static const double _minDistanceFilter = 100; // 100m ì´ë™ ì‹œ ì—…ë°ì´íŠ¸
  static const Duration _notificationCooldown = Duration(minutes: 5);
  static const double _proximityRadius = 1000; // 1km
  
  // ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§ ì‹œì‘
  Future<void> startMonitoring() async {
    // ê¶Œí•œ í™•ì¸
    final permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied ||
        permission == LocationPermission.deniedForever) {
      return;
    }
    
    // ìœ„ì¹˜ ì„¤ì • (ë°°í„°ë¦¬ ìµœì í™”)
    const locationSettings = LocationSettings(
      accuracy: LocationAccuracy.balanced, // ë°°í„°ë¦¬ ì ˆì•½
      distanceFilter: _minDistanceFilter,
    );
    
    // ìœ„ì¹˜ ìŠ¤íŠ¸ë¦¼ êµ¬ë…
    _positionStream = Geolocator.getPositionStream(
      locationSettings: locationSettings,
    ).listen(_onLocationChanged);
  }
  
  // ìœ„ì¹˜ ë³€ê²½ ì²˜ë¦¬
  void _onLocationChanged(Position position) async {
    // ì²« ìœ„ì¹˜ ë˜ëŠ” ì¶©ë¶„íˆ ì´ë™í–ˆì„ ë•Œë§Œ ì²˜ë¦¬
    if (_lastPosition == null ||
        Geolocator.distanceBetween(
          _lastPosition!.latitude,
          _lastPosition!.longitude,
          position.latitude,
          position.longitude,
        ) >= _minDistanceFilter) {
      
      _lastPosition = position;
      
      // ê·¼ì ‘ ì •ë³´ í™•ì¸
      await _checkProximityAlerts(position);
    }
  }
  
  // ê·¼ì ‘ ì•Œë¦¼ í™•ì¸
  Future<void> _checkProximityAlerts(Position position) async {
    // ì•Œë¦¼ ì¿¨ë‹¤ìš´ í™•ì¸
    if (_lastNotificationTime != null &&
        DateTime.now().difference(_lastNotificationTime!) < _notificationCooldown) {
      return;
    }
    
    try {
      // ê·¼ì²˜ ì´ë²¤íŠ¸ í™•ì¸
      final nearbyEvents = await _getNearbyEvents(position);
      if (nearbyEvents.isNotEmpty) {
        await _showEventNotification(nearbyEvents.first);
        _lastNotificationTime = DateTime.now();
        return;
      }
      
      // ê·¼ì²˜ ì¸í”Œë£¨ì–¸ì„œ í™•ì¸
      final nearbyInfluencers = await _getNearbyInfluencers(position);
      if (nearbyInfluencers.isNotEmpty) {
        await _showInfluencerNotification(nearbyInfluencers.first);
        _lastNotificationTime = DateTime.now();
      }
    } catch (e) {
      print('Proximity check error: $e');
    }
  }
  
  // ê·¼ì²˜ ì´ë²¤íŠ¸ ì¡°íšŒ
  Future<List<EventModel>> _getNearbyEvents(Position position) async {
    if (AppConfig.current.isLocal) {
      // Mock ë°ì´í„°
      return MockLocationData.getNearbyEvents(position);
    }
    
    // Firestore ì¿¼ë¦¬
    final snapshot = await FirestoreService.instance
        .collection('events')
        .where('isActive', isEqualTo: true)
        .where('endDate', isGreaterThan: DateTime.now())
        .get();
    
    return snapshot.docs
        .map((doc) => EventModel.fromFirestore(doc))
        .where((event) {
          final distance = Geolocator.distanceBetween(
            position.latitude,
            position.longitude,
            event.latitude,
            event.longitude,
          );
          return distance <= _proximityRadius;
        })
        .toList();
  }
  
  // ê·¼ì²˜ ì¸í”Œë£¨ì–¸ì„œ ì¡°íšŒ
  Future<List<InfluencerLocation>> _getNearbyInfluencers(Position position) async {
    if (AppConfig.current.isLocal) {
      // Mock ë°ì´í„°
      return MockLocationData.getNearbyInfluencers(position);
    }
    
    // Firestore ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¡°íšŒ
    final snapshot = await FirestoreService.instance
        .collection('influencer_locations')
        .where('isSharing', isEqualTo: true)
        .where('updatedAt', isGreaterThan: DateTime.now().subtract(Duration(minutes: 30)))
        .get();
    
    return snapshot.docs
        .map((doc) => InfluencerLocation.fromFirestore(doc))
        .where((influencer) {
          final distance = Geolocator.distanceBetween(
            position.latitude,
            position.longitude,
            influencer.latitude,
            influencer.longitude,
          );
          return distance <= _proximityRadius;
        })
        .toList();
  }
  
  // ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
  void stopMonitoring() {
    _positionStream?.cancel();
    _positionStream = null;
  }
  
  // ë°°í„°ë¦¬ ìµœì í™” ëª¨ë“œ ì„¤ì •
  void setBatteryOptimization(BatteryMode mode) {
    stopMonitoring();
    
    switch (mode) {
      case BatteryMode.aggressive:
        // ìµœì†Œí•œì˜ ì—…ë°ì´íŠ¸ë§Œ
        _minDistanceFilter = 500;
        break;
      case BatteryMode.balanced:
        // ê¸°ë³¸ ì„¤ì •
        _minDistanceFilter = 100;
        break;
      case BatteryMode.performance:
        // ìì£¼ ì—…ë°ì´íŠ¸
        _minDistanceFilter = 50;
        break;
    }
    
    startMonitoring();
  }
}

enum BatteryMode { aggressive, balanced, performance }
```

### [í•„ìˆ˜] ì•Œë¦¼ ë§¤ë‹ˆì €
```dart
// íŒŒì¼: lib/core/services/notification_manager.dart
class NotificationManager {
  static final FlutterLocalNotificationsPlugin _notifications = 
      FlutterLocalNotificationsPlugin();
  
  // ì´ˆê¸°í™”
  static Future<void> initialize() async {
    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');
    const iosSettings = DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );
    
    const initSettings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );
    
    await _notifications.initialize(
      initSettings,
      onDidReceiveNotificationResponse: _onNotificationTapped,
    );
  }
  
  // ì´ë²¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
  static Future<void> showEventNotification(EventModel event) async {
    const androidDetails = AndroidNotificationDetails(
      'proximity_events',
      'ì£¼ë³€ ì´ë²¤íŠ¸',
      channelDescription: 'ê·¼ì²˜ì˜ íŠ¹ë³„í•œ ì´ë²¤íŠ¸ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤',
      importance: Importance.high,
      priority: Priority.high,
      icon: '@drawable/ic_event',
    );
    
    const iosDetails = DarwinNotificationDetails(
      presentAlert: true,
      presentBadge: true,
      presentSound: true,
    );
    
    const details = NotificationDetails(
      android: androidDetails,
      iOS: iosDetails,
    );
    
    await _notifications.show(
      event.id.hashCode,
      'ğŸª ${event.name}',
      '${event.distance}m ê·¼ì²˜ì—ì„œ ì§„í–‰ ì¤‘!',
      details,
      payload: 'event:${event.id}',
    );
  }
  
  // ì¸í”Œë£¨ì–¸ì„œ ì•Œë¦¼ í‘œì‹œ
  static Future<void> showInfluencerNotification(InfluencerLocation influencer) async {
    const androidDetails = AndroidNotificationDetails(
      'proximity_influencers',
      'ì¸í”Œë£¨ì–¸ì„œ ê·¼ì ‘',
      channelDescription: 'ê·¼ì²˜ì˜ ë¯¸ì‹ ì¸í”Œë£¨ì–¸ì„œë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤',
      importance: Importance.high,
      priority: Priority.high,
      icon: '@drawable/ic_star',
    );
    
    const iosDetails = DarwinNotificationDetails(
      presentAlert: true,
      presentBadge: true,
      presentSound: true,
    );
    
    const details = NotificationDetails(
      android: androidDetails,
      iOS: iosDetails,
    );
    
    await _notifications.show(
      influencer.userId.hashCode,
      'â­ ${influencer.nickname}ë‹˜ì´ ê·¼ì²˜ì— ìˆì–´ìš”!',
      '${influencer.gradeName} ë“±ê¸‰ ë¯¸ì‹ê°€ê°€ ${influencer.distance}m ê·¼ì²˜ì—ì„œ í™œë™ ì¤‘',
      details,
      payload: 'influencer:${influencer.userId}',
    );
  }
  
  // ì•Œë¦¼ íƒ­ ì²˜ë¦¬
  static void _onNotificationTapped(NotificationResponse response) {
    final payload = response.payload;
    if (payload == null) return;
    
    if (payload.startsWith('event:')) {
      final eventId = payload.substring(6);
      // ì´ë²¤íŠ¸ ìƒì„¸ë¡œ ì´ë™
      NavigationService.navigateTo('/event/$eventId');
    } else if (payload.startsWith('influencer:')) {
      final userId = payload.substring(11);
      // ì¸í”Œë£¨ì–¸ì„œ í”„ë¡œí•„ë¡œ ì´ë™
      NavigationService.navigateTo('/profile/$userId');
    }
  }
}
```

### [í•„ìˆ˜] Mock ìœ„ì¹˜ ë°ì´í„°
```dart
// íŒŒì¼: lib/core/mock/mock_location_data.dart
class MockLocationData {
  static List<EventModel> getNearbyEvents(Position position) {
    // ëœë¤í•˜ê²Œ ì´ë²¤íŠ¸ ìƒì„±
    if (Random().nextInt(10) > 7) {
      return [
        EventModel(
          id: 'event_${DateTime.now().millisecondsSinceEpoch}',
          name: 'ê°•ë‚¨ ì¹˜í‚¨ í˜ìŠ¤í‹°ë²Œ',
          latitude: position.latitude + 0.005,
          longitude: position.longitude + 0.005,
          distance: 500,
          startDate: DateTime.now().subtract(Duration(days: 1)),
          endDate: DateTime.now().add(Duration(days: 3)),
        ),
      ];
    }
    return [];
  }
  
  static List<InfluencerLocation> getNearbyInfluencers(Position position) {
    // ëœë¤í•˜ê²Œ ì¸í”Œë£¨ì–¸ì„œ ìƒì„±
    if (Random().nextInt(10) > 8) {
      return [
        InfluencerLocation(
          userId: 'user_${DateTime.now().millisecondsSinceEpoch}',
          nickname: 'ë§›ìˆëŠ”ëŒ€ì¥ê¸ˆ',
          gradeName: 'ëŒ€ì¥ê¸ˆ â­â­',
          latitude: position.latitude + 0.003,
          longitude: position.longitude + 0.003,
          distance: 300,
          updatedAt: DateTime.now(),
        ),
      ];
    }
    return [];
  }
}
```

### [ì„ íƒ] ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…
```dart
// íŒŒì¼: lib/core/services/background_service.dart
class BackgroundService {
  static void initialize() {
    Workmanager().initialize(
      callbackDispatcher,
      isInDebugMode: false,
    );
    
    // ì£¼ê¸°ì  ìœ„ì¹˜ í™•ì¸ (15ë¶„ë§ˆë‹¤)
    Workmanager().registerPeriodicTask(
      'location_check',
      'checkNearbyInfo',
      frequency: Duration(minutes: 15),
      constraints: Constraints(
        networkType: NetworkType.connected,
        requiresBatteryNotLow: true,
      ),
    );
  }
}

void callbackDispatcher() {
  Workmanager().executeTask((task, inputData) async {
    if (task == 'checkNearbyInfo') {
      // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìœ„ì¹˜ í™•ì¸
      final position = await Geolocator.getCurrentPosition();
      // ì•Œë¦¼ ì²˜ë¦¬...
    }
    return Future.value(true);
  });
}
```

## 4. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ë° ì²˜ë¦¬
- [ ] 100m ì´ìƒ ì´ë™ ì‹œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
- [ ] 1km ë‚´ ì´ë²¤íŠ¸ ë°œê²¬ ì‹œ ì•Œë¦¼
- [ ] 1km ë‚´ ì¸í”Œë£¨ì–¸ì„œ ë°œê²¬ ì‹œ ì•Œë¦¼
- [ ] 5ë¶„ ì¿¨ë‹¤ìš´ìœ¼ë¡œ ì•Œë¦¼ ìŠ¤íŒ¸ ë°©ì§€
- [ ] ë°°í„°ë¦¬ ëª¨ë“œë³„ ë™ì‘ í™•ì¸
- [ ] ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ì •ìƒ ì‘ë™