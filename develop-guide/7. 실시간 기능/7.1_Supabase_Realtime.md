# ğŸ“¡ 7.1 Supabase Realtime

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [DB ì„¤ì •](#2-db-ì„¤ì •)
3. [ì‹¤ì‹œê°„ ì„œë¹„ìŠ¤](#3-ì‹¤ì‹œê°„-ì„œë¹„ìŠ¤)
4. [ì£¼ìš” ê¸°ëŠ¥](#4-ì£¼ìš”-ê¸°ëŠ¥)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”

Supabase Realtimeì„ í™œìš©í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… í”¼ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- âœ… ì¶”ì²œ ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜
- âœ… ì•Œë¦¼ ì‹¤ì‹œê°„ ìˆ˜ì‹ 

## 2. DB ì„¤ì •

### [í•„ìˆ˜] Realtime í™œì„±í™”
```sql
-- íŒŒì¼: realtime/01_enable_realtime.sql

-- Realtime í™œì„±í™”
ALTER TABLE feeds REPLICA IDENTITY FULL;
ALTER TABLE recommendations REPLICA IDENTITY FULL;
ALTER TABLE comments REPLICA IDENTITY FULL;
ALTER TABLE notifications REPLICA IDENTITY FULL;

-- Publication ìƒì„±
CREATE PUBLICATION supabase_realtime FOR TABLE 
  feeds,
  recommendations,
  comments,
  notifications;
```

## 3. ì‹¤ì‹œê°„ ì„œë¹„ìŠ¤

### [í•„ìˆ˜] ê¸°ë³¸ Realtime ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/services/realtime_service.dart
import 'package:supabase_flutter/supabase_flutter.dart';
import 'dart:async';

class RealtimeService {
  final SupabaseClient _supabase = Supabase.instance.client;
  final Map<String, RealtimeChannel> _channels = {};
  
  // í”¼ë“œ ì‹¤ì‹œê°„ êµ¬ë…
  Stream<List<Map<String, dynamic>>> subscribeFeedsNearby({
    required double latitude,
    required double longitude,
    required double radiusKm,
  }) {
    final channelName = 'feeds:nearby:$latitude:$longitude';
    
    // ê¸°ì¡´ ì±„ë„ ì •ë¦¬
    _channels[channelName]?.unsubscribe();
    
    // ìƒˆ ì±„ë„ ìƒì„±
    final channel = _supabase.channel(channelName);
    
    // ìŠ¤íŠ¸ë¦¼ ì»¨íŠ¸ë¡¤ëŸ¬
    final controller = StreamController<List<Map<String, dynamic>>>.broadcast();
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    _loadNearbyFeeds(latitude, longitude, radiusKm).then((feeds) {
      controller.add(feeds);
    });
    
    // ì‹¤ì‹œê°„ êµ¬ë…
    channel
      .onPostgresChanges(
        event: PostgresChangeEvent.insert,
        schema: 'public',
        table: 'feeds',
        callback: (payload) async {
          final feeds = await _loadNearbyFeeds(latitude, longitude, radiusKm);
          controller.add(feeds);
        },
      )
      .subscribe();
    
    _channels[channelName] = channel;
    
    // ì •ë¦¬
    controller.onCancel = () {
      channel.unsubscribe();
      _channels.remove(channelName);
    };
    
    return controller.stream;
  }
  
  // ì¶”ì²œ ìˆ˜ ì‹¤ì‹œê°„ êµ¬ë…
  Stream<int> subscribeRecommendationCount(String feedId) {
    final channelName = 'recommendations:$feedId';
    final channel = _supabase.channel(channelName);
    final controller = StreamController<int>.broadcast();
    
    // ì´ˆê¸° ì¹´ìš´íŠ¸
    _getRecommendationCount(feedId).then((count) {
      controller.add(count);
    });
    
    // ë³€ê²½ ê°ì§€
    channel
      .onPostgresChanges(
        event: PostgresChangeEvent.all,
        schema: 'public',
        table: 'recommendations',
        filter: 'feed_id=eq.$feedId',
        callback: (payload) async {
          final count = await _getRecommendationCount(feedId);
          controller.add(count);
        },
      )
      .subscribe();
    
    _channels[channelName] = channel;
    
    return controller.stream;
  }
  
  // ì±„ë„ ì •ë¦¬
  void dispose() {
    for (final channel in _channels.values) {
      channel.unsubscribe();
    }
    _channels.clear();
  }
  
  // Helper ë©”ì„œë“œ
  Future<List<Map<String, dynamic>>> _loadNearbyFeeds(
    double lat, double lng, double radiusKm
  ) async {
    final response = await _supabase.rpc(
      'get_nearby_feeds',
      params: {
        'user_lat': lat,
        'user_lng': lng,
        'radius_km': radiusKm,
      },
    );
    return List<Map<String, dynamic>>.from(response);
  }
  
  Future<int> _getRecommendationCount(String feedId) async {
    final response = await _supabase
        .from('feeds')
        .select('recommendation_count')
        .eq('id', feedId)
        .single();
    return response['recommendation_count'] ?? 0;
  }
}
```

### [í•„ìˆ˜] Provider ì„¤ì •
```dart
// íŒŒì¼: lib/providers/realtime_provider.dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../services/realtime_service.dart';

// RealtimeService Provider
final realtimeServiceProvider = Provider<RealtimeService>((ref) {
  final service = RealtimeService();
  ref.onDispose(() => service.dispose());
  return service;
});

// ê·¼ì²˜ í”¼ë“œ ì‹¤ì‹œê°„ Provider
final nearbyFeedsProvider = StreamProvider.family<
  List<Map<String, dynamic>>,
  ({double lat, double lng, double radius})
>((ref, params) {
  final service = ref.watch(realtimeServiceProvider);
  return service.subscribeFeedsNearby(
    latitude: params.lat,
    longitude: params.lng,
    radiusKm: params.radius,
  );
});
```

## 4. ì£¼ìš” ê¸°ëŠ¥

### [í•„ìˆ˜] ì‹¤ì‹œê°„ ì•Œë¦¼
```dart
// íŒŒì¼: lib/features/notifications/realtime_notifications.dart
import 'package:supabase_flutter/supabase_flutter.dart';

class NotificationService {
  RealtimeChannel? _channel;
  
  void subscribeToNotifications(String userId) {
    _channel = Supabase.instance.client
        .channel('notifications:$userId')
        .onPostgresChanges(
          event: PostgresChangeEvent.insert,
          schema: 'public',
          table: 'notifications',
          filter: 'user_id=eq.$userId',
          callback: (payload) {
            _showNotification(payload.newRecord);
          },
        )
        .subscribe();
  }
  
  void _showNotification(Map<String, dynamic> notification) {
    // ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ
    print('ìƒˆ ì•Œë¦¼: ${notification['title']}');
  }
  
  void dispose() {
    _channel?.unsubscribe();
  }
}
```

### [ì„ íƒ] ëŒ“ê¸€ ì‹¤ì‹œê°„
```dart
// íŒŒì¼: lib/features/comments/realtime_comments.dart
Stream<List<Map<String, dynamic>>> subscribeComments(String feedId) {
  return Supabase.instance.client
      .from('comments')
      .stream(primaryKey: ['id'])
      .eq('feed_id', feedId)
      .order('created_at', ascending: false);
}
```

### [ì„ íƒ] êµ¬ë… ê´€ë¦¬ì
```dart
// íŒŒì¼: lib/services/subscription_manager.dart
class SubscriptionManager {
  static final _instance = SubscriptionManager._();
  factory SubscriptionManager() => _instance;
  SubscriptionManager._();
  
  final Map<String, RealtimeChannel> _activeChannels = {};
  
  RealtimeChannel subscribe({
    required String key,
    required RealtimeChannel Function() channelBuilder,
  }) {
    if (_activeChannels.containsKey(key)) {
      return _activeChannels[key]!;
    }
    
    final channel = channelBuilder();
    _activeChannels[key] = channel;
    return channel;
  }
  
  void unsubscribe(String key) {
    _activeChannels[key]?.unsubscribe();
    _activeChannels.remove(key);
  }
  
  void disposeAll() {
    for (final channel in _activeChannels.values) {
      channel.unsubscribe();
    }
    _activeChannels.clear();
  }
}
```

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] Realtime í™œì„±í™” í™•ì¸
- [ ] í”¼ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‘ë™
- [ ] ì¶”ì²œ ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜
- [ ] ì•Œë¦¼ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
- [ ] ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—†ìŒ

### ğŸ§ª ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸
```dart
// íŒŒì¼: test/realtime_test.dart
void testRealtime() async {
  final service = RealtimeService();
  
  // í”¼ë“œ êµ¬ë… í…ŒìŠ¤íŠ¸
  final subscription = service.subscribeFeedsNearby(
    latitude: 37.5,
    longitude: 127.0,
    radiusKm: 1.0,
  ).listen((feeds) {
    print('í”¼ë“œ ì—…ë°ì´íŠ¸: ${feeds.length}ê°œ');
  });
  
  // 10ì´ˆ í›„ êµ¬ë… í•´ì œ
  await Future.delayed(Duration(seconds: 10));
  subscription.cancel();
  service.dispose();
}
```