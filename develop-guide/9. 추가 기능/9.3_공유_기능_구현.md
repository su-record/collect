# ğŸ“¤ 9.3 ê³µìœ  ê¸°ëŠ¥ êµ¬í˜„

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ê³µìœ  ì½˜í…ì¸  ì„¤ì •](#2-ê³µìœ -ì½˜í…ì¸ -ì„¤ì •)
3. [êµ¬í˜„](#3-êµ¬í˜„)
4. [ê²€ì¦](#4-ê²€ì¦)

## 1. ê°œìš”
í”¼ë“œ, ë§›ì§‘, ì´ë²¤íŠ¸ ë“± ë‹¤ì–‘í•œ ì½˜í…ì¸ ë¥¼ ì™¸ë¶€ í”Œë«í¼ìœ¼ë¡œ ê³µìœ í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… í”¼ë“œ ê³µìœ  UI
- âœ… ê³µìœ  ì»¨í…ì¸  ìƒì„±
- âœ… í”Œë«í¼ë³„ ê³µìœ 
- âœ… ê³µìœ  í†µê³„ ì¶”ì 

## 2. ê³µìœ  ì½˜í…ì¸  ì„¤ì •

### [í•„ìˆ˜] íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
```yaml
# íŒŒì¼: pubspec.yaml
dependencies:
  share_plus: ^7.2.0
  path_provider: ^2.1.0
  screenshot: ^2.1.0
  image: ^4.0.0
```

### [í•„ìˆ˜] ê³µìœ  íƒ€ì… ì •ì˜
```dart
// íŒŒì¼: lib/core/constants/share_constants.dart
class ShareConstants {
  // ê³µìœ  íƒ€ì…ë³„ ì„¤ì •
  static const Map<ShareContentType, ShareConfig> shareConfigs = {
    ShareContentType.feed: ShareConfig(
      titleTemplate: 'ğŸ½ï¸ {menuName} - {storeName}',
      descriptionTemplate: '"{content}"\n\nğŸ“ {location}',
      hashtagTemplate: '#Fallingo #{menuName} #{storeName} #ë§›ì§‘ì¶”ì²œ',
      imageRequired: true,
    ),
    ShareContentType.store: ShareConfig(
      titleTemplate: 'ğŸ… ì¸ì¦ ì¶”ì²œë§›ì§‘! {storeName}',
      descriptionTemplate: 'âœ¨ {certification}\nğŸ”¥ ì¸ê¸° ë©”ë‰´: {popularMenus}\nğŸ“ {address}',
      hashtagTemplate: '#Fallingo #ì¸ì¦ë§›ì§‘ #{storeName} #ë§›ì§‘ì¶”ì²œ',
      imageRequired: false,
    ),
    ShareContentType.event: ShareConfig(
      titleTemplate: 'ğŸª {eventName}',
      descriptionTemplate: 'ğŸ“… {period}\nğŸ“ {location}\n\n{description}',
      hashtagTemplate: '#Fallingo #{eventName} #ì´ë²¤íŠ¸',
      imageRequired: false,
    ),
    ShareContentType.profile: ShareConfig(
      titleTemplate: 'â­ {nickname}ë‹˜ì˜ ë¯¸ì‹ ì§€ë„',
      descriptionTemplate: 'ğŸ† {grade} ë“±ê¸‰\nğŸ“Š ì¶”ì²œ {feedCount}ê°œ\nğŸ—ºï¸ ë°©ë¬¸ ì§€ì—­ {visitedAreas}ê³³',
      hashtagTemplate: '#Fallingo #ë¯¸ì‹ê°€ #{nickname}',
      imageRequired: false,
    ),
    ShareContentType.myMap: ShareConfig(
      titleTemplate: 'ğŸ—ºï¸ ë‚˜ì˜ ë¯¸ì‹ ì§€ë„',
      descriptionTemplate: 'ğŸ“ {visitedCount}ê³³ ë°©ë¬¸\nğŸ½ï¸ {menuCount}ê°œ ë©”ë‰´ ê²½í—˜\nğŸ† {grade} ë“±ê¸‰ ë‹¬ì„±',
      hashtagTemplate: '#Fallingo #ë‚˜ì˜ë¯¸ì‹ì§€ë„ #ë§›ì§‘ê¸°ë¡',
      imageRequired: true,
    ),
  };
  
  // ì›Œí„°ë§ˆí¬ ì„¤ì •
  static const watermarkText = 'Fallingo';
  static const watermarkOpacity = 0.3;
  static const watermarkFontSize = 14.0;
  
  // ì´ë¯¸ì§€ í’ˆì§ˆ ì„¤ì •
  static const shareImageQuality = 85;
  static const shareImageMaxWidth = 1080;
  static const shareImageMaxHeight = 1920;
  
  // í”Œë«í¼ë³„ ì œí•œ
  static const Map<SharePlatform, PlatformLimits> platformLimits = {
    SharePlatform.instagram: PlatformLimits(
      maxTextLength: 2200,
      supportedFormats: ['jpg', 'png'],
      aspectRatioMin: 0.8,
      aspectRatioMax: 1.91,
    ),
    SharePlatform.twitter: PlatformLimits(
      maxTextLength: 280,
      supportedFormats: ['jpg', 'png', 'gif'],
      maxImages: 4,
    ),
    SharePlatform.kakao: PlatformLimits(
      maxTextLength: 1000,
      supportedFormats: ['jpg', 'png'],
      maxImages: 1,
    ),
  };
}

// ê³µìœ  ì½˜í…ì¸  íƒ€ì…
enum ShareContentType {
  feed,
  store,
  event,
  profile,
  myMap,
}

// ê³µìœ  ì„¤ì •
class ShareConfig {
  final String titleTemplate;
  final String descriptionTemplate;
  final String hashtagTemplate;
  final bool imageRequired;
  
  const ShareConfig({
    required this.titleTemplate,
    required this.descriptionTemplate,
    required this.hashtagTemplate,
    required this.imageRequired,
  });
}

// í”Œë«í¼ ì œí•œ
class PlatformLimits {
  final int maxTextLength;
  final List<String> supportedFormats;
  final int? maxImages;
  final double? aspectRatioMin;
  final double? aspectRatioMax;
  
  const PlatformLimits({
    required this.maxTextLength,
    required this.supportedFormats,
    this.maxImages,
    this.aspectRatioMin,
    this.aspectRatioMax,
  });
}

enum SharePlatform {
  instagram,
  twitter,
  kakao,
  other,
}
```

## 3. êµ¬í˜„

### [í•„ìˆ˜] ê³µìœ  ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/features/share/presentation/widgets/share_service.dart
import 'dart:io';
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:screenshot/screenshot.dart';

class ShareService {
  static final ShareService _instance = ShareService._internal();
  factory ShareService() => _instance;
  ShareService._internal();
  
  final ScreenshotController _screenshotController = ScreenshotController();
  
  // ì½˜í…ì¸  ê³µìœ 
  Future<ShareResult> shareContent({
    required ShareContentType type,
    required Map<String, dynamic> data,
    String? imagePath,
    GlobalKey? widgetKey,
    SharePlatform? targetPlatform,
  }) async {
    try {
      // 1. ê³µìœ  í…ìŠ¤íŠ¸ ìƒì„±
      final shareText = _generateShareText(type, data, targetPlatform);
      
      // 2. ì´ë¯¸ì§€ ì²˜ë¦¬
      String? processedImagePath;
      if (imagePath != null || widgetKey != null) {
        processedImagePath = await _processImage(
          imagePath: imagePath,
          widgetKey: widgetKey,
          addWatermark: true,
        );
      }
      
      // 3. ë”¥ë§í¬ ìƒì„±
      final deeplink = _generateDeeplink(type, data);
      
      // 4. ìµœì¢… ê³µìœ  í…ìŠ¤íŠ¸
      final finalText = '$shareText\n\nğŸ”— $deeplink';
      
      // 5. ê³µìœ  ì‹¤í–‰
      final result = await _executeShare(
        text: finalText,
        imagePath: processedImagePath,
        targetPlatform: targetPlatform,
      );
      
      // 6. í†µê³„ ê¸°ë¡
      await _recordShareStats(type, data['id'], targetPlatform);
      
      return ShareResult(
        success: result.status == ShareResultStatus.success,
        platform: result.raw,
      );
      
    } catch (e) {
      print('Share error: $e');
      return ShareResult(
        success: false,
        error: e.toString(),
      );
    }
  }
  
  // ê³µìœ  í…ìŠ¤íŠ¸ ìƒì„±
  String _generateShareText(
    ShareContentType type,
    Map<String, dynamic> data,
    SharePlatform? platform,
  ) {
    final config = ShareConstants.shareConfigs[type]!;
    
    // í…œí”Œë¦¿ ì¹˜í™˜
    String title = config.titleTemplate;
    String description = config.descriptionTemplate;
    String hashtags = config.hashtagTemplate;
    
    data.forEach((key, value) {
      title = title.replaceAll('{$key}', value.toString());
      description = description.replaceAll('{$key}', value.toString());
      hashtags = hashtags.replaceAll('{$key}', value.toString());
    });
    
    // í”Œë«í¼ë³„ í…ìŠ¤íŠ¸ ê¸¸ì´ ì¡°ì •
    if (platform != null) {
      final limit = ShareConstants.platformLimits[platform]?.maxTextLength;
      if (limit != null) {
        final fullText = '$title\n\n$description\n\n$hashtags';
        if (fullText.length > limit) {
          // ì„¤ëª… ë¶€ë¶„ ì¶•ì•½
          final availableLength = limit - title.length - hashtags.length - 10;
          if (availableLength > 0) {
            description = '${description.substring(0, availableLength)}...';
          }
        }
      }
    }
    
    return '$title\n\n$description\n\n$hashtags';
  }
  
  // ì´ë¯¸ì§€ ì²˜ë¦¬
  Future<String?> _processImage({
    String? imagePath,
    GlobalKey? widgetKey,
    required bool addWatermark,
  }) async {
    try {
      File? imageFile;
      
      // ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
      if (imagePath != null) {
        imageFile = File(imagePath);
      } else if (widgetKey != null) {
        // ìœ„ì ¯ì„ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜
        final bytes = await _captureWidget(widgetKey);
        if (bytes != null) {
          final tempDir = await getTemporaryDirectory();
          final tempPath = '${tempDir.path}/share_${DateTime.now().millisecondsSinceEpoch}.png';
          imageFile = File(tempPath);
          await imageFile.writeAsBytes(bytes);
        }
      }
      
      if (imageFile == null || !imageFile.existsSync()) {
        return null;
      }
      
      // ì´ë¯¸ì§€ ì²˜ë¦¬ (ì••ì¶•, ì›Œí„°ë§ˆí¬)
      final processedImage = await _processImageFile(
        imageFile,
        addWatermark: addWatermark,
      );
      
      return processedImage.path;
      
    } catch (e) {
      print('Image processing error: $e');
      return null;
    }
  }
  
  // ìœ„ì ¯ ìº¡ì²˜
  Future<Uint8List?> _captureWidget(GlobalKey key) async {
    try {
      final boundary = key.currentContext?.findRenderObject() as RenderRepaintBoundary?;
      if (boundary == null) return null;
      
      final image = await boundary.toImage(pixelRatio: 3.0);
      final byteData = await image.toByteData(format: ui.ImageByteFormat.png);
      
      return byteData?.buffer.asUint8List();
    } catch (e) {
      print('Widget capture error: $e');
      return null;
    }
  }
  
  // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
  Future<File> _processImageFile(
    File imageFile,
    {required bool addWatermark}
  ) async {
    final image = img.decodeImage(imageFile.readAsBytesSync());
    if (image == null) return imageFile;
    
    // ë¦¬ì‚¬ì´ì¦ˆ
    if (image.width > ShareConstants.shareImageMaxWidth) {
      final resized = img.copyResize(
        image,
        width: ShareConstants.shareImageMaxWidth,
      );
      image.clear();
      image.setPixels(resized.getPixels());
    }
    
    // ì›Œí„°ë§ˆí¬ ì¶”ê°€
    if (addWatermark) {
      _addWatermark(image);
    }
    
    // ì €ì¥
    final tempDir = await getTemporaryDirectory();
    final processedPath = '${tempDir.path}/processed_${DateTime.now().millisecondsSinceEpoch}.jpg';
    final processedFile = File(processedPath);
    
    await processedFile.writeAsBytes(
      img.encodeJpg(image, quality: ShareConstants.shareImageQuality),
    );
    
    return processedFile;
  }
  
  // ì›Œí„°ë§ˆí¬ ì¶”ê°€
  void _addWatermark(img.Image image) {
    final watermark = ShareConstants.watermarkText;
    final x = image.width - 100;
    final y = image.height - 30;
    
    img.drawString(
      image,
      img.arial_14,
      x,
      y,
      watermark,
      color: img.getColor(255, 255, 255, 
          (255 * ShareConstants.watermarkOpacity).toInt()),
    );
  }
  
  // ë”¥ë§í¬ ìƒì„±
  String _generateDeeplink(ShareContentType type, Map<String, dynamic> data) {
    String path;
    Map<String, String> params = {};
    
    switch (type) {
      case ShareContentType.feed:
        path = 'feed';
        params['id'] = data['id'];
        break;
      case ShareContentType.store:
        path = 'store';
        params['id'] = data['id'];
        break;
      case ShareContentType.event:
        path = 'event';
        params['id'] = data['id'];
        break;
      case ShareContentType.profile:
        path = 'profile';
        params['userId'] = data['userId'];
        break;
      case ShareContentType.myMap:
        path = 'profile';
        params['tab'] = 'map';
        break;
    }
    
    return DeeplinkService.createDeeplink(
      path: path,
      params: params,
      useWebLink: true,
    );
  }
  
  // ê³µìœ  ì‹¤í–‰
  Future<ShareResult> _executeShare({
    required String text,
    String? imagePath,
    SharePlatform? targetPlatform,
  }) async {
    if (imagePath != null) {
      final file = XFile(imagePath);
      return await Share.shareXFiles(
        [file],
        text: text,
      );
    } else {
      return await Share.share(text);
    }
  }
  
  // í†µê³„ ê¸°ë¡
  Future<void> _recordShareStats(
    ShareContentType type,
    String contentId,
    SharePlatform? platform,
  ) async {
    await FirestoreService.instance
        .collection('share_stats')
        .add({
      'type': type.toString(),
      'contentId': contentId,
      'platform': platform?.toString(),
      'userId': AuthService.currentUserId,
      'timestamp': FieldValue.serverTimestamp(),
    });
  }
}

// ê³µìœ  ê²°ê³¼
class ShareResult {
  final bool success;
  final String? platform;
  final String? error;
  
  ShareResult({
    required this.success,
    this.platform,
    this.error,
  });
}
```

### [í•„ìˆ˜] ê³µìœ  UI ì»´í¬ë„ŒíŠ¸
```dart
// íŒŒì¼: lib/features/share/presentation/widgets/share_sheet.dart
import 'package:flutter/material.dart';

class ShareSheet extends StatelessWidget {
  final ShareContentType type;
  final Map<String, dynamic> data;
  final String? imagePath;
  final GlobalKey? widgetKey;
  
  const ShareSheet({
    required this.type,
    required this.data,
    this.imagePath,
    this.widgetKey,
  });
  
  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // í—¤ë”
          Text(
            'ê³µìœ í•˜ê¸°',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 20),
          
          // ë¯¸ë¦¬ë³´ê¸°
          _buildPreview(),
          
          SizedBox(height: 20),
          
          // í”Œë«í¼ ì„ íƒ
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              _buildPlatformButton(
                icon: 'assets/icons/instagram.png',
                label: 'Instagram',
                platform: SharePlatform.instagram,
              ),
              _buildPlatformButton(
                icon: 'assets/icons/twitter.png',
                label: 'Twitter',
                platform: SharePlatform.twitter,
              ),
              _buildPlatformButton(
                icon: 'assets/icons/kakao.png',
                label: 'KakaoTalk',
                platform: SharePlatform.kakao,
              ),
              _buildPlatformButton(
                icon: Icons.more_horiz,
                label: 'ë”ë³´ê¸°',
                platform: SharePlatform.other,
              ),
            ],
          ),
          
          SizedBox(height: 20),
          
          // ì˜µì…˜
          _buildOptions(),
        ],
      ),
    );
  }
  
  Widget _buildPreview() {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ì´ë¯¸ì§€
          if (imagePath != null || widgetKey != null)
            Container(
              height: 200,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(8),
                image: imagePath != null
                    ? DecorationImage(
                        image: FileImage(File(imagePath!)),
                        fit: BoxFit.cover,
                      )
                    : null,
              ),
              child: imagePath == null && widgetKey != null
                  ? Center(child: Text('ìœ„ì ¯ ë¯¸ë¦¬ë³´ê¸°'))
                  : null,
            ),
          
          SizedBox(height: 12),
          
          // í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°
          Text(
            _getPreviewText(),
            style: TextStyle(fontSize: 14),
            maxLines: 3,
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }
  
  String _getPreviewText() {
    final config = ShareConstants.shareConfigs[type]!;
    String preview = config.titleTemplate;
    
    data.forEach((key, value) {
      preview = preview.replaceAll('{$key}', value.toString());
    });
    
    return preview;
  }
  
  Widget _buildPlatformButton({
    dynamic icon,
    required String label,
    required SharePlatform platform,
  }) {
    return InkWell(
      onTap: () => _share(platform),
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: EdgeInsets.all(12),
        child: Column(
          children: [
            if (icon is String)
              Image.asset(icon, width: 48, height: 48)
            else if (icon is IconData)
              Icon(icon, size: 48, color: Colors.grey),
            SizedBox(height: 8),
            Text(
              label,
              style: TextStyle(fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildOptions() {
    return Column(
      children: [
        CheckboxListTile(
          title: Text('ì›Œí„°ë§ˆí¬ ì¶”ê°€'),
          value: true,
          onChanged: (value) {},
          controlAffinity: ListTileControlAffinity.leading,
        ),
        CheckboxListTile(
          title: Text('ìœ„ì¹˜ ì •ë³´ í¬í•¨'),
          value: true,
          onChanged: (value) {},
          controlAffinity: ListTileControlAffinity.leading,
        ),
      ],
    );
  }
  
  Future<void> _share(SharePlatform platform) async {
    final shareService = ShareService();
    
    showDialog(
      context: NavigationService.navigatorKey.currentContext!,
      barrierDismissible: false,
      builder: (context) => Center(
        child: CircularProgressIndicator(),
      ),
    );
    
    final result = await shareService.shareContent(
      type: type,
      data: data,
      imagePath: imagePath,
      widgetKey: widgetKey,
      targetPlatform: platform,
    );
    
    Navigator.pop(NavigationService.navigatorKey.currentContext!);
    Navigator.pop(NavigationService.navigatorKey.currentContext!);
    
    if (result.success) {
      _showSuccessMessage();
    } else {
      _showErrorMessage(result.error);
    }
  }
  
  void _showSuccessMessage() {
    ScaffoldMessenger.of(NavigationService.navigatorKey.currentContext!)
        .showSnackBar(
      SnackBar(
        content: Text('ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!'),
        backgroundColor: Colors.green,
      ),
    );
  }
  
  void _showErrorMessage(String? error) {
    ScaffoldMessenger.of(NavigationService.navigatorKey.currentContext!)
        .showSnackBar(
      SnackBar(
        content: Text('ê³µìœ  ì‹¤íŒ¨: ${error ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}'),
        backgroundColor: Colors.red,
      ),
    );
  }
}
```

### [í•„ìˆ˜] í”¼ë“œ ê³µìœ  ë²„íŠ¼
```dart
// íŒŒì¼: lib/features/feed/presentation/widgets/feed_share_button.dart
class FeedShareButton extends StatelessWidget {
  final FeedModel feed;
  final GlobalKey? screenshotKey;
  
  const FeedShareButton({
    required this.feed,
    this.screenshotKey,
  });
  
  @override
  Widget build(BuildContext context) {
    return IconButton(
      icon: Icon(Icons.share_outlined),
      onPressed: () => _showShareSheet(context),
    );
  }
  
  void _showShareSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ShareSheet(
        type: ShareContentType.feed,
        data: {
          'id': feed.id,
          'menuName': feed.menuName,
          'storeName': feed.storeName,
          'location': feed.storeAddress,
          'content': feed.content,
        },
        imagePath: feed.imageUrl,
        widgetKey: screenshotKey,
      ),
    );
  }
}
```

## 4. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì´ë¯¸ì§€ í¬í•¨ ê³µìœ  ì •ìƒ ì‘ë™
- [ ] í”Œë«í¼ë³„ í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ
- [ ] ì›Œí„°ë§ˆí¬ ì •ìƒ í‘œì‹œ
- [ ] ë”¥ë§í¬ í¬í•¨ í™•ì¸
- [ ] ìœ„ì ¯ ìŠ¤í¬ë¦°ìƒ· ê¸°ëŠ¥
- [ ] ê³µìœ  í†µê³„ ê¸°ë¡
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°±