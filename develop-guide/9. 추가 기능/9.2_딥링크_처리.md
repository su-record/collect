# ğŸ”— 9.2 ë”¥ë§í¬ ì²˜ë¦¬

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ë”¥ë§í¬ ì„¤ì •](#2-ë”¥ë§í¬-ì„¤ì •)
3. [êµ¬í˜„](#3-êµ¬í˜„)
4. [ê²€ì¦](#4-ê²€ì¦)

## 1. ê°œìš”
ì•±ì˜ íŠ¹ì • í™”ë©´ìœ¼ë¡œ ì§ì ‘ ì´ë™í•  ìˆ˜ ìˆëŠ” ë”¥ë§í¬(Deep Link)ì™€ ìœ ë‹ˆë²„ì„¤ ë§í¬(Universal Link) ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… URL ìŠ¤í‚´ ì„¤ì •
- âœ… ë¼ìš°íŒ… ì²˜ë¦¬
- âœ… íŒŒë¼ë¯¸í„° íŒŒì‹±
- âœ… ì•± ë¯¸ì„¤ì¹˜ ì‹œ ì²˜ë¦¬

## 2. ë”¥ë§í¬ ì„¤ì •

### [í•„ìˆ˜] íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
```yaml
# íŒŒì¼: pubspec.yaml
dependencies:
  uni_links: ^0.5.1
  url_launcher: ^6.2.1
```

### [í•„ìˆ˜] í”Œë«í¼ë³„ ì„¤ì •

#### iOS ì„¤ì •
```xml
<!-- íŒŒì¼: ios/Runner/Info.plist -->
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>fallingo</string>
        </array>
    </dict>
</array>

<!-- Universal Links ì„¤ì • -->
<key>com.apple.developer.associated-domains</key>
<array>
    <string>applinks:fallingo.com</string>
    <string>applinks:www.fallingo.com</string>
</array>
```

#### Android ì„¤ì •
```xml
<!-- íŒŒì¼: android/app/src/main/AndroidManifest.xml -->
<activity
    android:name=".MainActivity"
    android:launchMode="singleTop">
    
    <!-- Deep Links -->
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data android:scheme="fallingo" />
    </intent-filter>
    
    <!-- App Links -->
    <intent-filter android:autoVerify="true">
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data android:scheme="https" 
              android:host="fallingo.com" />
        <data android:scheme="https" 
              android:host="www.fallingo.com" />
    </intent-filter>
</activity>
```

### [í•„ìˆ˜] ë”¥ë§í¬ ìŠ¤í‚´ ì •ì˜
```dart
// íŒŒì¼: lib/core/constants/deeplink_constants.dart
class DeeplinkConstants {
  // URL ìŠ¤í‚´
  static const String scheme = 'fallingo';
  static const String webDomain = 'https://fallingo.com';
  
  // ë¼ìš°íŠ¸ ì •ì˜
  static const Map<String, DeeplinkRoute> routes = {
    // í”¼ë“œ ê´€ë ¨
    'feed': DeeplinkRoute(
      path: 'feed',
      requiredParams: ['id'],
      example: 'fallingo://feed?id=abc123',
    ),
    'feed_create': DeeplinkRoute(
      path: 'feed/create',
      requiredParams: [],
      example: 'fallingo://feed/create',
    ),
    
    // í”„ë¡œí•„ ê´€ë ¨
    'profile': DeeplinkRoute(
      path: 'profile',
      requiredParams: [],
      optionalParams: ['userId'],
      example: 'fallingo://profile?userId=user123',
    ),
    
    // ë§›ì§‘ ê´€ë ¨
    'store': DeeplinkRoute(
      path: 'store',
      requiredParams: ['id'],
      example: 'fallingo://store?id=store123',
    ),
    
    // ì´ë²¤íŠ¸ ê´€ë ¨
    'event': DeeplinkRoute(
      path: 'event',
      requiredParams: ['id'],
      example: 'fallingo://event?id=event123',
    ),
    
    // ê²€ìƒ‰ ê´€ë ¨
    'search': DeeplinkRoute(
      path: 'search',
      requiredParams: [],
      optionalParams: ['query', 'category', 'location'],
      example: 'fallingo://search?query=ê¹€ì¹˜ì°Œê°œ',
    ),
    
    // ë­í‚¹
    'ranking': DeeplinkRoute(
      path: 'ranking',
      requiredParams: [],
      optionalParams: ['category', 'period'],
      example: 'fallingo://ranking?category=korean&period=weekly',
    ),
    
    // ì§€ë„
    'map': DeeplinkRoute(
      path: 'map',
      requiredParams: [],
      optionalParams: ['lat', 'lng', 'zoom'],
      example: 'fallingo://map?lat=37.5665&lng=126.9780&zoom=15',
    ),
    
    // ì´ˆëŒ€
    'invite': DeeplinkRoute(
      path: 'invite',
      requiredParams: ['code'],
      example: 'fallingo://invite?code=FRIEND123',
    ),
  };
  
  // ì›¹ í´ë°± URL
  static String getWebFallbackUrl(String path, Map<String, String> params) {
    final queryString = params.entries
        .map((e) => '${e.key}=${Uri.encodeComponent(e.value)}')
        .join('&');
    
    return '$webDomain/$path${queryString.isNotEmpty ? '?$queryString' : ''}';
  }
}

// ë”¥ë§í¬ ë¼ìš°íŠ¸ ëª¨ë¸
class DeeplinkRoute {
  final String path;
  final List<String> requiredParams;
  final List<String> optionalParams;
  final String example;
  
  const DeeplinkRoute({
    required this.path,
    required this.requiredParams,
    this.optionalParams = const [],
    required this.example,
  });
}
```

## 3. êµ¬í˜„

### [í•„ìˆ˜] ë”¥ë§í¬ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/core/services/deeplink_service.dart
import 'dart:async';
import 'package:uni_links/uni_links.dart';
import 'package:url_launcher/url_launcher.dart';

class DeeplinkService {
  static final DeeplinkService _instance = DeeplinkService._internal();
  factory DeeplinkService() => _instance;
  DeeplinkService._internal();
  
  StreamSubscription? _linkSubscription;
  
  // ì´ˆê¸°í™”
  Future<void> initialize() async {
    // ì•± ì‹œì‘ ì‹œ ë”¥ë§í¬ í™•ì¸
    await _handleInitialLink();
    
    // ë”¥ë§í¬ ìŠ¤íŠ¸ë¦¼ ë¦¬ìŠ¤ë„ˆ
    _linkSubscription = uriLinkStream.listen(
      _handleDeeplink,
      onError: (err) => print('Deeplink error: $err'),
    );
  }
  
  // ì´ˆê¸° ë”¥ë§í¬ ì²˜ë¦¬
  Future<void> _handleInitialLink() async {
    try {
      final initialUri = await getInitialUri();
      if (initialUri != null) {
        _handleDeeplink(initialUri);
      }
    } catch (e) {
      print('Initial deeplink error: $e');
    }
  }
  
  // ë”¥ë§í¬ ì²˜ë¦¬
  void _handleDeeplink(Uri uri) {
    print('Handling deeplink: $uri');
    
    // ìŠ¤í‚´ í™•ì¸
    if (uri.scheme != DeeplinkConstants.scheme && 
        !uri.host.contains('fallingo.com')) {
      return;
    }
    
    // ê²½ë¡œ íŒŒì‹±
    final path = uri.path.isEmpty ? uri.host : uri.path;
    final params = uri.queryParameters;
    
    // ë¼ìš°íŠ¸ ì°¾ê¸°
    final route = _findRoute(path);
    if (route == null) {
      print('Unknown deeplink path: $path');
      return;
    }
    
    // í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦
    for (final param in route.requiredParams) {
      if (!params.containsKey(param)) {
        print('Missing required parameter: $param');
        return;
      }
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ì²˜ë¦¬
    _navigateToScreen(path, params);
  }
  
  // ë¼ìš°íŠ¸ ì°¾ê¸°
  DeeplinkRoute? _findRoute(String path) {
    // ê²½ë¡œ ì •ê·œí™”
    path = path.replaceAll('/', '');
    
    for (final entry in DeeplinkConstants.routes.entries) {
      if (entry.value.path.replaceAll('/', '') == path) {
        return entry.value;
      }
    }
    return null;
  }
  
  // í™”ë©´ ì´ë™
  void _navigateToScreen(String path, Map<String, String> params) {
    final context = NavigationService.navigatorKey.currentContext;
    if (context == null) return;
    
    // ë¡œê·¸ì¸ í™•ì¸
    if (!AuthService.isLoggedIn() && _requiresAuth(path)) {
      // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™ í›„ ë”¥ë§í¬ ì¬ì²˜ë¦¬
      NavigationService.navigateTo(
        '/login',
        arguments: {'redirectPath': path, 'redirectParams': params},
      );
      return;
    }
    
    // ê²½ë¡œë³„ ë„¤ë¹„ê²Œì´ì…˜
    switch (path) {
      case 'feed':
        NavigationService.navigateTo('/feed/${params['id']}');
        break;
        
      case 'feed/create':
        NavigationService.navigateTo('/feed/create');
        break;
        
      case 'profile':
        if (params.containsKey('userId')) {
          NavigationService.navigateTo('/profile/${params['userId']}');
        } else {
          NavigationService.navigateTo('/profile');
        }
        break;
        
      case 'store':
        NavigationService.navigateTo('/store/${params['id']}');
        break;
        
      case 'event':
        NavigationService.navigateTo('/event/${params['id']}');
        break;
        
      case 'search':
        NavigationService.navigateTo(
          '/search',
          arguments: {
            'query': params['query'],
            'category': params['category'],
            'location': params['location'],
          },
        );
        break;
        
      case 'ranking':
        NavigationService.navigateTo(
          '/ranking',
          arguments: {
            'category': params['category'] ?? 'all',
            'period': params['period'] ?? 'daily',
          },
        );
        break;
        
      case 'map':
        NavigationService.navigateTo(
          '/map',
          arguments: {
            'lat': double.tryParse(params['lat'] ?? ''),
            'lng': double.tryParse(params['lng'] ?? ''),
            'zoom': double.tryParse(params['zoom'] ?? '15'),
          },
        );
        break;
        
      case 'invite':
        _handleInviteCode(params['code']!);
        break;
        
      default:
        NavigationService.navigateTo('/');
    }
  }
  
  // ì¸ì¦ í•„ìš” ì—¬ë¶€
  bool _requiresAuth(String path) {
    const authRequiredPaths = [
      'feed/create',
      'profile',
    ];
    return authRequiredPaths.contains(path);
  }
  
  // ì´ˆëŒ€ ì½”ë“œ ì²˜ë¦¬
  void _handleInviteCode(String code) async {
    // ì´ˆëŒ€ ì½”ë“œ ìœ íš¨ì„± ê²€ì¦
    final isValid = await _validateInviteCode(code);
    if (!isValid) {
      _showErrorMessage('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤');
      return;
    }
    
    // ë¦¬ì›Œë“œ ì§€ê¸‰
    await _applyInviteReward(code);
    
    NavigationService.navigateTo('/');
    _showSuccessMessage('ì´ˆëŒ€ ì½”ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
  
  // ë”¥ë§í¬ ìƒì„±
  static String createDeeplink({
    required String path,
    Map<String, String>? params,
    bool useWebLink = false,
  }) {
    final queryString = params?.entries
        .map((e) => '${e.key}=${Uri.encodeComponent(e.value)}')
        .join('&') ?? '';
    
    if (useWebLink) {
      return DeeplinkConstants.getWebFallbackUrl(path, params ?? {});
    }
    
    return '${DeeplinkConstants.scheme}://$path${queryString.isNotEmpty ? '?$queryString' : ''}';
  }
  
  // ë”¥ë§í¬ ê³µìœ 
  static Future<void> shareDeeplink({
    required String path,
    Map<String, String>? params,
    String? message,
  }) async {
    final deeplink = createDeeplink(path: path, params: params);
    final weblink = createDeeplink(
      path: path, 
      params: params, 
      useWebLink: true,
    );
    
    final shareText = message != null 
        ? '$message\n\n$weblink'
        : weblink;
    
    await Share.share(shareText);
  }
  
  // ì™¸ë¶€ URL ì—´ê¸°
  static Future<bool> openExternalUrl(String url) async {
    final uri = Uri.parse(url);
    if (await canLaunchUrl(uri)) {
      return await launchUrl(
        uri,
        mode: LaunchMode.externalApplication,
      );
    }
    return false;
  }
  
  // ì´ˆëŒ€ ì½”ë“œ ê²€ì¦
  Future<bool> _validateInviteCode(String code) async {
    // Mock êµ¬í˜„
    return code.length == 9 && code.startsWith('FRIEND');
  }
  
  // ì´ˆëŒ€ ë¦¬ì›Œë“œ ì ìš©
  Future<void> _applyInviteReward(String code) async {
    // ì´ˆëŒ€í•œ ì‚¬ëŒê³¼ ì´ˆëŒ€ë°›ì€ ì‚¬ëŒ ëª¨ë‘ì—ê²Œ ë¦¬ì›Œë“œ
    final activityService = ActivityPointService();
    await activityService.awardPoints(
      userId: AuthService.currentUserId!,
      activityType: 'invite_accepted',
      metadata: {'code': code},
    );
  }
  
  // ë©”ì‹œì§€ í‘œì‹œ
  void _showErrorMessage(String message) {
    final context = NavigationService.navigatorKey.currentContext;
    if (context != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
        ),
      );
    }
  }
  
  void _showSuccessMessage(String message) {
    final context = NavigationService.navigatorKey.currentContext;
    if (context != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.green,
        ),
      );
    }
  }
  
  // ì •ë¦¬
  void dispose() {
    _linkSubscription?.cancel();
  }
}
```

### [í•„ìˆ˜] ë”¥ë§í¬ ë²„íŠ¼ ìœ„ì ¯
```dart
// íŒŒì¼: lib/widgets/deeplink_button.dart
import 'package:flutter/material.dart';

class DeeplinkButton extends StatelessWidget {
  final String title;
  final String path;
  final Map<String, String>? params;
  final IconData? icon;
  final VoidCallback? onTap;
  
  const DeeplinkButton({
    required this.title,
    required this.path,
    this.params,
    this.icon,
    this.onTap,
  });
  
  @override
  Widget build(BuildContext context) {
    return ListTile(
      leading: icon != null ? Icon(icon) : null,
      title: Text(title),
      trailing: Icon(Icons.arrow_forward_ios),
      onTap: () {
        if (onTap != null) {
          onTap!();
        } else {
          final deeplink = DeeplinkService.createDeeplink(
            path: path,
            params: params,
          );
          print('Generated deeplink: $deeplink');
          // ì‹¤ì œë¡œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ì²˜ë¦¬
        }
      },
    );
  }
}
```

### [í•„ìˆ˜] ê³µìœ  ê¸°ëŠ¥ í†µí•©
```dart
// íŒŒì¼: lib/features/share/widgets/share_button.dart
import 'package:flutter/material.dart';
import 'package:share_plus/share_plus.dart';

class ShareButton extends StatelessWidget {
  final ShareType type;
  final String id;
  final String? title;
  final String? imageUrl;
  
  const ShareButton({
    required this.type,
    required this.id,
    this.title,
    this.imageUrl,
  });
  
  @override
  Widget build(BuildContext context) {
    return IconButton(
      icon: Icon(Icons.share),
      onPressed: () => _share(context),
    );
  }
  
  Future<void> _share(BuildContext context) async {
    String path;
    Map<String, String> params;
    String message;
    
    switch (type) {
      case ShareType.feed:
        path = 'feed';
        params = {'id': id};
        message = 'ğŸ½ï¸ ${title ?? "ë§›ìˆëŠ” ì¶”ì²œ"}ì„ í™•ì¸í•´ë³´ì„¸ìš”!';
        break;
        
      case ShareType.store:
        path = 'store';
        params = {'id': id};
        message = 'ğŸ… ${title ?? "ì¸ì¦ ì¶”ì²œë§›ì§‘"}ì„ ì†Œê°œí•©ë‹ˆë‹¤!';
        break;
        
      case ShareType.event:
        path = 'event';
        params = {'id': id};
        message = 'ğŸª ${title ?? "íŠ¹ë³„í•œ ì´ë²¤íŠ¸"}ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤!';
        break;
        
      case ShareType.profile:
        path = 'profile';
        params = {'userId': id};
        message = 'â­ Fallingoì—ì„œ ${title ?? "ë¯¸ì‹ê°€"}ë‹˜ì„ íŒ”ë¡œìš°í•´ë³´ì„¸ìš”!';
        break;
        
      default:
        return;
    }
    
    await DeeplinkService.shareDeeplink(
      path: path,
      params: params,
      message: message,
    );
  }
}

enum ShareType {
  feed,
  store,
  event,
  profile,
}
```

### [ì„ íƒ] ë™ì  ë§í¬ ë¯¸ë¦¬ë³´ê¸°
```dart
// íŒŒì¼: lib/features/share/services/dynamic_link_preview.dart
class DynamicLinkPreviewService {
  // Open Graph ë©”íƒ€ë°ì´í„° ìƒì„±
  static Map<String, String> generateMetadata({
    required String type,
    required String id,
    String? title,
    String? description,
    String? imageUrl,
  }) {
    return {
      'og:title': title ?? 'Fallingo - ë§›ì— ë¹ ì ¸ë“¤ì–´',
      'og:description': description ?? 'ì§„ì§œ í˜„ì¥ê° ìˆëŠ” ë§›ì§‘ ì¶”ì²œ ì•±',
      'og:image': imageUrl ?? 'https://fallingo.com/default-share.jpg',
      'og:url': DeeplinkConstants.getWebFallbackUrl(type, {'id': id}),
      'og:type': 'website',
      'og:site_name': 'Fallingo',
    };
  }
}
```

## 4. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] iOS/Android URL ìŠ¤í‚´ ë“±ë¡ í™•ì¸
- [ ] ì•± ë¯¸ì„¤ì¹˜ ì‹œ ì•±ìŠ¤í† ì–´ë¡œ ì´ë™
- [ ] ì•± ì„¤ì¹˜ ì‹œ í•´ë‹¹ í™”ë©´ìœ¼ë¡œ ì´ë™
- [ ] í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
- [ ] ë¡œê·¸ì¸ í•„ìš” í™”ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
- [ ] ê³µìœ  ê¸°ëŠ¥ì—ì„œ ë”¥ë§í¬ ìƒì„±
- [ ] ë°±ê·¸ë¼ìš´ë“œ/ì¢…ë£Œ ìƒíƒœì—ì„œë„ ì‘ë™