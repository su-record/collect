# ğŸ‘ 5.5 ì¶”ì²œ ë° íŒ”ë¡œìš° API

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ì¶”ì²œ API](#2-ì¶”ì²œ-api)
3. [íŒ”ë¡œìš° API](#3-íŒ”ë¡œìš°-api)
4. [ì•Œë¦¼ ì²˜ë¦¬](#4-ì•Œë¦¼-ì²˜ë¦¬)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”

í”¼ë“œ ì¶”ì²œê³¼ ì‚¬ìš©ì íŒ”ë¡œìš° ê¸°ëŠ¥ì„ ìœ„í•œ APIë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ì¶”ì²œ ìˆ˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- âœ… íŒ”ë¡œìš° ê´€ê³„ ê´€ë¦¬
- âœ… ì•Œë¦¼ ìë™ ìƒì„±

## 2. ì¶”ì²œ API

### [í•„ìˆ˜] ì¶”ì²œ ë¼ìš°íŠ¸
```python
# íŒŒì¼: backend/routes/recommendation_routes.py
from flask import Blueprint, request, jsonify
from ..middleware.auth import require_auth
from ..services.recommendation_service import RecommendationService

recommendation_bp = Blueprint('recommendations', __name__)
recommendation_service = RecommendationService()

# POST /api/feeds/<feed_id>/recommend - ì¶”ì²œí•˜ê¸°
@recommendation_bp.route('/api/feeds/<feed_id>/recommend', methods=['POST'])
@require_auth
def recommend_feed(feed_id):
    """í”¼ë“œ ì¶”ì²œ"""
    try:
        recommendation = recommendation_service.create_recommendation(
            user_id=request.user_id,
            feed_id=feed_id
        )
        return jsonify(recommendation), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# DELETE /api/feeds/<feed_id>/recommend - ì¶”ì²œ ì·¨ì†Œ
@recommendation_bp.route('/api/feeds/<feed_id>/recommend', methods=['DELETE'])
@require_auth
def unrecommend_feed(feed_id):
    """í”¼ë“œ ì¶”ì²œ ì·¨ì†Œ"""
    try:
        recommendation_service.delete_recommendation(
            user_id=request.user_id,
            feed_id=feed_id
        )
        return jsonify({'message': 'ì¶”ì²œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤'}), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 404
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# GET /api/feeds/<feed_id>/recommendations - ì¶”ì²œ ëª©ë¡
@recommendation_bp.route('/api/feeds/<feed_id>/recommendations', methods=['GET'])
def get_feed_recommendations(feed_id):
    """í”¼ë“œì˜ ì¶”ì²œ ëª©ë¡"""
    try:
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 20))
        
        recommendations = recommendation_service.get_feed_recommendations(
            feed_id=feed_id,
            page=page,
            limit=limit
        )
        
        return jsonify(recommendations), 200
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# GET /api/users/<user_id>/recommendations - ì‚¬ìš©ìê°€ ì¶”ì²œí•œ í”¼ë“œ
@recommendation_bp.route('/api/users/<user_id>/recommendations', methods=['GET'])
def get_user_recommendations(user_id):
    """ì‚¬ìš©ìê°€ ì¶”ì²œí•œ í”¼ë“œ ëª©ë¡"""
    try:
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 20))
        
        recommendations = recommendation_service.get_user_recommendations(
            user_id=user_id,
            page=page,
            limit=limit
        )
        
        return jsonify(recommendations), 200
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

### [í•„ìˆ˜] RecommendationService êµ¬í˜„
```python
# íŒŒì¼: backend/services/recommendation_service.py
from supabase import create_client
from typing import Dict, List
import os

class RecommendationService:
    def __init__(self):
        self.supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_SERVICE_ROLE_KEY')
        )
    
    def create_recommendation(self, user_id: str, feed_id: str) -> Dict:
        """ì¶”ì²œ ìƒì„±"""
        # ì¤‘ë³µ ì¶”ì²œ ì²´í¬
        existing = self._check_existing_recommendation(user_id, feed_id)
        if existing:
            raise ValueError('ì´ë¯¸ ì¶”ì²œí•œ í”¼ë“œì…ë‹ˆë‹¤')
        
        # í”¼ë“œ ì •ë³´ í™•ì¸
        feed = self._get_feed_info(feed_id)
        
        # ìê¸° í”¼ë“œ ì¶”ì²œ ë°©ì§€
        if feed['user_id'] == user_id:
            raise ValueError('ìì‹ ì˜ í”¼ë“œëŠ” ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
        
        # ì¶”ì²œ ìƒì„±
        recommendation_data = {
            'user_id': user_id,
            'feed_id': feed_id
        }
        
        response = self.supabase.table('recommendations') \
            .insert(recommendation_data) \
            .execute()
        
        # ì•Œë¦¼ ìƒì„±
        self._create_recommendation_notification(
            from_user_id=user_id,
            to_user_id=feed['user_id'],
            feed_id=feed_id
        )
        
        # í™œë™ í¬ì¸íŠ¸ ë¶€ì—¬
        self._award_points(user_id, 'recommend')
        self._award_points(feed['user_id'], 'receive_recommend')
        
        return response.data[0]
    
    def delete_recommendation(self, user_id: str, feed_id: str):
        """ì¶”ì²œ ì·¨ì†Œ"""
        response = self.supabase.table('recommendations') \
            .delete() \
            .eq('user_id', user_id) \
            .eq('feed_id', feed_id) \
            .execute()
        
        if not response.data:
            raise ValueError('ì¶”ì²œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
    
    def get_feed_recommendations(
        self, 
        feed_id: str, 
        page: int = 1, 
        limit: int = 20
    ) -> Dict:
        """í”¼ë“œì˜ ì¶”ì²œ ëª©ë¡"""
        offset = (page - 1) * limit
        
        # ì¶”ì²œí•œ ì‚¬ìš©ì ëª©ë¡
        response = self.supabase.table('recommendations') \
            .select('*, users(id, nickname, profile_image_url, grade)') \
            .eq('feed_id', feed_id) \
            .order('created_at', desc=True) \
            .range(offset, offset + limit - 1) \
            .execute()
        
        # ì „ì²´ ì¹´ìš´íŠ¸
        count_response = self.supabase.table('recommendations') \
            .select('id', count='exact') \
            .eq('feed_id', feed_id) \
            .execute()
        
        return {
            'recommendations': response.data,
            'total': count_response.count or 0,
            'page': page,
            'limit': limit
        }
    
    def get_user_recommendations(
        self, 
        user_id: str, 
        page: int = 1, 
        limit: int = 20
    ) -> Dict:
        """ì‚¬ìš©ìê°€ ì¶”ì²œí•œ í”¼ë“œ ëª©ë¡"""
        offset = (page - 1) * limit
        
        response = self.supabase.table('recommendations') \
            .select('*, feeds(*, users(*), menus(*), stores(*))') \
            .eq('user_id', user_id) \
            .order('created_at', desc=True) \
            .range(offset, offset + limit - 1) \
            .execute()
        
        return {
            'recommendations': response.data,
            'page': page,
            'limit': limit
        }
    
    def _check_existing_recommendation(
        self, 
        user_id: str, 
        feed_id: str
    ) -> bool:
        """ì¤‘ë³µ ì¶”ì²œ ì²´í¬"""
        response = self.supabase.table('recommendations') \
            .select('id') \
            .eq('user_id', user_id) \
            .eq('feed_id', feed_id) \
            .maybe_single() \
            .execute()
        
        return response.data is not None
    
    def _get_feed_info(self, feed_id: str) -> Dict:
        """í”¼ë“œ ì •ë³´ ì¡°íšŒ"""
        response = self.supabase.table('feeds') \
            .select('id, user_id') \
            .eq('id', feed_id) \
            .single() \
            .execute()
        
        if not response.data:
            raise ValueError('í”¼ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
        
        return response.data
    
    def _create_recommendation_notification(
        self, 
        from_user_id: str, 
        to_user_id: str, 
        feed_id: str
    ):
        """ì¶”ì²œ ì•Œë¦¼ ìƒì„±"""
        # ì¶”ì²œí•œ ì‚¬ìš©ì ì •ë³´
        user_response = self.supabase.table('users') \
            .select('nickname') \
            .eq('id', from_user_id) \
            .single() \
            .execute()
        
        nickname = user_response.data['nickname']
        
        # ì•Œë¦¼ ìƒì„±
        self.supabase.table('notifications').insert({
            'user_id': to_user_id,
            'type': 'recommendation',
            'title': 'ìƒˆë¡œìš´ ì¶”ì²œ',
            'body': f'{nickname}ë‹˜ì´ íšŒì›ë‹˜ì˜ í”¼ë“œë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤',
            'data': {
                'feed_id': feed_id,
                'from_user_id': from_user_id
            }
        }).execute()
    
    def _award_points(self, user_id: str, action: str):
        """í™œë™ í¬ì¸íŠ¸ ë¶€ì—¬"""
        points = {
            'recommend': 2,
            'receive_recommend': 5
        }
        
        from .user_service import UserService
        user_service = UserService()
        user_service.update_activity_points(
            user_id, 
            points.get(action, 0)
        )
```

## 3. íŒ”ë¡œìš° API

### [í•„ìˆ˜] íŒ”ë¡œìš° ì„œë¹„ìŠ¤
```python
# íŒŒì¼: backend/services/follow_service.py
from supabase import create_client
from typing import Dict, List
import os

class FollowService:
    def __init__(self):
        self.supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_SERVICE_ROLE_KEY')
        )
    
    def follow_user(self, follower_id: str, following_id: str) -> Dict:
        """ì‚¬ìš©ì íŒ”ë¡œìš°"""
        # ìê¸° ìì‹  íŒ”ë¡œìš° ë°©ì§€
        if follower_id == following_id:
            raise ValueError('ìê¸° ìì‹ ì€ íŒ”ë¡œìš°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
        
        # ì¤‘ë³µ íŒ”ë¡œìš° ì²´í¬
        existing = self._check_existing_follow(follower_id, following_id)
        if existing:
            raise ValueError('ì´ë¯¸ íŒ”ë¡œìš°í•œ ì‚¬ìš©ìì…ë‹ˆë‹¤')
        
        # íŒ”ë¡œìš° ìƒì„±
        follow_data = {
            'follower_id': follower_id,
            'following_id': following_id
        }
        
        response = self.supabase.table('follows') \
            .insert(follow_data) \
            .execute()
        
        # ì•Œë¦¼ ìƒì„±
        self._create_follow_notification(follower_id, following_id)
        
        return response.data[0]
    
    def unfollow_user(self, follower_id: str, following_id: str):
        """íŒ”ë¡œìš° ì·¨ì†Œ"""
        response = self.supabase.table('follows') \
            .delete() \
            .eq('follower_id', follower_id) \
            .eq('following_id', following_id) \
            .execute()
        
        if not response.data:
            raise ValueError('íŒ”ë¡œìš° ê´€ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
    
    def get_followers(
        self, 
        user_id: str, 
        page: int = 1, 
        limit: int = 20
    ) -> Dict:
        """íŒ”ë¡œì›Œ ëª©ë¡"""
        offset = (page - 1) * limit
        
        response = self.supabase.table('follows') \
            .select('*, follower:users!follower_id(*)') \
            .eq('following_id', user_id) \
            .order('created_at', desc=True) \
            .range(offset, offset + limit - 1) \
            .execute()
        
        count_response = self.supabase.table('follows') \
            .select('id', count='exact') \
            .eq('following_id', user_id) \
            .execute()
        
        return {
            'followers': [item['follower'] for item in response.data],
            'total': count_response.count or 0,
            'page': page,
            'limit': limit
        }
    
    def get_following(
        self, 
        user_id: str, 
        page: int = 1, 
        limit: int = 20
    ) -> Dict:
        """íŒ”ë¡œì‰ ëª©ë¡"""
        offset = (page - 1) * limit
        
        response = self.supabase.table('follows') \
            .select('*, following:users!following_id(*)') \
            .eq('follower_id', user_id) \
            .order('created_at', desc=True) \
            .range(offset, offset + limit - 1) \
            .execute()
        
        count_response = self.supabase.table('follows') \
            .select('id', count='exact') \
            .eq('follower_id', user_id) \
            .execute()
        
        return {
            'following': [item['following'] for item in response.data],
            'total': count_response.count or 0,
            'page': page,
            'limit': limit
        }
    
    def check_follow_status(
        self, 
        user_id: str, 
        target_user_id: str
    ) -> Dict:
        """íŒ”ë¡œìš° ìƒíƒœ í™•ì¸"""
        # Aê°€ Bë¥¼ íŒ”ë¡œìš°í•˜ëŠ”ì§€
        following = self._check_existing_follow(user_id, target_user_id)
        
        # Bê°€ Aë¥¼ íŒ”ë¡œìš°í•˜ëŠ”ì§€
        followed_by = self._check_existing_follow(target_user_id, user_id)
        
        return {
            'is_following': following,
            'is_followed_by': followed_by
        }
    
    def _check_existing_follow(
        self, 
        follower_id: str, 
        following_id: str
    ) -> bool:
        """íŒ”ë¡œìš° ê´€ê³„ í™•ì¸"""
        response = self.supabase.table('follows') \
            .select('id') \
            .eq('follower_id', follower_id) \
            .eq('following_id', following_id) \
            .maybe_single() \
            .execute()
        
        return response.data is not None
    
    def _create_follow_notification(
        self, 
        follower_id: str, 
        following_id: str
    ):
        """íŒ”ë¡œìš° ì•Œë¦¼ ìƒì„±"""
        # íŒ”ë¡œìš°í•œ ì‚¬ìš©ì ì •ë³´
        user_response = self.supabase.table('users') \
            .select('nickname') \
            .eq('id', follower_id) \
            .single() \
            .execute()
        
        nickname = user_response.data['nickname']
        
        # ì•Œë¦¼ ìƒì„±
        self.supabase.table('notifications').insert({
            'user_id': following_id,
            'type': 'follow',
            'title': 'ìƒˆë¡œìš´ íŒ”ë¡œì›Œ',
            'body': f'{nickname}ë‹˜ì´ íšŒì›ë‹˜ì„ íŒ”ë¡œìš°í–ˆìŠµë‹ˆë‹¤',
            'data': {
                'follower_id': follower_id
            }
        }).execute()
```

### [í•„ìˆ˜] íŒ”ë¡œìš° ë¼ìš°íŠ¸ í†µí•©
```python
# íŒŒì¼: backend/services/user_service.py (ì¶”ê°€)

def follow_user(self, follower_id: str, following_id: str) -> Dict:
    """ì‚¬ìš©ì íŒ”ë¡œìš°"""
    from .follow_service import FollowService
    follow_service = FollowService()
    return follow_service.follow_user(follower_id, following_id)

def unfollow_user(self, follower_id: str, following_id: str):
    """íŒ”ë¡œìš° ì·¨ì†Œ"""
    from .follow_service import FollowService
    follow_service = FollowService()
    follow_service.unfollow_user(follower_id, following_id)

def get_followers(self, user_id: str, page: int, limit: int) -> Dict:
    """íŒ”ë¡œì›Œ ëª©ë¡"""
    from .follow_service import FollowService
    follow_service = FollowService()
    return follow_service.get_followers(user_id, page, limit)

def get_following(self, user_id: str, page: int, limit: int) -> Dict:
    """íŒ”ë¡œì‰ ëª©ë¡"""
    from .follow_service import FollowService
    follow_service = FollowService()
    return follow_service.get_following(user_id, page, limit)
```

## 4. ì•Œë¦¼ ì²˜ë¦¬

### [ì„ íƒ] ì•Œë¦¼ ì„œë¹„ìŠ¤
```python
# íŒŒì¼: backend/services/notification_service.py
class NotificationService:
    def __init__(self):
        self.supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_SERVICE_ROLE_KEY')
        )
    
    def get_user_notifications(
        self, 
        user_id: str, 
        page: int = 1, 
        limit: int = 20,
        unread_only: bool = False
    ) -> Dict:
        """ì‚¬ìš©ì ì•Œë¦¼ ëª©ë¡"""
        offset = (page - 1) * limit
        
        query = self.supabase.table('notifications') \
            .select('*') \
            .eq('user_id', user_id)
        
        if unread_only:
            query = query.eq('is_read', False)
        
        response = query \
            .order('created_at', desc=True) \
            .range(offset, offset + limit - 1) \
            .execute()
        
        return {
            'notifications': response.data,
            'page': page,
            'limit': limit
        }
    
    def mark_as_read(self, user_id: str, notification_ids: List[str]):
        """ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬"""
        self.supabase.table('notifications') \
            .update({'is_read': True}) \
            .eq('user_id', user_id) \
            .in_('id', notification_ids) \
            .execute()
    
    def get_unread_count(self, user_id: str) -> int:
        """ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜"""
        response = self.supabase.table('notifications') \
            .select('id', count='exact') \
            .eq('user_id', user_id) \
            .eq('is_read', False) \
            .execute()
        
        return response.count or 0
```

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì¶”ì²œ ìƒì„±/ì·¨ì†Œ ë™ì‘
- [ ] ì¤‘ë³µ ì¶”ì²œ ë°©ì§€
- [ ] íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° ë™ì‘
- [ ] ì•Œë¦¼ ìë™ ìƒì„±
- [ ] í¬ì¸íŠ¸ ë¶€ì—¬ í™•ì¸

### ğŸ§ª API í…ŒìŠ¤íŠ¸
```python
# íŒŒì¼: tests/test_recommendation_api.py
def test_recommend_feed(client, auth_token, feed_id):
    """í”¼ë“œ ì¶”ì²œ í…ŒìŠ¤íŠ¸"""
    response = client.post(
        f'/api/feeds/{feed_id}/recommend',
        headers={'Authorization': f'Bearer {auth_token}'}
    )
    
    assert response.status_code == 201
    data = response.get_json()
    assert data['feed_id'] == feed_id

def test_duplicate_recommendation(client, auth_token, feed_id):
    """ì¤‘ë³µ ì¶”ì²œ ë°©ì§€ í…ŒìŠ¤íŠ¸"""
    # ì²« ë²ˆì§¸ ì¶”ì²œ
    client.post(
        f'/api/feeds/{feed_id}/recommend',
        headers={'Authorization': f'Bearer {auth_token}'}
    )
    
    # ë‘ ë²ˆì§¸ ì¶”ì²œ ì‹œë„
    response = client.post(
        f'/api/feeds/{feed_id}/recommend',
        headers={'Authorization': f'Bearer {auth_token}'}
    )
    
    assert response.status_code == 400
    assert 'ì´ë¯¸ ì¶”ì²œí•œ' in response.get_json()['error']

def test_follow_user(client, auth_token, target_user_id):
    """ì‚¬ìš©ì íŒ”ë¡œìš° í…ŒìŠ¤íŠ¸"""
    response = client.post(
        f'/api/users/{target_user_id}/follow',
        headers={'Authorization': f'Bearer {auth_token}'}
    )
    
    assert response.status_code == 200
    assert 'íŒ”ë¡œìš°í–ˆìŠµë‹ˆë‹¤' in response.get_json()['message']
```