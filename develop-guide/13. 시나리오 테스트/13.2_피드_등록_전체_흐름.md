# 📸 13.2 피드 등록 전체 흐름

## 📋 목차
1. [개요](#1-개요)
2. [카메라에서 등록 완료까지](#2-카메라에서-등록-완료까지)
3. [각 단계 검증](#3-각-단계-검증)
4. [에러 케이스](#4-에러-케이스)
5. [성공 기준](#5-성공-기준)
6. [음식 사진 검증](#6-음식-사진-검증)
7. [멀티 사진 등록](#7-멀티-사진-등록)
8. [나중에 영수증 추가](#8-나중에-영수증-추가)
9. [검증](#9-검증)

## 1. 개요
사용자가 피드를 등록하는 전체 프로세스를 단계별로 구현하고 검증합니다.

### 📌 핵심 포인트
- ✅ 5단계 등록 프로세스
- ✅ 각 단계별 유효성 검증
- ✅ 사용자 친화적 에러 처리
- ✅ 성공적인 등록 완료
- ✅ 멀티 사진 지원 (최대 5장)
- ✅ 24시간 내 영수증 추가 가능

## 2. 카메라에서 등록 완료까지

### [필수] 피드 등록 플로우 관리자
```dart
// 파일: lib/features/feed_creation/managers/feed_creation_manager.dart
import 'package:flutter/material.dart';
import 'dart:io';

class FeedCreationManager extends ChangeNotifier {
  // 현재 단계
  FeedCreationStep _currentStep = FeedCreationStep.camera;
  
  // 각 단계별 데이터
  List<File> _capturedImages = [];
  String? _recognizedFood;
  Map<String, dynamic>? _ocrData;
  Location? _verifiedLocation;
  FeedData? _feedData;
  
  // Getters
  FeedCreationStep get currentStep => _currentStep;
  List<File> get capturedImages => _capturedImages;
  String? get recognizedFood => _recognizedFood;
  Map<String, dynamic>? get ocrData => _ocrData;
  Location? get verifiedLocation => _verifiedLocation;
  FeedData? get feedData => _feedData;
  
  // 진행률 계산
  double get progress {
    switch (_currentStep) {
      case FeedCreationStep.camera:
        return 0.2;
      case FeedCreationStep.imageProcessing:
        return 0.4;
      case FeedCreationStep.locationVerification:
        return 0.6;
      case FeedCreationStep.infoInput:
        return 0.8;
      case FeedCreationStep.completion:
        return 1.0;
    }
  }
  
  // 단계 진행
  void proceedToNextStep() {
    switch (_currentStep) {
      case FeedCreationStep.camera:
        _currentStep = FeedCreationStep.imageProcessing;
        break;
      case FeedCreationStep.imageProcessing:
        _currentStep = FeedCreationStep.locationVerification;
        break;
      case FeedCreationStep.locationVerification:
        _currentStep = FeedCreationStep.infoInput;
        break;
      case FeedCreationStep.infoInput:
        _currentStep = FeedCreationStep.completion;
        break;
      case FeedCreationStep.completion:
        // 완료
        break;
    }
    notifyListeners();
  }
  
  // 이전 단계로
  void goToPreviousStep() {
    switch (_currentStep) {
      case FeedCreationStep.camera:
        // 첫 단계
        break;
      case FeedCreationStep.imageProcessing:
        _currentStep = FeedCreationStep.camera;
        break;
      case FeedCreationStep.locationVerification:
        _currentStep = FeedCreationStep.imageProcessing;
        break;
      case FeedCreationStep.infoInput:
        _currentStep = FeedCreationStep.locationVerification;
        break;
      case FeedCreationStep.completion:
        _currentStep = FeedCreationStep.infoInput;
        break;
    }
    notifyListeners();
  }
  
  // 데이터 저장
  void addCapturedImage(File image) {
    if (_capturedImages.length < 5) {
      _capturedImages.add(image);
      notifyListeners();
    }
  }
  
  void removeCapturedImage(int index) {
    if (index >= 0 && index < _capturedImages.length) {
      _capturedImages.removeAt(index);
      notifyListeners();
    }
  }
  
  void reorderImages(int oldIndex, int newIndex) {
    if (oldIndex < newIndex) {
      newIndex -= 1;
    }
    final image = _capturedImages.removeAt(oldIndex);
    _capturedImages.insert(newIndex, image);
    notifyListeners();
  }
  
  void setRecognizedFood(String food) {
    _recognizedFood = food;
    notifyListeners();
  }
  
  void setOcrData(Map<String, dynamic> data) {
    _ocrData = data;
    notifyListeners();
  }
  
  void setVerifiedLocation(Location location) {
    _verifiedLocation = location;
    notifyListeners();
  }
  
  void setFeedData(FeedData data) {
    _feedData = data;
    notifyListeners();
  }
  
  // 초기화
  void reset() {
    _currentStep = FeedCreationStep.camera;
    _capturedImages.clear();
    _recognizedFood = null;
    _ocrData = null;
    _verifiedLocation = null;
    _feedData = null;
    notifyListeners();
  }
}

enum FeedCreationStep {
  camera,
  imageProcessing,
  locationVerification,
  infoInput,
  completion,
}
```

### [필수] 메인 플로우 위젯
```dart
// 파일: lib/features/feed_creation/screens/feed_creation_flow.dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

class FeedCreationFlow extends StatefulWidget {
  final bool isFirstFeed;
  final bool showMultiPhotoTip;
  
  const FeedCreationFlow({
    Key? key,
    this.isFirstFeed = false,
    this.showMultiPhotoTip = false,
  }) : super(key: key);

  @override
  _FeedCreationFlowState createState() => _FeedCreationFlowState();
}

class _FeedCreationFlowState extends State<FeedCreationFlow> {
  late FeedCreationManager _manager;
  
  @override
  void initState() {
    super.initState();
    _manager = FeedCreationManager();
  }
  
  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider.value(
      value: _manager,
      child: Consumer<FeedCreationManager>(
        builder: (context, manager, child) {
          return Container(
            height: MediaQuery.of(context).size.height * 0.95,
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.vertical(
                top: Radius.circular(20),
              ),
            ),
            child: Column(
              children: [
                // 핸들 바
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey[300],
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
                
                // 헤더
                _buildHeader(manager),
                
                // 진행률 표시
                _buildProgressIndicator(manager),
                
                // 콘텐츠
                Expanded(
                  child: _buildContent(manager),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
  
  Widget _buildHeader(FeedCreationManager manager) {
    return Container(
      padding: const EdgeInsets.all(16),
      child: Row(
        children: [
          // 뒤로가기
          if (manager.currentStep != FeedCreationStep.camera)
            IconButton(
              onPressed: () => manager.goToPreviousStep(),
              icon: const Icon(Icons.arrow_back),
            )
          else
            const SizedBox(width: 48),
          
          // 제목
          Expanded(
            child: Text(
              _getStepTitle(manager.currentStep),
              textAlign: TextAlign.center,
              style: const TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          
          // 닫기
          IconButton(
            onPressed: () => _showExitConfirmation(),
            icon: const Icon(Icons.close),
          ),
        ],
      ),
    );
  }
  
  Widget _buildProgressIndicator(FeedCreationManager manager) {
    return Container(
      height: 4,
      margin: const EdgeInsets.symmetric(horizontal: 16),
      child: LinearProgressIndicator(
        value: manager.progress,
        backgroundColor: Colors.grey[200],
        valueColor: AlwaysStoppedAnimation<Color>(
          Theme.of(context).primaryColor,
        ),
      ),
    );
  }
  
  Widget _buildContent(FeedCreationManager manager) {
    switch (manager.currentStep) {
      case FeedCreationStep.camera:
        return MultiPhotoCameraStep(
          onImagesSelected: (images) {
            for (var image in images) {
              manager.addCapturedImage(image);
            }
            manager.proceedToNextStep();
          },
          showTip: widget.showMultiPhotoTip,
        );
        
      case FeedCreationStep.imageProcessing:
        return ImageProcessingStep(
          images: manager.capturedImages,
          onProcessed: (recognizedFood) {
            manager.setRecognizedFood(recognizedFood);
            manager.proceedToNextStep();
          },
        );
        
      case FeedCreationStep.locationVerification:
        return LocationVerificationStep(
          initialFood: manager.recognizedFood,
          onVerified: (location, ocrData) {
            manager.setVerifiedLocation(location);
            if (ocrData != null) {
              manager.setOcrData(ocrData);
            }
            manager.proceedToNextStep();
          },
        );
        
      case FeedCreationStep.infoInput:
        return InfoInputStep(
          images: manager.capturedImages,
          recognizedFood: manager.recognizedFood!,
          location: manager.verifiedLocation!,
          onCompleted: (feedData) {
            manager.setFeedData(feedData);
            manager.proceedToNextStep();
          },
        );
        
      case FeedCreationStep.completion:
        return CompletionStep(
          feedData: manager.feedData!,
          isFirstFeed: widget.isFirstFeed,
          onClose: () {
            Navigator.of(context).pop();
            // 메인 피드로 이동
          },
        );
    }
  }
  
  String _getStepTitle(FeedCreationStep step) {
    switch (step) {
      case FeedCreationStep.camera:
        return '사진 촬영';
      case FeedCreationStep.imageProcessing:
        return '음식 인식';
      case FeedCreationStep.locationVerification:
        return '위치 확인';
      case FeedCreationStep.infoInput:
        return '정보 입력';
      case FeedCreationStep.completion:
        return '등록 완료';
    }
  }
  
  void _showExitConfirmation() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('등록을 취소하시겠습니까?'),
        content: const Text('작성 중인 내용이 모두 사라집니다.'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('계속 작성'),
          ),
          TextButton(
            onPressed: () {
              Navigator.of(context).pop(); // 다이얼로그 닫기
              Navigator.of(context).pop(); // 플로우 닫기
            },
            child: const Text(
              '취소',
              style: TextStyle(color: Colors.red),
            ),
          ),
        ],
      ),
    );
  }
}
```

## 6. 음식 사진 검증

### [필수] 음식 인식 검증 로직
```dart
// 파일: lib/features/feed_creation/validators/food_image_validator.dart
import 'package:flutter/material.dart';
import 'dart:io';

class FoodImageValidator {
  static const double minFoodConfidence = 0.7;
  static const List<String> foodLabels = [
    'food', 'dish', 'meal', 'cuisine', 'dessert', 'beverage',
    '음식', '요리', '디저트', '음료', // 한국어 라벨
  ];
  
  /// 음식 이미지 검증
  static Future<FoodValidationResult> validateFoodImage(File image) async {
    try {
      // Cloud Vision API 호출 (Mock)
      final labels = await _analyzeImage(image);
      
      // 음식 관련 라벨 확인
      final foodLabel = labels.firstWhere(
        (label) => foodLabels.any((food) => 
          label.description.toLowerCase().contains(food.toLowerCase())
        ),
        orElse: () => ImageLabel(description: '', confidence: 0),
      );
      
      if (foodLabel.confidence >= minFoodConfidence) {
        // 음식 종류 추정
        final foodType = _estimateFoodType(labels);
        
        return FoodValidationResult(
          isValid: true,
          confidence: foodLabel.confidence,
          foodType: foodType,
          message: '음식이 인식되었습니다',
        );
      } else {
        return FoodValidationResult(
          isValid: false,
          confidence: foodLabel.confidence,
          message: '음식이 감지되지 않았습니다',
        );
      }
    } catch (e) {
      return FoodValidationResult(
        isValid: false,
        confidence: 0,
        message: '이미지 분석 중 오류가 발생했습니다',
      );
    }
  }
  
  /// 멀티 이미지 검증 (첫 번째만 음식 필수)
  static Future<MultiImageValidationResult> validateMultipleImages(
    List<File> images,
  ) async {
    if (images.isEmpty) {
      return MultiImageValidationResult(
        isValid: false,
        results: [],
        message: '최소 1장의 사진이 필요합니다',
      );
    }
    
    final results = <FoodValidationResult>[];
    
    // 첫 번째 이미지는 반드시 음식이어야 함
    final firstResult = await validateFoodImage(images.first);
    results.add(firstResult);
    
    if (!firstResult.isValid) {
      return MultiImageValidationResult(
        isValid: false,
        results: results,
        message: '첫 번째 사진은 반드시 음식 사진이어야 합니다',
      );
    }
    
    // 나머지 이미지는 자유
    for (int i = 1; i < images.length; i++) {
      // 간단한 유효성 검사만 수행
      final isValid = await _validateGeneralImage(images[i]);
      results.add(FoodValidationResult(
        isValid: isValid,
        confidence: 1.0,
        message: isValid ? '이미지가 확인되었습니다' : '이미지를 확인할 수 없습니다',
      ));
    }
    
    return MultiImageValidationResult(
      isValid: true,
      results: results,
      message: '모든 이미지가 확인되었습니다',
      recognizedFood: firstResult.foodType,
    );
  }
  
  /// Mock 이미지 분석
  static Future<List<ImageLabel>> _analyzeImage(File image) async {
    // 실제로는 Cloud Vision API 호출
    await Future.delayed(const Duration(seconds: 1));
    
    return [
      ImageLabel(description: 'food', confidence: 0.95),
      ImageLabel(description: '김치찌개', confidence: 0.92),
      ImageLabel(description: '한식', confidence: 0.88),
      ImageLabel(description: 'stew', confidence: 0.85),
    ];
  }
  
  /// 음식 종류 추정
  static String? _estimateFoodType(List<ImageLabel> labels) {
    // 가장 구체적인 음식 라벨 찾기
    final foodLabels = labels.where((label) => 
      label.confidence > 0.8 && 
      !['food', 'dish', 'meal', '음식', '요리'].contains(label.description.toLowerCase())
    ).toList();
    
    if (foodLabels.isNotEmpty) {
      return foodLabels.first.description;
    }
    
    return null;
  }
  
  /// 일반 이미지 검증
  static Future<bool> _validateGeneralImage(File image) async {
    try {
      // 파일 존재 확인
      if (!await image.exists()) return false;
      
      // 파일 크기 확인 (10MB 이하)
      final fileSize = await image.length();
      if (fileSize > 10 * 1024 * 1024) return false;
      
      // 이미지 형식 확인
      final extension = image.path.split('.').last.toLowerCase();
      final validFormats = ['jpg', 'jpeg', 'png', 'webp'];
      if (!validFormats.contains(extension)) return false;
      
      return true;
    } catch (e) {
      return false;
    }
  }
}

class FoodValidationResult {
  final bool isValid;
  final double confidence;
  final String? foodType;
  final String message;
  
  FoodValidationResult({
    required this.isValid,
    required this.confidence,
    this.foodType,
    required this.message,
  });
}

class MultiImageValidationResult {
  final bool isValid;
  final List<FoodValidationResult> results;
  final String message;
  final String? recognizedFood;
  
  MultiImageValidationResult({
    required this.isValid,
    required this.results,
    required this.message,
    this.recognizedFood,
  });
}

class ImageLabel {
  final String description;
  final double confidence;
  
  ImageLabel({
    required this.description,
    required this.confidence,
  });
}
```

### [필수] 실시간 음식 감지 UI
```dart
// 파일: lib/features/feed_creation/widgets/food_detection_overlay.dart
class FoodDetectionOverlay extends StatelessWidget {
  final bool isFoodDetected;
  final String? detectedFood;
  final int? existingCount;
  final double? confidence;
  
  const FoodDetectionOverlay({
    Key? key,
    required this.isFoodDetected,
    this.detectedFood,
    this.existingCount,
    this.confidence,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return AnimatedSwitcher(
      duration: const Duration(milliseconds: 300),
      child: isFoodDetected
          ? Container(
              key: const ValueKey('detected'),
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.green.withOpacity(0.9),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Row(
                    children: [
                      const Icon(
                        Icons.check_circle,
                        color: Colors.white,
                        size: 20,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        detectedFood ?? '음식 인식됨',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                  if (existingCount != null) ...[
                    const SizedBox(height: 4),
                    Text(
                      '👍 $existingCount개 추천',
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 14,
                      ),
                    ),
                  ],
                  if (confidence != null) ...[
                    const SizedBox(height: 4),
                    LinearProgressIndicator(
                      value: confidence!,
                      backgroundColor: Colors.white24,
                      valueColor: const AlwaysStoppedAnimation<Color>(
                        Colors.white,
                      ),
                    ),
                  ],
                ],
              ),
            )
          : Container(
              key: const ValueKey('not_detected'),
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.orange.withOpacity(0.9),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  const Icon(
                    Icons.camera_alt,
                    color: Colors.white,
                    size: 20,
                  ),
                  const SizedBox(width: 8),
                  const Expanded(
                    child: Text(
                      '음식을 카메라에 담아주세요',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                      ),
                    ),
                  ),
                ],
              ),
            ),
    );
  }
}
```

## 7. 멀티 사진 등록

### [필수] 멀티 사진 카메라 스텝
```dart
// 파일: lib/features/feed_creation/steps/multi_photo_camera_step.dart
import 'package:camera/camera.dart';
import 'package:flutter/material.dart';
import 'dart:io';

class MultiPhotoCameraStep extends StatefulWidget {
  final Function(List<File>) onImagesSelected;
  final bool showTip;
  
  const MultiPhotoCameraStep({
    Key? key,
    required this.onImagesSelected,
    this.showTip = false,
  }) : super(key: key);
  
  @override
  _MultiPhotoCameraStepState createState() => _MultiPhotoCameraStepState();
}

class _MultiPhotoCameraStepState extends State<MultiPhotoCameraStep> {
  CameraController? _controller;
  bool _isInitialized = false;
  bool _isProcessing = false;
  List<File> _capturedImages = [];
  bool _isFoodDetected = false;
  String? _detectedFood;
  bool _showMultiPhotoTip = false;
  
  @override
  void initState() {
    super.initState();
    _showMultiPhotoTip = widget.showTip;
    _initializeCamera();
  }
  
  Future<void> _initializeCamera() async {
    try {
      final cameras = await availableCameras();
      if (cameras.isEmpty) {
        _showError('카메라를 찾을 수 없습니다');
        return;
      }
      
      _controller = CameraController(
        cameras.first,
        ResolutionPreset.high,
        enableAudio: false,
      );
      
      await _controller!.initialize();
      
      // 실시간 음식 인식 시작
      _startFoodRecognition();
      
      setState(() {
        _isInitialized = true;
      });
    } catch (e) {
      _showError('카메라 초기화 실패: $e');
    }
  }
  
  void _startFoodRecognition() {
    // 실시간 인식은 첫 번째 사진만
    if (_capturedImages.isNotEmpty) return;
    
    // 1초마다 프레임 분석 (Mock)
    Future.delayed(const Duration(seconds: 1), () {
      if (!mounted || _controller == null) return;
      
      // Mock 음식 인식
      setState(() {
        _isFoodDetected = true;
        _detectedFood = '김치찌개';
      });
      
      if (mounted && _capturedImages.isEmpty) {
        _startFoodRecognition();
      }
    });
  }
  
  @override
  Widget build(BuildContext context) {
    if (!_isInitialized || _controller == null) {
      return const Center(
        child: CircularProgressIndicator(),
      );
    }
    
    return Stack(
      children: [
        // 카메라 프리뷰
        Positioned.fill(
          child: CameraPreview(_controller!),
        ),
        
        // 멀티 사진 팁
        if (_showMultiPhotoTip)
          Positioned(
            top: 100,
            left: 16,
            right: 16,
            child: MultiPhotoTipWidget(
              onDismiss: () {
                setState(() {
                  _showMultiPhotoTip = false;
                });
              },
            ),
          ),
        
        // 음식 감지 오버레이 (첫 번째 사진만)
        if (_capturedImages.isEmpty)
          Positioned(
            top: 20,
            left: 20,
            right: 20,
            child: FoodDetectionOverlay(
              isFoodDetected: _isFoodDetected,
              detectedFood: _detectedFood,
              existingCount: 234,
              confidence: 0.92,
            ),
          ),
        
        // 가이드 프레임
        Center(
          child: Container(
            width: 300,
            height: 300,
            decoration: BoxDecoration(
              border: Border.all(
                color: Colors.white.withOpacity(0.5),
                width: 2,
              ),
              borderRadius: BorderRadius.circular(12),
            ),
          ),
        ),
        
        // 하단 UI
        Positioned(
          bottom: 0,
          left: 0,
          right: 0,
          child: Container(
            color: Colors.black.withOpacity(0.7),
            padding: const EdgeInsets.symmetric(vertical: 20),
            child: Column(
              children: [
                // 캡처된 이미지 썸네일
                if (_capturedImages.isNotEmpty)
                  Container(
                    height: 80,
                    margin: const EdgeInsets.only(bottom: 20),
                    child: ListView.builder(
                      scrollDirection: Axis.horizontal,
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      itemCount: _capturedImages.length + 1,
                      itemBuilder: (context, index) {
                        if (index == _capturedImages.length) {
                          // 추가 버튼
                          if (_capturedImages.length < 5) {
                            return _buildAddPhotoButton();
                          } else {
                            return const SizedBox.shrink();
                          }
                        }
                        
                        return _buildThumbnail(index);
                      },
                    ),
                  ),
                
                // 촬영 버튼 또는 완료 버튼
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [
                    // 갤러리
                    IconButton(
                      onPressed: _pickFromGallery,
                      icon: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(
                          Icons.photo_library,
                          color: Colors.white,
                          size: 24,
                        ),
                      ),
                    ),
                    
                    // 촬영/완료 버튼
                    GestureDetector(
                      onTap: _isProcessing 
                          ? null 
                          : (_capturedImages.isEmpty ? _takePicture : _complete),
                      child: Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          color: _capturedImages.isEmpty 
                              ? Colors.white 
                              : Theme.of(context).primaryColor,
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: _capturedImages.isEmpty
                                ? Theme.of(context).primaryColor
                                : Colors.white,
                            width: 4,
                          ),
                        ),
                        child: _isProcessing
                            ? const Center(
                                child: CircularProgressIndicator(),
                              )
                            : Icon(
                                _capturedImages.isEmpty 
                                    ? Icons.camera 
                                    : Icons.check,
                                size: 40,
                                color: _capturedImages.isEmpty
                                    ? Theme.of(context).primaryColor
                                    : Colors.white,
                              ),
                      ),
                    ),
                    
                    // 사진 수
                    Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        shape: BoxShape.circle,
                      ),
                      child: Center(
                        child: Text(
                          '${_capturedImages.length}/5',
                          style: const TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
                
                // 안내 텍스트
                if (_capturedImages.isEmpty)
                  const Padding(
                    padding: EdgeInsets.only(top: 8),
                    child: Text(
                      '첫 번째 사진은 반드시 음식 사진이어야 해요',
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                      ),
                    ),
                  )
                else if (_capturedImages.length == 1)
                  const Padding(
                    padding: EdgeInsets.only(top: 8),
                    child: Text(
                      '분위기, 메뉴판 등을 추가로 촬영할 수 있어요',
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ),
      ],
    );
  }
  
  Widget _buildThumbnail(int index) {
    return Container(
      margin: const EdgeInsets.only(right: 8),
      child: Stack(
        children: [
          ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: Image.file(
              _capturedImages[index],
              width: 80,
              height: 80,
              fit: BoxFit.cover,
            ),
          ),
          // 첫 번째 표시
          if (index == 0)
            Positioned(
              top: 4,
              left: 4,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 6,
                  vertical: 2,
                ),
                decoration: BoxDecoration(
                  color: Theme.of(context).primaryColor,
                  borderRadius: BorderRadius.circular(4),
                ),
                child: const Text(
                  '음식',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
          // 삭제 버튼
          Positioned(
            top: 0,
            right: 0,
            child: GestureDetector(
              onTap: () => _removeImage(index),
              child: Container(
                padding: const EdgeInsets.all(4),
                decoration: const BoxDecoration(
                  color: Colors.red,
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.close,
                  color: Colors.white,
                  size: 12,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildAddPhotoButton() {
    return GestureDetector(
      onTap: _takePicture,
      child: Container(
        width: 80,
        height: 80,
        margin: const EdgeInsets.only(right: 8),
        decoration: BoxDecoration(
          color: Colors.white.withOpacity(0.2),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: Colors.white.withOpacity(0.5),
            width: 2,
            style: BorderStyle.solid,
          ),
        ),
        child: const Icon(
          Icons.add,
          color: Colors.white,
          size: 32,
        ),
      ),
    );
  }
  
  Future<void> _takePicture() async {
    if (_controller == null || _isProcessing) return;
    if (_capturedImages.length >= 5) return;
    
    setState(() {
      _isProcessing = true;
    });
    
    try {
      final image = await _controller!.takePicture();
      final file = File(image.path);
      
      // 첫 번째 사진인 경우 음식 검증
      if (_capturedImages.isEmpty) {
        final validation = await FoodImageValidator.validateFoodImage(file);
        
        if (!validation.isValid) {
          _showError('음식이 감지되지 않았습니다. 음식을 촬영해주세요.');
          setState(() {
            _isProcessing = false;
          });
          return;
        }
      }
      
      setState(() {
        _capturedImages.add(file);
        _isProcessing = false;
      });
      
      // 5장 찍으면 자동 완료
      if (_capturedImages.length >= 5) {
        _complete();
      }
    } catch (e) {
      _showError('사진 촬영 실패: $e');
      setState(() {
        _isProcessing = false;
      });
    }
  }
  
  Future<void> _pickFromGallery() async {
    final picker = ImagePicker();
    
    if (_capturedImages.isEmpty) {
      // 첫 번째 사진
      final image = await picker.pickImage(source: ImageSource.gallery);
      if (image != null) {
        final file = File(image.path);
        
        // 음식 검증
        final validation = await FoodImageValidator.validateFoodImage(file);
        if (!validation.isValid) {
          _showError('음식이 감지되지 않았습니다. 음식 사진을 선택해주세요.');
          return;
        }
        
        setState(() {
          _capturedImages.add(file);
        });
      }
    } else {
      // 여러 장 선택
      final images = await picker.pickMultiImage();
      final remainingSlots = 5 - _capturedImages.length;
      
      for (int i = 0; i < images.length && i < remainingSlots; i++) {
        setState(() {
          _capturedImages.add(File(images[i].path));
        });
      }
    }
  }
  
  void _removeImage(int index) {
    setState(() {
      _capturedImages.removeAt(index);
    });
  }
  
  void _complete() {
    if (_capturedImages.isEmpty) {
      _showError('최소 1장의 사진이 필요합니다');
      return;
    }
    
    widget.onImagesSelected(_capturedImages);
  }
  
  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(message)),
    );
  }
  
  @override
  void dispose() {
    _controller?.dispose();
    super.dispose();
  }
}
```

## 8. 나중에 영수증 추가

### [필수] 영수증 추가 기능
```dart
// 파일: lib/features/feed/widgets/receipt_addition_widget.dart
import 'package:flutter/material.dart';
import 'dart:io';

class ReceiptAdditionWidget extends StatefulWidget {
  final String feedId;
  final DateTime createdAt;
  final VoidCallback onAdded;
  
  const ReceiptAdditionWidget({
    Key? key,
    required this.feedId,
    required this.createdAt,
    required this.onAdded,
  }) : super(key: key);
  
  @override
  _ReceiptAdditionWidgetState createState() => _ReceiptAdditionWidgetState();
}

class _ReceiptAdditionWidgetState extends State<ReceiptAdditionWidget> {
  bool _canAddReceipt = false;
  Duration? _remainingTime;
  Timer? _timer;
  
  @override
  void initState() {
    super.initState();
    _checkReceiptEligibility();
    _startTimer();
  }
  
  void _checkReceiptEligibility() {
    final now = DateTime.now();
    final difference = now.difference(widget.createdAt);
    
    // 24시간 이내인지 확인
    if (difference.inHours < 24) {
      setState(() {
        _canAddReceipt = true;
        _remainingTime = const Duration(hours: 24) - difference;
      });
    }
  }
  
  void _startTimer() {
    _timer = Timer.periodic(const Duration(minutes: 1), (timer) {
      _checkReceiptEligibility();
      
      if (!_canAddReceipt) {
        timer.cancel();
      }
    });
  }
  
  @override
  Widget build(BuildContext context) {
    if (!_canAddReceipt) {
      return const SizedBox.shrink();
    }
    
    return Container(
      margin: const EdgeInsets.all(16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.blue[50],
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: Colors.blue[200]!,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.receipt_long,
                color: Colors.blue[700],
                size: 24,
              ),
              const SizedBox(width: 8),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      '영수증을 추가하면 +5P를 받을 수 있어요!',
                      style: TextStyle(
                        color: Colors.blue[700],
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    if (_remainingTime != null)
                      Text(
                        '남은 시간: ${_formatDuration(_remainingTime!)}',
                        style: TextStyle(
                          color: Colors.blue[600],
                          fontSize: 12,
                        ),
                      ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: _addReceipt,
              icon: const Icon(Icons.camera_alt),
              label: const Text('영수증 촬영하기'),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.blue[700],
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  String _formatDuration(Duration duration) {
    final hours = duration.inHours;
    final minutes = duration.inMinutes % 60;
    
    if (hours > 0) {
      return '$hours시간 ${minutes}분';
    } else {
      return '$minutes분';
    }
  }
  
  void _addReceipt() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ReceiptCaptureModal(
        feedId: widget.feedId,
        onSuccess: () {
          Navigator.pop(context);
          widget.onAdded();
          _showSuccessMessage();
        },
      ),
    );
  }
  
  void _showSuccessMessage() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(
              Icons.check_circle,
              color: Colors.green,
              size: 64,
            ),
            const SizedBox(height: 16),
            const Text(
              '영수증이 추가되었습니다!',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 8,
              ),
              decoration: BoxDecoration(
                color: Theme.of(context).primaryColor.withOpacity(0.1),
                borderRadius: BorderRadius.circular(20),
              ),
              child: Text(
                '+5P 획득!',
                style: TextStyle(
                  color: Theme.of(context).primaryColor,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('확인'),
          ),
        ],
      ),
    );
  }
  
  @override
  void dispose() {
    _timer?.cancel();
    super.dispose();
  }
}
```

### [필수] 영수증 캡처 모달
```dart
// 파일: lib/features/feed/modals/receipt_capture_modal.dart
class ReceiptCaptureModal extends StatefulWidget {
  final String feedId;
  final VoidCallback onSuccess;
  
  const ReceiptCaptureModal({
    Key? key,
    required this.feedId,
    required this.onSuccess,
  }) : super(key: key);
  
  @override
  _ReceiptCaptureModalState createState() => _ReceiptCaptureModalState();
}

class _ReceiptCaptureModalState extends State<ReceiptCaptureModal> {
  File? _receiptImage;
  bool _isProcessing = false;
  Map<String, dynamic>? _ocrResult;
  
  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.9,
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(20),
        ),
      ),
      child: Column(
        children: [
          // 헤더
          Container(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.close),
                ),
                const Expanded(
                  child: Text(
                    '영수증 추가',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(width: 48),
              ],
            ),
          ),
          
          // 콘텐츠
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: Column(
                children: [
                  // 안내 문구
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.amber[50],
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.info_outline,
                          color: Colors.amber[700],
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            '영수증을 촬영하면 점포 정보가 자동으로 인식되고\n위치 정확도가 향상됩니다.',
                            style: TextStyle(
                              color: Colors.amber[700],
                              fontSize: 14,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),
                  
                  // 영수증 촬영/미리보기
                  if (_receiptImage == null)
                    GestureDetector(
                      onTap: _captureReceipt,
                      child: Container(
                        height: 300,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          color: Colors.grey[100],
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: Colors.grey[300]!,
                            width: 2,
                            style: BorderStyle.solid,
                          ),
                        ),
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Icons.receipt_long,
                              size: 64,
                              color: Colors.grey[400],
                            ),
                            const SizedBox(height: 16),
                            Text(
                              '영수증 촬영하기',
                              style: TextStyle(
                                fontSize: 18,
                                color: Colors.grey[600],
                              ),
                            ),
                            const SizedBox(height: 8),
                            Text(
                              '탭하여 카메라 열기',
                              style: TextStyle(
                                fontSize: 14,
                                color: Colors.grey[500],
                              ),
                            ),
                          ],
                        ),
                      ),
                    )
                  else ...[
                    // 영수증 이미지
                    ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: Image.file(
                        _receiptImage!,
                        height: 300,
                        width: double.infinity,
                        fit: BoxFit.cover,
                      ),
                    ),
                    const SizedBox(height: 16),
                    
                    // 재촬영 버튼
                    TextButton.icon(
                      onPressed: _captureReceipt,
                      icon: const Icon(Icons.refresh),
                      label: const Text('다시 촬영'),
                    ),
                  ],
                  
                  // OCR 결과
                  if (_ocrResult != null) ...[
                    const SizedBox(height: 24),
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.green[50],
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(
                          color: Colors.green[200]!,
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Icon(
                                Icons.check_circle,
                                color: Colors.green[700],
                                size: 20,
                              ),
                              const SizedBox(width: 8),
                              Text(
                                '영수증 인식 완료',
                                style: TextStyle(
                                  color: Colors.green[700],
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          _buildOcrResultItem(
                            '점포명',
                            _ocrResult!['storeName'] ?? '인식 실패',
                          ),
                          _buildOcrResultItem(
                            '주소',
                            _ocrResult!['address'] ?? '인식 실패',
                          ),
                          _buildOcrResultItem(
                            '날짜',
                            _ocrResult!['date'] ?? '인식 실패',
                          ),
                          _buildOcrResultItem(
                            '금액',
                            _ocrResult!['amount'] ?? '인식 실패',
                          ),
                        ],
                      ),
                    ),
                  ],
                  
                  // 처리 중
                  if (_isProcessing)
                    Container(
                      height: 200,
                      child: const Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            CircularProgressIndicator(),
                            SizedBox(height: 16),
                            Text('영수증을 분석하고 있습니다...'),
                          ],
                        ),
                      ),
                    ),
                ],
              ),
            ),
          ),
          
          // 하단 버튼
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 10,
                  offset: const Offset(0, -5),
                ),
              ],
            ),
            child: SafeArea(
              child: SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: (_receiptImage != null && 
                            _ocrResult != null && 
                            !_isProcessing)
                      ? _submitReceipt
                      : null,
                  style: ElevatedButton.styleFrom(
                    minimumSize: const Size(0, 56),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Text(
                    '영수증 추가하기',
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildOcrResultItem(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 60,
            child: Text(
              label,
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[600],
              ),
            ),
          ),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  Future<void> _captureReceipt() async {
    // 카메라 또는 갤러리 선택
    final source = await showModalBottomSheet<ImageSource>(
      context: context,
      builder: (context) => Container(
        padding: const EdgeInsets.all(16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              leading: const Icon(Icons.camera_alt),
              title: const Text('카메라로 촬영'),
              onTap: () => Navigator.pop(context, ImageSource.camera),
            ),
            ListTile(
              leading: const Icon(Icons.photo_library),
              title: const Text('갤러리에서 선택'),
              onTap: () => Navigator.pop(context, ImageSource.gallery),
            ),
          ],
        ),
      ),
    );
    
    if (source == null) return;
    
    final picker = ImagePicker();
    final image = await picker.pickImage(source: source);
    
    if (image != null) {
      setState(() {
        _receiptImage = File(image.path);
        _isProcessing = true;
        _ocrResult = null;
      });
      
      // OCR 처리
      await _processOcr();
    }
  }
  
  Future<void> _processOcr() async {
    try {
      // Mock OCR 처리
      await Future.delayed(const Duration(seconds: 2));
      
      setState(() {
        _ocrResult = {
          'storeName': '맛있는 김치찌개',
          'address': '서울시 강남구 테헤란로 123',
          'date': '2025-01-15 12:30',
          'amount': '8,000원',
        };
        _isProcessing = false;
      });
    } catch (e) {
      setState(() {
        _isProcessing = false;
      });
      _showError('영수증 인식에 실패했습니다');
    }
  }
  
  Future<void> _submitReceipt() async {
    setState(() {
      _isProcessing = true;
    });
    
    try {
      // API 호출 (Mock)
      await Future.delayed(const Duration(seconds: 1));
      
      // 성공
      widget.onSuccess();
    } catch (e) {
      _showError('영수증 추가에 실패했습니다');
    } finally {
      setState(() {
        _isProcessing = false;
      });
    }
  }
  
  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(message)),
    );
  }
}
```

## 9. 검증

### ✅ 체크리스트
- [ ] 카메라 권한 요청 및 촬영 성공
- [ ] 실시간 음식 인식 오버레이 표시
- [ ] 첫 번째 사진 음식 검증
- [ ] 멀티 사진 촬영 (최대 5장)
- [ ] 사진 순서 변경 가능
- [ ] 이미지 압축 및 업로드 진행 표시
- [ ] 위치 확인 및 영수증 OCR
- [ ] 정보 입력 및 유효성 검증
- [ ] 포인트 획득 및 완료 애니메이션
- [ ] 24시간 내 영수증 추가 가능
- [ ] 영수증 추가 시 추가 포인트

### 🧪 통합 테스트
```dart
// 파일: test/feed_creation/feed_creation_flow_test.dart
void main() {
  group('피드 등록 플로우 테스트', () {
    testWidgets('멀티 사진 등록 테스트', (tester) async {
      await tester.pumpWidget(TestApp(
        child: FeedCreationFlow(),
      ));
      
      // 1. 첫 번째 사진 (음식 필수)
      expect(find.text('첫 번째 사진은 반드시 음식 사진이어야 해요'), findsOneWidget);
      
      // 음식 사진 촬영
      await tester.tap(find.byIcon(Icons.camera));
      await tester.pumpAndSettle();
      
      // 2. 추가 사진 촬영
      expect(find.text('1/5'), findsOneWidget);
      
      // 두 번째 사진
      await tester.tap(find.byIcon(Icons.add));
      await tester.pumpAndSettle();
      
      expect(find.text('2/5'), findsOneWidget);
      
      // 완료 버튼
      await tester.tap(find.byIcon(Icons.check));
      await tester.pumpAndSettle();
      
      // 다음 단계로 진행
      expect(find.text('음식 인식'), findsOneWidget);
    });
    
    testWidgets('영수증 추가 테스트', (tester) async {
      // 피드 상세 화면
      await tester.pumpWidget(TestApp(
        child: FeedDetailScreen(
          feedId: 'test_feed',
          createdAt: DateTime.now(),
        ),
      ));
      
      // 영수증 추가 위젯 표시
      expect(find.text('영수증을 추가하면 +5P를 받을 수 있어요!'), findsOneWidget);
      
      // 영수증 촬영 버튼
      await tester.tap(find.text('영수증 촬영하기'));
      await tester.pumpAndSettle();
      
      // 영수증 캡처 모달
      expect(find.text('영수증 추가'), findsOneWidget);
    });
    
    testWidgets('음식 미감지 시 에러', (tester) async {
      // Mock 음식 미감지
      when(mockFoodValidator.validateFoodImage(any))
          .thenAnswer((_) async => FoodValidationResult(
            isValid: false,
            confidence: 0.3,
            message: '음식이 감지되지 않았습니다',
          ));
      
      await tester.pumpWidget(TestApp(
        child: MultiPhotoCameraStep(
          onImagesSelected: (_) {},
        ),
      ));
      
      // 촬영 시도
      await tester.tap(find.byIcon(Icons.camera));
      await tester.pumpAndSettle();
      
      // 에러 메시지
      expect(find.text('음식이 감지되지 않았습니다. 음식을 촬영해주세요.'), findsOneWidget);
    });
  });
}
```