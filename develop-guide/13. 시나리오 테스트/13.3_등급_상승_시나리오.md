# ğŸ† 13.3 ë“±ê¸‰ ìƒìŠ¹ ì‹œë‚˜ë¦¬ì˜¤

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [í¬ì¸íŠ¸ íšë“ ê³¼ì •](#2-í¬ì¸íŠ¸-íšë“-ê³¼ì •)
3. [ë“±ê¸‰ ìƒìŠ¹ ì¡°ê±´](#3-ë“±ê¸‰-ìƒìŠ¹-ì¡°ê±´)
4. [ì•Œë¦¼ ë° ì• ë‹ˆë©”ì´ì…˜](#4-ì•Œë¦¼-ë°-ì• ë‹ˆë©”ì´ì…˜)
5. [ê¶Œí•œ ë³€ê²½ í™•ì¸](#5-ê¶Œí•œ-ë³€ê²½-í™•ì¸)
6. [ê²€ì¦](#6-ê²€ì¦)

## 1. ê°œìš”
ì‚¬ìš©ìì˜ í™œë™ì— ë”°ë¥¸ í¬ì¸íŠ¸ íšë“ë¶€í„° ë“±ê¸‰ ìƒìŠ¹, ê·¸ì— ë”°ë¥¸ ê¶Œí•œ ë³€ê²½ê¹Œì§€ì˜ ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… í™œë™ë³„ í¬ì¸íŠ¸ ì²´ê³„
- âœ… ë“±ê¸‰ë³„ í•„ìš” í¬ì¸íŠ¸
- âœ… ìƒìŠ¹ ì‹œ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
- âœ… ìƒˆë¡œìš´ ê¶Œí•œ ì•ˆë‚´

## 2. í¬ì¸íŠ¸ íšë“ ê³¼ì •

### [í•„ìˆ˜] í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ê´€ë¦¬ì
```dart
// íŒŒì¼: lib/features/grade/managers/point_manager.dart
import 'package:supabase_flutter/supabase_flutter.dart';

class PointManager {
  static final PointManager _instance = PointManager._internal();
  factory PointManager() => _instance;
  PointManager._internal();

  final SupabaseClient _supabase = Supabase.instance.client;
  
  /// í¬ì¸íŠ¸ íšë“ ìœ í˜•
  static const Map<PointType, int> pointValues = {
    PointType.feedCreation: 10,
    PointType.firstFeedBonus: 50,
    PointType.detailedInfo: 5,
    PointType.receiptVerification: 10,
    PointType.recommendation: 2,
    PointType.receivedRecommendation: 1,
    PointType.dailyLogin: 5,
    PointType.weeklyBonus: 20,
  };
  
  /// í¬ì¸íŠ¸ íšë“
  Future<PointTransaction> earnPoints({
    required String userId,
    required PointType type,
    Map<String, dynamic>? metadata,
  }) async {
    try {
      // í¬ì¸íŠ¸ ê°’ ê³„ì‚°
      int points = pointValues[type] ?? 0;
      
      // íŠ¹ë³„ ë³´ë„ˆìŠ¤ ê³„ì‚°
      if (metadata?['isFirstPost'] == true) {
        points += pointValues[PointType.firstFeedBonus]!;
      }
      
      // íŠ¸ëœì­ì…˜ ìƒì„±
      final transaction = PointTransaction(
        userId: userId,
        type: type,
        points: points,
        timestamp: DateTime.now(),
        metadata: metadata,
      );
      
      // Supabase íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
      await _supabase.rpc('update_user_points', params: {
        'p_user_id': userId,
        'p_points': points,
        'p_transaction_type': type.toString(),
        'p_metadata': metadata,
      }).then((result) async {
        // ì‚¬ìš©ì í˜„ì¬ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        final userResponse = await _supabase
            .from('users')
            .select('total_points, activity_score')
            .eq('id', userId)
            .single();
        
        final currentPoints = userResponse['total_points'] ?? 0;
        final currentActivityScore = userResponse['activity_score'] ?? 0;
        
        // ë“±ê¸‰ í™•ì¸
        final gradeInfo = await _checkGradeUpgrade(
          userId: userId,
          currentPoints: currentActivityScore - points,
          newPoints: currentActivityScore,
        );
        
        transaction.gradeUpgrade = gradeInfo;
      });
      
      // ë¡œì»¬ ì•Œë¦¼ ë°œìƒ
      _notifyPointEarned(transaction);
      
      return transaction;
      
    } catch (e) {
      print('Error earning points: $e');
      rethrow;
    }
  }
  
  /// ë“±ê¸‰ ìƒìŠ¹ í™•ì¸
  Future<GradeUpgradeInfo?> _checkGradeUpgrade({
    required String userId,
    required int currentPoints,
    required int newPoints,
  }) async {
    final currentGrade = GradeSystem.getGradeByPoints(currentPoints);
    final newGrade = GradeSystem.getGradeByPoints(newPoints);
    
    if (currentGrade.level < newGrade.level) {
      // ë“±ê¸‰ ìƒìŠ¹!
      await _supabase
          .from('users')
          .update({
            'grade': newGrade.name,
            'grade_level': newGrade.level,
            'grade_updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', userId);
      
      // ë“±ê¸‰ ìƒìŠ¹ ê¸°ë¡
      await _supabase
          .from('grade_history')
          .insert({
            'user_id': userId,
            'from_grade': currentGrade.name,
            'to_grade': newGrade.name,
            'timestamp': DateTime.now().toIso8601String(),
            'points_at_upgrade': newPoints,
          });
      
      return GradeUpgradeInfo(
        previousGrade: currentGrade,
        newGrade: newGrade,
        timestamp: DateTime.now(),
      );
    }
    
    return null;
  }
  
  /// í¬ì¸íŠ¸ íšë“ ì•Œë¦¼
  void _notifyPointEarned(PointTransaction transaction) {
    // ì´ë²¤íŠ¸ ë°œìƒ
    PointEventBus().notify(transaction);
  }
  
  /// í¬ì¸íŠ¸ ê¸°ë¡ ì¡°íšŒ
  Stream<List<PointTransaction>> getPointHistory(String userId) {
    return _supabase
        .from('point_history')
        .stream(primaryKey: ['id'])
        .eq('user_id', userId)
        .order('timestamp', ascending: false)
        .limit(50)
        .map((data) => data
            .map((json) => PointTransaction.fromMap(json))
            .toList());
  }
  
  /// ì¼ì¼ í¬ì¸íŠ¸ íšë“ ì œí•œ í™•ì¸
  Future<bool> checkDailyLimit(String userId, PointType type) async {
    final today = DateTime.now();
    final startOfDay = DateTime(today.year, today.month, today.day);
    
    final response = await _supabase
        .from('point_history')
        .select('id')
        .eq('user_id', userId)
        .eq('type', type.toString())
        .gte('timestamp', startOfDay.toIso8601String())
    
    // í™œë™ë³„ ì¼ì¼ ì œí•œ
    final dailyLimits = {
      PointType.feedCreation: 10,
      PointType.recommendation: 50,
      PointType.dailyLogin: 1,
    };
    
    final limit = dailyLimits[type] ?? 999;
    return response.length < limit;
  }
}

enum PointType {
  feedCreation,
  firstFeedBonus,
  detailedInfo,
  receiptVerification,
  recommendation,
  receivedRecommendation,
  dailyLogin,
  weeklyBonus,
}

class PointTransaction {
  final String userId;
  final PointType type;
  final int points;
  final DateTime timestamp;
  final Map<String, dynamic>? metadata;
  GradeUpgradeInfo? gradeUpgrade;
  
  PointTransaction({
    required this.userId,
    required this.type,
    required this.points,
    required this.timestamp,
    this.metadata,
    this.gradeUpgrade,
  });
  
  Map<String, dynamic> toMap() => {
    'userId': userId,
    'type': type.toString(),
    'points': points,
    'timestamp': timestamp,
    'metadata': metadata,
  };
  
  factory PointTransaction.fromMap(Map<String, dynamic> map) => PointTransaction(
    userId: map['user_id'],
    type: PointType.values.firstWhere(
      (e) => e.toString() == map['type'],
    ),
    points: map['points'],
    timestamp: DateTime.parse(map['timestamp']),
    metadata: map['metadata'],
  );
}
```

### [í•„ìˆ˜] í¬ì¸íŠ¸ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
```dart
// íŒŒì¼: lib/features/grade/events/point_event_bus.dart
import 'dart:async';

class PointEventBus {
  static final PointEventBus _instance = PointEventBus._internal();
  factory PointEventBus() => _instance;
  PointEventBus._internal();
  
  final _controller = StreamController<PointTransaction>.broadcast();
  
  Stream<PointTransaction> get stream => _controller.stream;
  
  void notify(PointTransaction transaction) {
    _controller.add(transaction);
  }
  
  void dispose() {
    _controller.close();
  }
}

/// í¬ì¸íŠ¸ íšë“ UI ìœ„ì ¯
class PointNotificationWidget extends StatefulWidget {
  final Widget child;
  
  const PointNotificationWidget({
    Key? key,
    required this.child,
  }) : super(key: key);
  
  @override
  _PointNotificationWidgetState createState() => _PointNotificationWidgetState();
}

class _PointNotificationWidgetState extends State<PointNotificationWidget>
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;
  
  StreamSubscription? _subscription;
  PointTransaction? _currentTransaction;
  Timer? _hideTimer;
  
  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _listenToPointEvents();
  }
  
  void _setupAnimations() {
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );
    
    _slideAnimation = Tween<double>(
      begin: -100,
      end: 0,
    ).animate(CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeOutCubic,
    ));
    
    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeIn,
    ));
  }
  
  void _listenToPointEvents() {
    _subscription = PointEventBus().stream.listen((transaction) {
      setState(() {
        _currentTransaction = transaction;
      });
      
      _animationController.forward();
      
      // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
      _hideTimer?.cancel();
      _hideTimer = Timer(const Duration(seconds: 3), () {
        _hideTransaction();
      });
    });
  }
  
  void _hideTransaction() {
    _animationController.reverse().then((_) {
      if (mounted) {
        setState(() {
          _currentTransaction = null;
        });
      }
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        widget.child,
        
        // í¬ì¸íŠ¸ ì•Œë¦¼
        if (_currentTransaction != null)
          Positioned(
            top: MediaQuery.of(context).padding.top + 20,
            left: 20,
            right: 20,
            child: AnimatedBuilder(
              animation: _animationController,
              builder: (context, child) {
                return Transform.translate(
                  offset: Offset(0, _slideAnimation.value),
                  child: FadeTransition(
                    opacity: _fadeAnimation,
                    child: _buildNotification(_currentTransaction!),
                  ),
                );
              },
            ),
          ),
      ],
    );
  }
  
  Widget _buildNotification(PointTransaction transaction) {
    return GestureDetector(
      onTap: _hideTransaction,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 10,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              width: 48,
              height: 48,
              decoration: BoxDecoration(
                color: Theme.of(context).primaryColor.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.stars,
                color: Theme.of(context).primaryColor,
                size: 24,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    _getPointMessage(transaction.type),
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '+${transaction.points} í¬ì¸íŠ¸',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).primaryColor,
                    ),
                  ),
                ],
              ),
            ),
            if (transaction.gradeUpgrade != null)
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: Colors.amber,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: const Text(
                  'ë“±ê¸‰ UP!',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
  
  String _getPointMessage(PointType type) {
    switch (type) {
      case PointType.feedCreation:
        return 'í”¼ë“œ ë“±ë¡';
      case PointType.firstFeedBonus:
        return 'ì²« ë“±ë¡ ë³´ë„ˆìŠ¤';
      case PointType.detailedInfo:
        return 'ìƒì„¸ ì •ë³´ ì œê³µ';
      case PointType.receiptVerification:
        return 'ì˜ìˆ˜ì¦ ì¸ì¦';
      case PointType.recommendation:
        return 'ì¶”ì²œí•˜ê¸°';
      case PointType.receivedRecommendation:
        return 'ì¶”ì²œë°›ê¸°';
      case PointType.dailyLogin:
        return 'ì¼ì¼ ì¶œì„';
      case PointType.weeklyBonus:
        return 'ì£¼ê°„ ë³´ë„ˆìŠ¤';
    }
  }
  
  @override
  void dispose() {
    _subscription?.cancel();
    _hideTimer?.cancel();
    _animationController.dispose();
    super.dispose();
  }
}
```

## 3. ë“±ê¸‰ ìƒìŠ¹ ì¡°ê±´

### [í•„ìˆ˜] ë“±ê¸‰ ì‹œìŠ¤í…œ ì •ì˜
```dart
// íŒŒì¼: lib/features/grade/models/grade_system.dart
class GradeSystem {
  static const List<Grade> grades = [
    Grade(
      level: 1,
      name: 'ëˆ„ë£½ì§€',
      emoji: 'ğŸ˜',
      requiredPoints: 0,
      description: 'êµ¬ìˆ˜í•˜ê³  ë‹´ë°±í•œ ë§›ì˜ ì‹œì‘ì ',
      benefits: ['ê¸°ë³¸ í”¼ë“œ ë“±ë¡', 'ì¶”ì²œ ê¸°ëŠ¥'],
    ),
    Grade(
      level: 2,
      name: 'ë¹„ë¹”ë°¥',
      emoji: 'ğŸ¥—',
      requiredPoints: 100,
      description: 'ë‹¤ì–‘í•œ ì¬ë£Œê°€ ì–´ìš°ëŸ¬ì§„ ì¡°í™”',
      benefits: ['íƒœê·¸ 5ê°œ ì‚¬ìš©', 'ì£¼ê°„ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸'],
    ),
    Grade(
      level: 3,
      name: 'ì‚¼ê²¹ì‚´',
      emoji: 'ğŸ¥“',
      requiredPoints: 300,
      description: 'ì„¸ê³„ì ìœ¼ë¡œ ì•Œë ¤ì§„ K-ë°”ë² íì˜ ì •ìˆ˜',
      benefits: ['í”„ë¡œí•„ ë±ƒì§€', 'ì›”ê°„ ë­í‚¹ ì°¸ì—¬'],
    ),
    Grade(
      level: 4,
      name: 'ê°ˆë¹„íƒ•',
      emoji: 'ğŸ²',
      requiredPoints: 600,
      description: 'ì§„í•œ ìœ¡ìˆ˜ì˜ ê¹Šì´ë¥¼ ì•„ëŠ” ë‹¨ê³„',
      benefits: ['í”¼ë“œ í•˜ì´ë¼ì´íŠ¸', 'íŠ¹ë³„ ì´ë²¤íŠ¸ ì°¸ì—¬'],
    ),
    Grade(
      level: 5,
      name: 'ëª¨ë‘ íšŒ',
      emoji: 'ğŸŸ',
      requiredPoints: 1000,
      description: 'ì‹ ì„ í•œ ì‹ì¬ë£Œì˜ ë³¸ì—°ì˜ ë§›',
      benefits: ['í”„ë¦¬ë¯¸ì—„ í•„í„°', 'ë§›ì§‘ ì¸ì¦ íˆ¬í‘œê¶Œ'],
    ),
    Grade(
      level: 6,
      name: 'ì”ì¹«ìƒ',
      emoji: 'ğŸŠ',
      requiredPoints: 1500,
      description: 'í’ì„±í•˜ê³  ë‹¤ì±„ë¡œìš´ êµ¬ì„±ì˜ ìƒì°¨ë¦¼',
      benefits: ['VIP ë±ƒì§€', 'ìš°ì„  ë…¸ì¶œ'],
    ),
    Grade(
      level: 7,
      name: 'ìˆ˜ëìƒ',
      emoji: 'ğŸ‘‘',
      requiredPoints: 2500,
      description: 'ê¶ì¤‘ ìš”ë¦¬ì˜ ì ˆì •',
      benefits: ['ìœ„ì¹˜ ê³µìœ  ê¸°ëŠ¥', 'ì¸í”Œë£¨ì–¸ì„œ í›„ë³´'],
    ),
  ];
  
  /// í¬ì¸íŠ¸ë¡œ ë“±ê¸‰ í™•ì¸
  static Grade getGradeByPoints(int points) {
    for (int i = grades.length - 1; i >= 0; i--) {
      if (points >= grades[i].requiredPoints) {
        return grades[i];
      }
    }
    return grades.first;
  }
  
  /// ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€ í•„ìš”í•œ í¬ì¸íŠ¸
  static int getPointsToNextGrade(int currentPoints) {
    final currentGrade = getGradeByPoints(currentPoints);
    if (currentGrade.level >= grades.length) {
      return 0; // ìµœê³  ë“±ê¸‰
    }
    
    final nextGrade = grades[currentGrade.level];
    return nextGrade.requiredPoints - currentPoints;
  }
  
  /// ì§„í–‰ë¥  ê³„ì‚° (0.0 ~ 1.0)
  static double getProgressToNextGrade(int currentPoints) {
    final currentGrade = getGradeByPoints(currentPoints);
    if (currentGrade.level >= grades.length) {
      return 1.0; // ìµœê³  ë“±ê¸‰
    }
    
    final nextGrade = grades[currentGrade.level];
    final currentGradePoints = currentGrade.requiredPoints;
    final nextGradePoints = nextGrade.requiredPoints;
    
    final progress = (currentPoints - currentGradePoints) / 
                    (nextGradePoints - currentGradePoints);
    
    return progress.clamp(0.0, 1.0);
  }
}

class Grade {
  final int level;
  final String name;
  final String emoji;
  final int requiredPoints;
  final String description;
  final List<String> benefits;
  
  const Grade({
    required this.level,
    required this.name,
    required this.emoji,
    required this.requiredPoints,
    required this.description,
    required this.benefits,
  });
}

class GradeUpgradeInfo {
  final Grade previousGrade;
  final Grade newGrade;
  final DateTime timestamp;
  
  GradeUpgradeInfo({
    required this.previousGrade,
    required this.newGrade,
    required this.timestamp,
  });
}
```

### [í•„ìˆ˜] ë“±ê¸‰ ìƒíƒœ ìœ„ì ¯
```dart
// íŒŒì¼: lib/features/grade/widgets/grade_status_widget.dart
class GradeStatusWidget extends StatelessWidget {
  final String userId;
  
  const GradeStatusWidget({
    Key? key,
    required this.userId,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<Map<String, dynamic>>(
      stream: Supabase.instance.client
          .from('users')
          .stream(primaryKey: ['id'])
          .eq('id', userId)
          .map((data) => data.first),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return const SizedBox.shrink();
        }
        
        final userData = snapshot.data!;
        final currentPoints = userData['activity_score'] ?? 0;
        final currentGrade = GradeSystem.getGradeByPoints(currentPoints);
        final progress = GradeSystem.getProgressToNextGrade(currentPoints);
        final pointsToNext = GradeSystem.getPointsToNextGrade(currentPoints);
        
        return Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.05),
                blurRadius: 10,
                offset: const Offset(0, 5),
              ),
            ],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // í˜„ì¬ ë“±ê¸‰
              Row(
                children: [
                  Text(
                    currentGrade.emoji,
                    style: const TextStyle(fontSize: 40),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          currentGrade.name,
                          style: const TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          currentGrade.description,
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.grey[600],
                          ),
                        ),
                      ],
                    ),
                  ),
                  // í˜„ì¬ í¬ì¸íŠ¸
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        '$currentPoints',
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).primaryColor,
                        ),
                      ),
                      Text(
                        'í¬ì¸íŠ¸',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 16),
              
              // ì§„í–‰ë¥  ë°”
              if (currentGrade.level < GradeSystem.grades.length) ...[
                Row(
                  children: [
                    Expanded(
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: LinearProgressIndicator(
                          value: progress,
                          minHeight: 8,
                          backgroundColor: Colors.grey[200],
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Theme.of(context).primaryColor,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Text(
                      '${(progress * 100).toInt()}%',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).primaryColor,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  'ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€ $pointsToNext í¬ì¸íŠ¸',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey[600],
                  ),
                ),
              ] else ...[
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.amber[50],
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.star,
                        size: 16,
                        color: Colors.amber[700],
                      ),
                      const SizedBox(width: 4),
                      Text(
                        'ìµœê³  ë“±ê¸‰ ë‹¬ì„±!',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Colors.amber[700],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        );
      },
    );
  }
}
```

## 4. ì•Œë¦¼ ë° ì• ë‹ˆë©”ì´ì…˜

### [í•„ìˆ˜] ë“±ê¸‰ ìƒìŠ¹ ì¶•í•˜ í™”ë©´
```dart
// íŒŒì¼: lib/features/grade/screens/grade_upgrade_celebration_screen.dart
class GradeUpgradeCelebrationScreen extends StatefulWidget {
  final GradeUpgradeInfo upgradeInfo;
  
  const GradeUpgradeCelebrationScreen({
    Key? key,
    required this.upgradeInfo,
  }) : super(key: key);
  
  @override
  _GradeUpgradeCelebrationScreenState createState() => 
      _GradeUpgradeCelebrationScreenState();
}

class _GradeUpgradeCelebrationScreenState 
    extends State<GradeUpgradeCelebrationScreen>
    with TickerProviderStateMixin {
  late AnimationController _mainController;
  late AnimationController _particleController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _rotationAnimation;
  late Animation<double> _fadeAnimation;
  
  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _playSound();
    _hapticFeedback();
  }
  
  void _setupAnimations() {
    // ë©”ì¸ ì• ë‹ˆë©”ì´ì…˜
    _mainController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    );
    
    _scaleAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.0, 0.6, curve: Curves.elasticOut),
    ));
    
    _rotationAnimation = Tween<double>(
      begin: -0.5,
      end: 0.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.0, 0.8, curve: Curves.easeOutCubic),
    ));
    
    _fadeAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.3, 0.8),
    ));
    
    // íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜
    _particleController = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: this,
    )..repeat();
    
    _mainController.forward();
  }
  
  void _playSound() {
    // ì¶•í•˜ ì‚¬ìš´ë“œ ì¬ìƒ
    // SystemSound.play(SystemSoundType.click);
  }
  
  void _hapticFeedback() {
    HapticFeedback.mediumImpact();
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black.withOpacity(0.8),
      body: Stack(
        children: [
          // íŒŒí‹°í´ íš¨ê³¼
          AnimatedBuilder(
            animation: _particleController,
            builder: (context, child) {
              return CustomPaint(
                painter: ParticlePainter(
                  progress: _particleController.value,
                  particleCount: 50,
                ),
                size: Size.infinite,
              );
            },
          ),
          
          // ë©”ì¸ ì½˜í…ì¸ 
          Center(
            child: AnimatedBuilder(
              animation: _mainController,
              builder: (context, child) {
                return Transform.rotate(
                  angle: _rotationAnimation.value,
                  child: Transform.scale(
                    scale: _scaleAnimation.value,
                    child: Container(
                      width: 320,
                      padding: const EdgeInsets.all(32),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(24),
                        boxShadow: [
                          BoxShadow(
                            color: Theme.of(context).primaryColor.withOpacity(0.3),
                            blurRadius: 30,
                            spreadRadius: 10,
                          ),
                        ],
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // ì¶•í•˜ í…ìŠ¤íŠ¸
                          Text(
                            'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰',
                            style: TextStyle(
                              fontSize: 28,
                              fontWeight: FontWeight.bold,
                              color: Theme.of(context).primaryColor,
                            ),
                          ),
                          const SizedBox(height: 24),
                          
                          // ë“±ê¸‰ ë³€í™”
                          Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // ì´ì „ ë“±ê¸‰
                              Column(
                                children: [
                                  Text(
                                    widget.upgradeInfo.previousGrade.emoji,
                                    style: const TextStyle(fontSize: 60),
                                  ),
                                  Text(
                                    widget.upgradeInfo.previousGrade.name,
                                    style: TextStyle(
                                      fontSize: 16,
                                      color: Colors.grey[600],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(width: 24),
                              
                              // í™”ì‚´í‘œ
                              Icon(
                                Icons.arrow_forward,
                                size: 32,
                                color: Theme.of(context).primaryColor,
                              ),
                              const SizedBox(width: 24),
                              
                              // ìƒˆ ë“±ê¸‰
                              Column(
                                children: [
                                  Text(
                                    widget.upgradeInfo.newGrade.emoji,
                                    style: const TextStyle(fontSize: 80),
                                  ),
                                  Text(
                                    widget.upgradeInfo.newGrade.name,
                                    style: const TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                          const SizedBox(height: 32),
                          
                          // ì„¤ëª…
                          FadeTransition(
                            opacity: _fadeAnimation,
                            child: Column(
                              children: [
                                Text(
                                  widget.upgradeInfo.newGrade.description,
                                  textAlign: TextAlign.center,
                                  style: TextStyle(
                                    fontSize: 16,
                                    color: Colors.grey[700],
                                  ),
                                ),
                                const SizedBox(height: 24),
                                
                                // ìƒˆë¡œìš´ í˜œíƒ
                                Container(
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    color: Theme.of(context)
                                        .primaryColor
                                        .withOpacity(0.1),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        'ğŸ ìƒˆë¡œìš´ í˜œíƒ',
                                        style: TextStyle(
                                          fontSize: 16,
                                          fontWeight: FontWeight.bold,
                                          color: Theme.of(context).primaryColor,
                                        ),
                                      ),
                                      const SizedBox(height: 8),
                                      ...widget.upgradeInfo.newGrade.benefits
                                          .map((benefit) => Padding(
                                                padding: const EdgeInsets.symmetric(
                                                  vertical: 4,
                                                ),
                                                child: Row(
                                                  children: [
                                                    Icon(
                                                      Icons.check_circle,
                                                      size: 16,
                                                      color: Theme.of(context)
                                                          .primaryColor,
                                                    ),
                                                    const SizedBox(width: 8),
                                                    Text(
                                                      benefit,
                                                      style: const TextStyle(
                                                        fontSize: 14,
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                              )),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 32),
                          
                          // í™•ì¸ ë²„íŠ¼
                          ElevatedButton(
                            onPressed: () {
                              Navigator.of(context).pop();
                            },
                            style: ElevatedButton.styleFrom(
                              minimumSize: const Size(double.infinity, 56),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(28),
                              ),
                            ),
                            child: const Text(
                              'í™•ì¸',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
  
  @override
  void dispose() {
    _mainController.dispose();
    _particleController.dispose();
    super.dispose();
  }
}

// íŒŒí‹°í´ íš¨ê³¼ í˜ì¸í„°
class ParticlePainter extends CustomPainter {
  final double progress;
  final int particleCount;
  
  ParticlePainter({
    required this.progress,
    required this.particleCount,
  });
  
  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint();
    final random = Random(42); // ê³ ì • ì‹œë“œë¡œ ì¼ê´€ëœ íŒŒí‹°í´
    
    for (int i = 0; i < particleCount; i++) {
      final x = random.nextDouble() * size.width;
      final startY = size.height + 50;
      final endY = -50.0;
      final y = startY + (endY - startY) * progress;
      
      final opacity = 1.0 - progress;
      final hue = random.nextDouble() * 360;
      
      paint.color = HSVColor.fromAHSV(opacity, hue, 0.8, 1.0).toColor();
      
      final radius = random.nextDouble() * 10 + 5;
      canvas.drawCircle(Offset(x, y), radius, paint);
    }
  }
  
  @override
  bool shouldRepaint(ParticlePainter oldDelegate) => true;
}
```

## 5. ê¶Œí•œ ë³€ê²½ í™•ì¸

### [í•„ìˆ˜] ë“±ê¸‰ë³„ ê¶Œí•œ ê´€ë¦¬
```dart
// íŒŒì¼: lib/features/grade/managers/grade_permission_manager.dart
class GradePermissionManager {
  static final GradePermissionManager _instance = GradePermissionManager._internal();
  factory GradePermissionManager() => _instance;
  GradePermissionManager._internal();
  
  /// ë“±ê¸‰ë³„ ê¶Œí•œ í™•ì¸
  static Map<String, bool> getPermissions(Grade grade) {
    final permissions = <String, bool>{
      'basic_feed_creation': true, // ëª¨ë“  ë“±ê¸‰
      'recommendation': true, // ëª¨ë“  ë“±ê¸‰
      'tag_limit_5': grade.level >= 2, // ë¹„ë¹”ë°¥ë¶€í„°
      'weekly_bonus': grade.level >= 2,
      'profile_badge': grade.level >= 3, // ì‚¼ê²¹ì‚´ë¶€í„°
      'monthly_ranking': grade.level >= 3,
      'feed_highlight': grade.level >= 4, // ê°ˆë¹„íƒ•ë¶€í„°
      'special_events': grade.level >= 4,
      'premium_filters': grade.level >= 5, // ëª¨ë‘ íšŒë¶€í„°
      'vote_restaurant': grade.level >= 5,
      'vip_badge': grade.level >= 6, // ì”ì¹«ìƒë¶€í„°
      'priority_exposure': grade.level >= 6,
      'location_sharing': grade.level >= 7, // ìˆ˜ëìƒë¶€í„°
      'influencer_candidate': grade.level >= 7,
    };
    
    return permissions;
  }
  
  /// ìƒˆë¡œ í™œì„±í™”ëœ ê¶Œí•œ í™•ì¸
  static List<String> getNewPermissions(Grade previousGrade, Grade newGrade) {
    final previousPermissions = getPermissions(previousGrade);
    final newPermissions = getPermissions(newGrade);
    
    final newlyEnabled = <String>[];
    
    newPermissions.forEach((key, value) {
      if (value && !previousPermissions[key]!) {
        newlyEnabled.add(key);
      }
    });
    
    return newlyEnabled;
  }
  
  /// ê¶Œí•œ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
  static String getPermissionDescription(String permission) {
    final descriptions = {
      'basic_feed_creation': 'í”¼ë“œ ë“±ë¡',
      'recommendation': 'ì¶”ì²œ ê¸°ëŠ¥',
      'tag_limit_5': 'íƒœê·¸ 5ê°œê¹Œì§€ ì‚¬ìš©',
      'weekly_bonus': 'ì£¼ê°„ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸',
      'profile_badge': 'í”„ë¡œí•„ ë“±ê¸‰ ë±ƒì§€',
      'monthly_ranking': 'ì›”ê°„ ë­í‚¹ ì°¸ì—¬',
      'feed_highlight': 'í”¼ë“œ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼',
      'special_events': 'íŠ¹ë³„ ì´ë²¤íŠ¸ ì°¸ì—¬',
      'premium_filters': 'í”„ë¦¬ë¯¸ì—„ ê²€ìƒ‰ í•„í„°',
      'vote_restaurant': 'ë§›ì§‘ ì¸ì¦ íˆ¬í‘œê¶Œ',
      'vip_badge': 'VIP ë±ƒì§€ í‘œì‹œ',
      'priority_exposure': 'ìš°ì„  ë…¸ì¶œ í˜œíƒ',
      'location_sharing': 'ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ ',
      'influencer_candidate': 'ì¸í”Œë£¨ì–¸ì„œ í›„ë³´ ìê²©',
    };
    
    return descriptions[permission] ?? permission;
  }
  
  /// ê¶Œí•œ ì²´í¬
  static Future<bool> checkPermission(String userId, String permission) async {
    try {
      final response = await Supabase.instance.client
          .from('users')
          .select('activity_score')
          .eq('id', userId)
          .single();
      
      final points = response['activity_score'] ?? 0;
      final grade = GradeSystem.getGradeByPoints(points);
      final permissions = getPermissions(grade);
      
      return permissions[permission] ?? false;
    } catch (e) {
      print('Error checking permission: $e');
      return false;
    }
  }
}

/// ê¶Œí•œ ì²´í¬ ìœ„ì ¯
class PermissionGate extends StatelessWidget {
  final String permission;
  final String userId;
  final Widget child;
  final Widget? lockedWidget;
  
  const PermissionGate({
    Key? key,
    required this.permission,
    required this.userId,
    required this.child,
    this.lockedWidget,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return FutureBuilder<bool>(
      future: GradePermissionManager.checkPermission(userId, permission),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return const Center(child: CircularProgressIndicator());
        }
        
        final hasPermission = snapshot.data!;
        
        if (hasPermission) {
          return child;
        }
        
        return lockedWidget ?? _buildDefaultLockedWidget(context);
      },
    );
  }
  
  Widget _buildDefaultLockedWidget(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            Icons.lock_outline,
            size: 48,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          Text(
            'ì´ ê¸°ëŠ¥ì€ ë” ë†’ì€ ë“±ê¸‰ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤',
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 16,
              color: Colors.grey[700],
            ),
          ),
          const SizedBox(height: 8),
          Text(
            GradePermissionManager.getPermissionDescription(permission),
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[600],
            ),
          ),
        ],
      ),
    );
  }
}
```

## 6. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] í™œë™ë³„ í¬ì¸íŠ¸ ì •ìƒ íšë“
- [ ] í¬ì¸íŠ¸ ì•Œë¦¼ í‘œì‹œ
- [ ] ë“±ê¸‰ ìƒìŠ¹ ì¡°ê±´ ì¶©ì¡± ì‹œ ìë™ ìƒìŠ¹
- [ ] ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
- [ ] ìƒˆ ê¶Œí•œ í™œì„±í™” í™•ì¸
- [ ] ë“±ê¸‰ íˆìŠ¤í† ë¦¬ ê¸°ë¡

### ğŸ§ª ë“±ê¸‰ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
```dart
// íŒŒì¼: test/grade/grade_system_test.dart
void main() {
  group('ë“±ê¸‰ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸', () {
    test('í¬ì¸íŠ¸ë³„ ë“±ê¸‰ ê³„ì‚°', () {
      expect(GradeSystem.getGradeByPoints(0).name, 'ëˆ„ë£½ì§€');
      expect(GradeSystem.getGradeByPoints(99).name, 'ëˆ„ë£½ì§€');
      expect(GradeSystem.getGradeByPoints(100).name, 'ë¹„ë¹”ë°¥');
      expect(GradeSystem.getGradeByPoints(2500).name, 'ìˆ˜ëìƒ');
    });
    
    test('ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€ í•„ìš” í¬ì¸íŠ¸', () {
      expect(GradeSystem.getPointsToNextGrade(50), 50);
      expect(GradeSystem.getPointsToNextGrade(150), 150);
      expect(GradeSystem.getPointsToNextGrade(2500), 0);
    });
    
    test('ì§„í–‰ë¥  ê³„ì‚°', () {
      expect(GradeSystem.getProgressToNextGrade(0), 0.0);
      expect(GradeSystem.getProgressToNextGrade(50), 0.5);
      expect(GradeSystem.getProgressToNextGrade(100), 0.0);
      expect(GradeSystem.getProgressToNextGrade(200), 0.5);
    });
  });
  
  group('ê¶Œí•œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸', () {
    test('ë“±ê¸‰ë³„ ê¶Œí•œ í™•ì¸', () {
      final grade1 = GradeSystem.grades[0]; // ëˆ„ë£½ì§€
      final permissions1 = GradePermissionManager.getPermissions(grade1);
      expect(permissions1['basic_feed_creation'], true);
      expect(permissions1['tag_limit_5'], false);
      
      final grade7 = GradeSystem.grades[6]; // ìˆ˜ëìƒ
      final permissions7 = GradePermissionManager.getPermissions(grade7);
      expect(permissions7['location_sharing'], true);
      expect(permissions7['influencer_candidate'], true);
    });
    
    test('ìƒˆë¡œìš´ ê¶Œí•œ í™•ì¸', () {
      final grade1 = GradeSystem.grades[0];
      final grade2 = GradeSystem.grades[1];
      
      final newPermissions = GradePermissionManager.getNewPermissions(
        grade1,
        grade2,
      );
      
      expect(newPermissions.contains('tag_limit_5'), true);
      expect(newPermissions.contains('weekly_bonus'), true);
    });
  });
}
```