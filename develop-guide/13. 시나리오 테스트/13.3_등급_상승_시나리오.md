# 🏆 13.3 등급 상승 시나리오

## 📋 목차
1. [개요](#1-개요)
2. [포인트 획득 과정](#2-포인트-획득-과정)
3. [등급 상승 조건](#3-등급-상승-조건)
4. [알림 및 애니메이션](#4-알림-및-애니메이션)
5. [권한 변경 확인](#5-권한-변경-확인)
6. [검증](#6-검증)

## 1. 개요
사용자의 활동에 따른 포인트 획득부터 등급 상승, 그에 따른 권한 변경까지의 전체 시나리오를 구현합니다.

### 📌 핵심 포인트
- ✅ 활동별 포인트 체계
- ✅ 등급별 필요 포인트
- ✅ 상승 시 축하 애니메이션
- ✅ 새로운 권한 안내

## 2. 포인트 획득 과정

### [필수] 포인트 시스템 관리자
```dart
// 파일: lib/features/grade/managers/point_manager.dart
import 'package:supabase_flutter/supabase_flutter.dart';

class PointManager {
  static final PointManager _instance = PointManager._internal();
  factory PointManager() => _instance;
  PointManager._internal();

  final SupabaseClient _supabase = Supabase.instance.client;
  
  /// 포인트 획득 유형
  static const Map<PointType, int> pointValues = {
    PointType.feedCreation: 10,
    PointType.firstFeedBonus: 50,
    PointType.detailedInfo: 5,
    PointType.receiptVerification: 10,
    PointType.recommendation: 2,
    PointType.receivedRecommendation: 1,
    PointType.dailyLogin: 5,
    PointType.weeklyBonus: 20,
  };
  
  /// 포인트 획득
  Future<PointTransaction> earnPoints({
    required String userId,
    required PointType type,
    Map<String, dynamic>? metadata,
  }) async {
    try {
      // 포인트 값 계산
      int points = pointValues[type] ?? 0;
      
      // 특별 보너스 계산
      if (metadata?['isFirstPost'] == true) {
        points += pointValues[PointType.firstFeedBonus]!;
      }
      
      // 트랜잭션 생성
      final transaction = PointTransaction(
        userId: userId,
        type: type,
        points: points,
        timestamp: DateTime.now(),
        metadata: metadata,
      );
      
      // Supabase 트랜잭션으로 안전하게 업데이트
      await _supabase.rpc('update_user_points', params: {
        'p_user_id': userId,
        'p_points': points,
        'p_transaction_type': type.toString(),
        'p_metadata': metadata,
      }).then((result) async {
        // 사용자 현재 점수 가져오기
        final userResponse = await _supabase
            .from('users')
            .select('total_points, activity_score')
            .eq('id', userId)
            .single();
        
        final currentPoints = userResponse['total_points'] ?? 0;
        final currentActivityScore = userResponse['activity_score'] ?? 0;
        
        // 등급 확인
        final gradeInfo = await _checkGradeUpgrade(
          userId: userId,
          currentPoints: currentActivityScore - points,
          newPoints: currentActivityScore,
        );
        
        transaction.gradeUpgrade = gradeInfo;
      });
      
      // 로컬 알림 발생
      _notifyPointEarned(transaction);
      
      return transaction;
      
    } catch (e) {
      print('Error earning points: $e');
      rethrow;
    }
  }
  
  /// 등급 상승 확인
  Future<GradeUpgradeInfo?> _checkGradeUpgrade({
    required String userId,
    required int currentPoints,
    required int newPoints,
  }) async {
    final currentGrade = GradeSystem.getGradeByPoints(currentPoints);
    final newGrade = GradeSystem.getGradeByPoints(newPoints);
    
    if (currentGrade.level < newGrade.level) {
      // 등급 상승!
      await _supabase
          .from('users')
          .update({
            'grade': newGrade.name,
            'grade_level': newGrade.level,
            'grade_updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', userId);
      
      // 등급 상승 기록
      await _supabase
          .from('grade_history')
          .insert({
            'user_id': userId,
            'from_grade': currentGrade.name,
            'to_grade': newGrade.name,
            'timestamp': DateTime.now().toIso8601String(),
            'points_at_upgrade': newPoints,
          });
      
      return GradeUpgradeInfo(
        previousGrade: currentGrade,
        newGrade: newGrade,
        timestamp: DateTime.now(),
      );
    }
    
    return null;
  }
  
  /// 포인트 획득 알림
  void _notifyPointEarned(PointTransaction transaction) {
    // 이벤트 발생
    PointEventBus().notify(transaction);
  }
  
  /// 포인트 기록 조회
  Stream<List<PointTransaction>> getPointHistory(String userId) {
    return _supabase
        .from('point_history')
        .stream(primaryKey: ['id'])
        .eq('user_id', userId)
        .order('timestamp', ascending: false)
        .limit(50)
        .map((data) => data
            .map((json) => PointTransaction.fromMap(json))
            .toList());
  }
  
  /// 일일 포인트 획듍 제한 확인
  Future<bool> checkDailyLimit(String userId, PointType type) async {
    final today = DateTime.now();
    final startOfDay = DateTime(today.year, today.month, today.day);
    
    final response = await _supabase
        .from('point_history')
        .select('id')
        .eq('user_id', userId)
        .eq('type', type.toString())
        .gte('timestamp', startOfDay.toIso8601String())
    
    // 활동별 일일 제한
    final dailyLimits = {
      PointType.feedCreation: 10,
      PointType.recommendation: 50,
      PointType.dailyLogin: 1,
    };
    
    final limit = dailyLimits[type] ?? 999;
    return response.length < limit;
  }
}

enum PointType {
  feedCreation,
  firstFeedBonus,
  detailedInfo,
  receiptVerification,
  recommendation,
  receivedRecommendation,
  dailyLogin,
  weeklyBonus,
}

class PointTransaction {
  final String userId;
  final PointType type;
  final int points;
  final DateTime timestamp;
  final Map<String, dynamic>? metadata;
  GradeUpgradeInfo? gradeUpgrade;
  
  PointTransaction({
    required this.userId,
    required this.type,
    required this.points,
    required this.timestamp,
    this.metadata,
    this.gradeUpgrade,
  });
  
  Map<String, dynamic> toMap() => {
    'userId': userId,
    'type': type.toString(),
    'points': points,
    'timestamp': timestamp,
    'metadata': metadata,
  };
  
  factory PointTransaction.fromMap(Map<String, dynamic> map) => PointTransaction(
    userId: map['user_id'],
    type: PointType.values.firstWhere(
      (e) => e.toString() == map['type'],
    ),
    points: map['points'],
    timestamp: DateTime.parse(map['timestamp']),
    metadata: map['metadata'],
  );
}
```

### [필수] 포인트 이벤트 시스템
```dart
// 파일: lib/features/grade/events/point_event_bus.dart
import 'dart:async';

class PointEventBus {
  static final PointEventBus _instance = PointEventBus._internal();
  factory PointEventBus() => _instance;
  PointEventBus._internal();
  
  final _controller = StreamController<PointTransaction>.broadcast();
  
  Stream<PointTransaction> get stream => _controller.stream;
  
  void notify(PointTransaction transaction) {
    _controller.add(transaction);
  }
  
  void dispose() {
    _controller.close();
  }
}

/// 포인트 획득 UI 위젯
class PointNotificationWidget extends StatefulWidget {
  final Widget child;
  
  const PointNotificationWidget({
    Key? key,
    required this.child,
  }) : super(key: key);
  
  @override
  _PointNotificationWidgetState createState() => _PointNotificationWidgetState();
}

class _PointNotificationWidgetState extends State<PointNotificationWidget>
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;
  
  StreamSubscription? _subscription;
  PointTransaction? _currentTransaction;
  Timer? _hideTimer;
  
  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _listenToPointEvents();
  }
  
  void _setupAnimations() {
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );
    
    _slideAnimation = Tween<double>(
      begin: -100,
      end: 0,
    ).animate(CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeOutCubic,
    ));
    
    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeIn,
    ));
  }
  
  void _listenToPointEvents() {
    _subscription = PointEventBus().stream.listen((transaction) {
      setState(() {
        _currentTransaction = transaction;
      });
      
      _animationController.forward();
      
      // 3초 후 자동으로 숨김
      _hideTimer?.cancel();
      _hideTimer = Timer(const Duration(seconds: 3), () {
        _hideTransaction();
      });
    });
  }
  
  void _hideTransaction() {
    _animationController.reverse().then((_) {
      if (mounted) {
        setState(() {
          _currentTransaction = null;
        });
      }
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        widget.child,
        
        // 포인트 알림
        if (_currentTransaction != null)
          Positioned(
            top: MediaQuery.of(context).padding.top + 20,
            left: 20,
            right: 20,
            child: AnimatedBuilder(
              animation: _animationController,
              builder: (context, child) {
                return Transform.translate(
                  offset: Offset(0, _slideAnimation.value),
                  child: FadeTransition(
                    opacity: _fadeAnimation,
                    child: _buildNotification(_currentTransaction!),
                  ),
                );
              },
            ),
          ),
      ],
    );
  }
  
  Widget _buildNotification(PointTransaction transaction) {
    return GestureDetector(
      onTap: _hideTransaction,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 10,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              width: 48,
              height: 48,
              decoration: BoxDecoration(
                color: Theme.of(context).primaryColor.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.stars,
                color: Theme.of(context).primaryColor,
                size: 24,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    _getPointMessage(transaction.type),
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '+${transaction.points} 포인트',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).primaryColor,
                    ),
                  ),
                ],
              ),
            ),
            if (transaction.gradeUpgrade != null)
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: Colors.amber,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: const Text(
                  '등급 UP!',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
  
  String _getPointMessage(PointType type) {
    switch (type) {
      case PointType.feedCreation:
        return '피드 등록';
      case PointType.firstFeedBonus:
        return '첫 등록 보너스';
      case PointType.detailedInfo:
        return '상세 정보 제공';
      case PointType.receiptVerification:
        return '영수증 인증';
      case PointType.recommendation:
        return '추천하기';
      case PointType.receivedRecommendation:
        return '추천받기';
      case PointType.dailyLogin:
        return '일일 출석';
      case PointType.weeklyBonus:
        return '주간 보너스';
    }
  }
  
  @override
  void dispose() {
    _subscription?.cancel();
    _hideTimer?.cancel();
    _animationController.dispose();
    super.dispose();
  }
}
```

## 3. 등급 상승 조건

### [필수] 등급 시스템 정의
```dart
// 파일: lib/features/grade/models/grade_system.dart
class GradeSystem {
  static const List<Grade> grades = [
    Grade(
      level: 1,
      name: '누룽지',
      emoji: '🍘',
      requiredPoints: 0,
      description: '구수하고 담백한 맛의 시작점',
      benefits: ['기본 피드 등록', '추천 기능'],
    ),
    Grade(
      level: 2,
      name: '비빔밥',
      emoji: '🥗',
      requiredPoints: 100,
      description: '다양한 재료가 어우러진 조화',
      benefits: ['태그 5개 사용', '주간 보너스 포인트'],
    ),
    Grade(
      level: 3,
      name: '삼겹살',
      emoji: '🥓',
      requiredPoints: 300,
      description: '세계적으로 알려진 K-바베큐의 정수',
      benefits: ['프로필 뱃지', '월간 랭킹 참여'],
    ),
    Grade(
      level: 4,
      name: '갈비탕',
      emoji: '🍲',
      requiredPoints: 600,
      description: '진한 육수의 깊이를 아는 단계',
      benefits: ['피드 하이라이트', '특별 이벤트 참여'],
    ),
    Grade(
      level: 5,
      name: '모둠회',
      emoji: '🐟',
      requiredPoints: 1000,
      description: '신선한 식재료의 본연의 맛',
      benefits: ['프리미엄 필터', '맛집 인증 투표권'],
    ),
    Grade(
      level: 6,
      name: '잔칫상',
      emoji: '🎊',
      requiredPoints: 1500,
      description: '풍성하고 다채로운 구성의 상차림',
      benefits: ['VIP 뱃지', '우선 노출'],
    ),
    Grade(
      level: 7,
      name: '수랏상',
      emoji: '👑',
      requiredPoints: 2500,
      description: '궁중 요리의 절정',
      benefits: ['위치 공유 기능', '인플루언서 후보'],
    ),
  ];
  
  /// 포인트로 등급 확인
  static Grade getGradeByPoints(int points) {
    for (int i = grades.length - 1; i >= 0; i--) {
      if (points >= grades[i].requiredPoints) {
        return grades[i];
      }
    }
    return grades.first;
  }
  
  /// 다음 등급까지 필요한 포인트
  static int getPointsToNextGrade(int currentPoints) {
    final currentGrade = getGradeByPoints(currentPoints);
    if (currentGrade.level >= grades.length) {
      return 0; // 최고 등급
    }
    
    final nextGrade = grades[currentGrade.level];
    return nextGrade.requiredPoints - currentPoints;
  }
  
  /// 진행률 계산 (0.0 ~ 1.0)
  static double getProgressToNextGrade(int currentPoints) {
    final currentGrade = getGradeByPoints(currentPoints);
    if (currentGrade.level >= grades.length) {
      return 1.0; // 최고 등급
    }
    
    final nextGrade = grades[currentGrade.level];
    final currentGradePoints = currentGrade.requiredPoints;
    final nextGradePoints = nextGrade.requiredPoints;
    
    final progress = (currentPoints - currentGradePoints) / 
                    (nextGradePoints - currentGradePoints);
    
    return progress.clamp(0.0, 1.0);
  }
}

class Grade {
  final int level;
  final String name;
  final String emoji;
  final int requiredPoints;
  final String description;
  final List<String> benefits;
  
  const Grade({
    required this.level,
    required this.name,
    required this.emoji,
    required this.requiredPoints,
    required this.description,
    required this.benefits,
  });
}

class GradeUpgradeInfo {
  final Grade previousGrade;
  final Grade newGrade;
  final DateTime timestamp;
  
  GradeUpgradeInfo({
    required this.previousGrade,
    required this.newGrade,
    required this.timestamp,
  });
}
```

### [필수] 등급 상태 위젯
```dart
// 파일: lib/features/grade/widgets/grade_status_widget.dart
class GradeStatusWidget extends StatelessWidget {
  final String userId;
  
  const GradeStatusWidget({
    Key? key,
    required this.userId,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<Map<String, dynamic>>(
      stream: Supabase.instance.client
          .from('users')
          .stream(primaryKey: ['id'])
          .eq('id', userId)
          .map((data) => data.first),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return const SizedBox.shrink();
        }
        
        final userData = snapshot.data!;
        final currentPoints = userData['activity_score'] ?? 0;
        final currentGrade = GradeSystem.getGradeByPoints(currentPoints);
        final progress = GradeSystem.getProgressToNextGrade(currentPoints);
        final pointsToNext = GradeSystem.getPointsToNextGrade(currentPoints);
        
        return Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.05),
                blurRadius: 10,
                offset: const Offset(0, 5),
              ),
            ],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // 현재 등급
              Row(
                children: [
                  Text(
                    currentGrade.emoji,
                    style: const TextStyle(fontSize: 40),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          currentGrade.name,
                          style: const TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          currentGrade.description,
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.grey[600],
                          ),
                        ),
                      ],
                    ),
                  ),
                  // 현재 포인트
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        '$currentPoints',
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).primaryColor,
                        ),
                      ),
                      Text(
                        '포인트',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 16),
              
              // 진행률 바
              if (currentGrade.level < GradeSystem.grades.length) ...[
                Row(
                  children: [
                    Expanded(
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: LinearProgressIndicator(
                          value: progress,
                          minHeight: 8,
                          backgroundColor: Colors.grey[200],
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Theme.of(context).primaryColor,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Text(
                      '${(progress * 100).toInt()}%',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).primaryColor,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  '다음 등급까지 $pointsToNext 포인트',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey[600],
                  ),
                ),
              ] else ...[
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.amber[50],
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.star,
                        size: 16,
                        color: Colors.amber[700],
                      ),
                      const SizedBox(width: 4),
                      Text(
                        '최고 등급 달성!',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Colors.amber[700],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        );
      },
    );
  }
}
```

## 4. 알림 및 애니메이션

### [필수] 등급 상승 축하 화면
```dart
// 파일: lib/features/grade/screens/grade_upgrade_celebration_screen.dart
class GradeUpgradeCelebrationScreen extends StatefulWidget {
  final GradeUpgradeInfo upgradeInfo;
  
  const GradeUpgradeCelebrationScreen({
    Key? key,
    required this.upgradeInfo,
  }) : super(key: key);
  
  @override
  _GradeUpgradeCelebrationScreenState createState() => 
      _GradeUpgradeCelebrationScreenState();
}

class _GradeUpgradeCelebrationScreenState 
    extends State<GradeUpgradeCelebrationScreen>
    with TickerProviderStateMixin {
  late AnimationController _mainController;
  late AnimationController _particleController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _rotationAnimation;
  late Animation<double> _fadeAnimation;
  
  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _playSound();
    _hapticFeedback();
  }
  
  void _setupAnimations() {
    // 메인 애니메이션
    _mainController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    );
    
    _scaleAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.0, 0.6, curve: Curves.elasticOut),
    ));
    
    _rotationAnimation = Tween<double>(
      begin: -0.5,
      end: 0.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.0, 0.8, curve: Curves.easeOutCubic),
    ));
    
    _fadeAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _mainController,
      curve: const Interval(0.3, 0.8),
    ));
    
    // 파티클 애니메이션
    _particleController = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: this,
    )..repeat();
    
    _mainController.forward();
  }
  
  void _playSound() {
    // 축하 사운드 재생
    // SystemSound.play(SystemSoundType.click);
  }
  
  void _hapticFeedback() {
    HapticFeedback.mediumImpact();
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black.withOpacity(0.8),
      body: Stack(
        children: [
          // 파티클 효과
          AnimatedBuilder(
            animation: _particleController,
            builder: (context, child) {
              return CustomPaint(
                painter: ParticlePainter(
                  progress: _particleController.value,
                  particleCount: 50,
                ),
                size: Size.infinite,
              );
            },
          ),
          
          // 메인 콘텐츠
          Center(
            child: AnimatedBuilder(
              animation: _mainController,
              builder: (context, child) {
                return Transform.rotate(
                  angle: _rotationAnimation.value,
                  child: Transform.scale(
                    scale: _scaleAnimation.value,
                    child: Container(
                      width: 320,
                      padding: const EdgeInsets.all(32),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(24),
                        boxShadow: [
                          BoxShadow(
                            color: Theme.of(context).primaryColor.withOpacity(0.3),
                            blurRadius: 30,
                            spreadRadius: 10,
                          ),
                        ],
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // 축하 텍스트
                          Text(
                            '🎉 축하합니다! 🎉',
                            style: TextStyle(
                              fontSize: 28,
                              fontWeight: FontWeight.bold,
                              color: Theme.of(context).primaryColor,
                            ),
                          ),
                          const SizedBox(height: 24),
                          
                          // 등급 변화
                          Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // 이전 등급
                              Column(
                                children: [
                                  Text(
                                    widget.upgradeInfo.previousGrade.emoji,
                                    style: const TextStyle(fontSize: 60),
                                  ),
                                  Text(
                                    widget.upgradeInfo.previousGrade.name,
                                    style: TextStyle(
                                      fontSize: 16,
                                      color: Colors.grey[600],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(width: 24),
                              
                              // 화살표
                              Icon(
                                Icons.arrow_forward,
                                size: 32,
                                color: Theme.of(context).primaryColor,
                              ),
                              const SizedBox(width: 24),
                              
                              // 새 등급
                              Column(
                                children: [
                                  Text(
                                    widget.upgradeInfo.newGrade.emoji,
                                    style: const TextStyle(fontSize: 80),
                                  ),
                                  Text(
                                    widget.upgradeInfo.newGrade.name,
                                    style: const TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                          const SizedBox(height: 32),
                          
                          // 설명
                          FadeTransition(
                            opacity: _fadeAnimation,
                            child: Column(
                              children: [
                                Text(
                                  widget.upgradeInfo.newGrade.description,
                                  textAlign: TextAlign.center,
                                  style: TextStyle(
                                    fontSize: 16,
                                    color: Colors.grey[700],
                                  ),
                                ),
                                const SizedBox(height: 24),
                                
                                // 새로운 혜택
                                Container(
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    color: Theme.of(context)
                                        .primaryColor
                                        .withOpacity(0.1),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        '🎁 새로운 혜택',
                                        style: TextStyle(
                                          fontSize: 16,
                                          fontWeight: FontWeight.bold,
                                          color: Theme.of(context).primaryColor,
                                        ),
                                      ),
                                      const SizedBox(height: 8),
                                      ...widget.upgradeInfo.newGrade.benefits
                                          .map((benefit) => Padding(
                                                padding: const EdgeInsets.symmetric(
                                                  vertical: 4,
                                                ),
                                                child: Row(
                                                  children: [
                                                    Icon(
                                                      Icons.check_circle,
                                                      size: 16,
                                                      color: Theme.of(context)
                                                          .primaryColor,
                                                    ),
                                                    const SizedBox(width: 8),
                                                    Text(
                                                      benefit,
                                                      style: const TextStyle(
                                                        fontSize: 14,
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                              )),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 32),
                          
                          // 확인 버튼
                          ElevatedButton(
                            onPressed: () {
                              Navigator.of(context).pop();
                            },
                            style: ElevatedButton.styleFrom(
                              minimumSize: const Size(double.infinity, 56),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(28),
                              ),
                            ),
                            child: const Text(
                              '확인',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
  
  @override
  void dispose() {
    _mainController.dispose();
    _particleController.dispose();
    super.dispose();
  }
}

// 파티클 효과 페인터
class ParticlePainter extends CustomPainter {
  final double progress;
  final int particleCount;
  
  ParticlePainter({
    required this.progress,
    required this.particleCount,
  });
  
  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint();
    final random = Random(42); // 고정 시드로 일관된 파티클
    
    for (int i = 0; i < particleCount; i++) {
      final x = random.nextDouble() * size.width;
      final startY = size.height + 50;
      final endY = -50.0;
      final y = startY + (endY - startY) * progress;
      
      final opacity = 1.0 - progress;
      final hue = random.nextDouble() * 360;
      
      paint.color = HSVColor.fromAHSV(opacity, hue, 0.8, 1.0).toColor();
      
      final radius = random.nextDouble() * 10 + 5;
      canvas.drawCircle(Offset(x, y), radius, paint);
    }
  }
  
  @override
  bool shouldRepaint(ParticlePainter oldDelegate) => true;
}
```

## 5. 권한 변경 확인

### [필수] 등급별 권한 관리
```dart
// 파일: lib/features/grade/managers/grade_permission_manager.dart
class GradePermissionManager {
  static final GradePermissionManager _instance = GradePermissionManager._internal();
  factory GradePermissionManager() => _instance;
  GradePermissionManager._internal();
  
  /// 등급별 권한 확인
  static Map<String, bool> getPermissions(Grade grade) {
    final permissions = <String, bool>{
      'basic_feed_creation': true, // 모든 등급
      'recommendation': true, // 모든 등급
      'tag_limit_5': grade.level >= 2, // 비빔밥부터
      'weekly_bonus': grade.level >= 2,
      'profile_badge': grade.level >= 3, // 삼겹살부터
      'monthly_ranking': grade.level >= 3,
      'feed_highlight': grade.level >= 4, // 갈비탕부터
      'special_events': grade.level >= 4,
      'premium_filters': grade.level >= 5, // 모둠회부터
      'vote_restaurant': grade.level >= 5,
      'vip_badge': grade.level >= 6, // 잔칫상부터
      'priority_exposure': grade.level >= 6,
      'location_sharing': grade.level >= 7, // 수랏상부터
      'influencer_candidate': grade.level >= 7,
    };
    
    return permissions;
  }
  
  /// 새로 활성화된 권한 확인
  static List<String> getNewPermissions(Grade previousGrade, Grade newGrade) {
    final previousPermissions = getPermissions(previousGrade);
    final newPermissions = getPermissions(newGrade);
    
    final newlyEnabled = <String>[];
    
    newPermissions.forEach((key, value) {
      if (value && !previousPermissions[key]!) {
        newlyEnabled.add(key);
      }
    });
    
    return newlyEnabled;
  }
  
  /// 권한 설명 가져오기
  static String getPermissionDescription(String permission) {
    final descriptions = {
      'basic_feed_creation': '피드 등록',
      'recommendation': '추천 기능',
      'tag_limit_5': '태그 5개까지 사용',
      'weekly_bonus': '주간 보너스 포인트',
      'profile_badge': '프로필 등급 뱃지',
      'monthly_ranking': '월간 랭킹 참여',
      'feed_highlight': '피드 하이라이트 효과',
      'special_events': '특별 이벤트 참여',
      'premium_filters': '프리미엄 검색 필터',
      'vote_restaurant': '맛집 인증 투표권',
      'vip_badge': 'VIP 뱃지 표시',
      'priority_exposure': '우선 노출 혜택',
      'location_sharing': '실시간 위치 공유',
      'influencer_candidate': '인플루언서 후보 자격',
    };
    
    return descriptions[permission] ?? permission;
  }
  
  /// 권한 체크
  static Future<bool> checkPermission(String userId, String permission) async {
    try {
      final response = await Supabase.instance.client
          .from('users')
          .select('activity_score')
          .eq('id', userId)
          .single();
      
      final points = response['activity_score'] ?? 0;
      final grade = GradeSystem.getGradeByPoints(points);
      final permissions = getPermissions(grade);
      
      return permissions[permission] ?? false;
    } catch (e) {
      print('Error checking permission: $e');
      return false;
    }
  }
}

/// 권한 체크 위젯
class PermissionGate extends StatelessWidget {
  final String permission;
  final String userId;
  final Widget child;
  final Widget? lockedWidget;
  
  const PermissionGate({
    Key? key,
    required this.permission,
    required this.userId,
    required this.child,
    this.lockedWidget,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    return FutureBuilder<bool>(
      future: GradePermissionManager.checkPermission(userId, permission),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return const Center(child: CircularProgressIndicator());
        }
        
        final hasPermission = snapshot.data!;
        
        if (hasPermission) {
          return child;
        }
        
        return lockedWidget ?? _buildDefaultLockedWidget(context);
      },
    );
  }
  
  Widget _buildDefaultLockedWidget(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            Icons.lock_outline,
            size: 48,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          Text(
            '이 기능은 더 높은 등급에서 사용할 수 있습니다',
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 16,
              color: Colors.grey[700],
            ),
          ),
          const SizedBox(height: 8),
          Text(
            GradePermissionManager.getPermissionDescription(permission),
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[600],
            ),
          ),
        ],
      ),
    );
  }
}
```

## 6. 검증

### ✅ 체크리스트
- [ ] 활동별 포인트 정상 획득
- [ ] 포인트 알림 표시
- [ ] 등급 상승 조건 충족 시 자동 상승
- [ ] 축하 애니메이션 재생
- [ ] 새 권한 활성화 확인
- [ ] 등급 히스토리 기록

### 🧪 등급 시스템 테스트
```dart
// 파일: test/grade/grade_system_test.dart
void main() {
  group('등급 시스템 테스트', () {
    test('포인트별 등급 계산', () {
      expect(GradeSystem.getGradeByPoints(0).name, '누룽지');
      expect(GradeSystem.getGradeByPoints(99).name, '누룽지');
      expect(GradeSystem.getGradeByPoints(100).name, '비빔밥');
      expect(GradeSystem.getGradeByPoints(2500).name, '수랏상');
    });
    
    test('다음 등급까지 필요 포인트', () {
      expect(GradeSystem.getPointsToNextGrade(50), 50);
      expect(GradeSystem.getPointsToNextGrade(150), 150);
      expect(GradeSystem.getPointsToNextGrade(2500), 0);
    });
    
    test('진행률 계산', () {
      expect(GradeSystem.getProgressToNextGrade(0), 0.0);
      expect(GradeSystem.getProgressToNextGrade(50), 0.5);
      expect(GradeSystem.getProgressToNextGrade(100), 0.0);
      expect(GradeSystem.getProgressToNextGrade(200), 0.5);
    });
  });
  
  group('권한 시스템 테스트', () {
    test('등급별 권한 확인', () {
      final grade1 = GradeSystem.grades[0]; // 누룽지
      final permissions1 = GradePermissionManager.getPermissions(grade1);
      expect(permissions1['basic_feed_creation'], true);
      expect(permissions1['tag_limit_5'], false);
      
      final grade7 = GradeSystem.grades[6]; // 수랏상
      final permissions7 = GradePermissionManager.getPermissions(grade7);
      expect(permissions7['location_sharing'], true);
      expect(permissions7['influencer_candidate'], true);
    });
    
    test('새로운 권한 확인', () {
      final grade1 = GradeSystem.grades[0];
      final grade2 = GradeSystem.grades[1];
      
      final newPermissions = GradePermissionManager.getNewPermissions(
        grade1,
        grade2,
      );
      
      expect(newPermissions.contains('tag_limit_5'), true);
      expect(newPermissions.contains('weekly_bonus'), true);
    });
  });
}
```