# ğŸš« 13.7 ì°¨ë‹¨ ë° íƒˆí‡´ ì‹œë‚˜ë¦¬ì˜¤

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ì‚¬ìš©ì ì°¨ë‹¨ ì‹œë‚˜ë¦¬ì˜¤](#2-ì‚¬ìš©ì-ì°¨ë‹¨-ì‹œë‚˜ë¦¬ì˜¤)
3. [íšŒì› íƒˆí‡´ ì‹œë‚˜ë¦¬ì˜¤](#3-íšŒì›-íƒˆí‡´-ì‹œë‚˜ë¦¬ì˜¤)
4. [ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸](#4-ê²€ì¦-ì²´í¬ë¦¬ìŠ¤íŠ¸)

## 1. ê°œìš”

ì‚¬ìš©ì ì°¨ë‹¨ ê¸°ëŠ¥ê³¼ íšŒì› íƒˆí‡´ í”„ë¡œì„¸ìŠ¤ì˜ ì •ìƒ ì‘ë™ì„ ê²€ì¦í•˜ëŠ” í†µí•© ì‹œë‚˜ë¦¬ì˜¤ì…ë‹ˆë‹¤. ê°œì¸ì •ë³´ ë³´í˜¸ì™€ ì‚¬ìš©ì ê¶Œë¦¬ë¥¼ ë³´ì¥í•˜ë©´ì„œë„ ì»¤ë®¤ë‹ˆí‹°ì˜ ê±´ì „ì„±ì„ ìœ ì§€í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ì°¨ë‹¨ ì‹œ ëª¨ë“  ì—°ê´€ ê´€ê³„ ìë™ ì •ë¦¬
- âœ… íƒˆí‡´ ì‹œ ê°œì¸ì •ë³´ ì™„ì „ ì‚­ì œ
- âœ… ì½˜í…ì¸ ëŠ” ìµëª…í™”í•˜ì—¬ ë³´ì¡´

## 2. ì‚¬ìš©ì ì°¨ë‹¨ ì‹œë‚˜ë¦¬ì˜¤

### [í•„ìˆ˜] ì°¨ë‹¨ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

```dart
// íŒŒì¼: test/scenarios/block_user_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:fallingo/services/user_service.dart';
import 'package:fallingo/services/follow_service.dart';

void main() {
  group('ì‚¬ìš©ì ì°¨ë‹¨ ì‹œë‚˜ë¦¬ì˜¤', () {
    late UserService userService;
    late FollowService followService;
    
    setUp(() {
      userService = UserService();
      followService = FollowService();
    });
    
    test('ì°¨ë‹¨ ì‹œ íŒ”ë¡œìš° ê´€ê³„ í•´ì œ', () async {
      // 1. ì´ˆê¸° ìƒíƒœ: Aì™€ Bê°€ ìƒí˜¸ íŒ”ë¡œìš°
      const userA = 'user_a_id';
      const userB = 'user_b_id';
      
      await followService.followUser(userA, userB);
      await followService.followUser(userB, userA);
      
      // íŒ”ë¡œìš° ê´€ê³„ í™•ì¸
      expect(await followService.isFollowing(userA, userB), true);
      expect(await followService.isFollowing(userB, userA), true);
      
      // 2. Aê°€ Bë¥¼ ì°¨ë‹¨
      await userService.blockUser(userA, userB);
      
      // 3. íŒ”ë¡œìš° ê´€ê³„ ìë™ í•´ì œ í™•ì¸
      expect(await followService.isFollowing(userA, userB), false);
      expect(await followService.isFollowing(userB, userA), false);
      
      // 4. ì°¨ë‹¨ ìƒíƒœ í™•ì¸
      expect(await userService.isBlocked(userA, userB), true);
    });
    
    test('ì°¨ë‹¨ëœ ì‚¬ìš©ì í”¼ë“œ ìˆ¨ê¹€', () async {
      // 1. Bê°€ í”¼ë“œ ì‘ì„±
      const userB = 'user_b_id';
      final feedId = await createTestFeed(userB);
      
      // 2. Aì˜ í”¼ë“œ ëª©ë¡ì—ì„œ í™•ì¸
      const userA = 'user_a_id';
      var feeds = await getFeedsForUser(userA);
      expect(feeds.any((f) => f.id == feedId), true);
      
      // 3. Aê°€ Bë¥¼ ì°¨ë‹¨
      await userService.blockUser(userA, userB);
      
      // 4. Aì˜ í”¼ë“œ ëª©ë¡ì—ì„œ Bì˜ í”¼ë“œ ì‚¬ë¼ì§
      feeds = await getFeedsForUser(userA);
      expect(feeds.any((f) => f.id == feedId), false);
    });
  });
}
```

### [í•„ìˆ˜] UI ì°¨ë‹¨ í”Œë¡œìš°

```dart
// íŒŒì¼: lib/features/profile/block_user_flow.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class BlockUserFlow extends ConsumerWidget {
  final String targetUserId;
  
  const BlockUserFlow({required this.targetUserId, Key? key}) : super(key: key);
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return AlertDialog(
      title: const Text('âš ï¸ ì‚¬ìš©ì ì°¨ë‹¨'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('ì´ ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'),
          const SizedBox(height: 16),
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.shade50,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: const [
                Text('ì°¨ë‹¨í•˜ë©´:', style: TextStyle(fontWeight: FontWeight.bold)),
                SizedBox(height: 8),
                Text('â€¢ ìƒí˜¸ íŒ”ë¡œìš°ê°€ í•´ì œë©ë‹ˆë‹¤'),
                Text('â€¢ ìƒëŒ€ë°©ì˜ í”¼ë“œê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤'),
                Text('â€¢ ìƒëŒ€ë°©ì´ ë‚´ í”„ë¡œí•„ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'),
              ],
            ),
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('ì·¨ì†Œ'),
        ),
        ElevatedButton(
          onPressed: () async {
            // ì°¨ë‹¨ ì‹¤í–‰
            await ref.read(userServiceProvider).blockUser(targetUserId);
            
            // ì„±ê³µ ë©”ì‹œì§€
            if (context.mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤')),
              );
              Navigator.pop(context);
            }
          },
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.red,
          ),
          child: const Text('ì°¨ë‹¨í•˜ê¸°'),
        ),
      ],
    );
  }
}
```

## 3. íšŒì› íƒˆí‡´ ì‹œë‚˜ë¦¬ì˜¤

### [í•„ìˆ˜] íƒˆí‡´ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„

```dart
// íŒŒì¼: lib/features/settings/account_deletion_flow.dart
import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class AccountDeletionFlow extends StatefulWidget {
  const AccountDeletionFlow({Key? key}) : super(key: key);
  
  @override
  State<AccountDeletionFlow> createState() => _AccountDeletionFlowState();
}

class _AccountDeletionFlowState extends State<AccountDeletionFlow> {
  int _currentStep = 0;
  bool _agreedToDelete = false;
  bool _isProcessing = false;
  
  final List<String> _deletionSteps = [
    'ê³„ì • ì‚­ì œ ì•ˆë‚´',
    'ë°ì´í„° ì²˜ë¦¬ í™•ì¸',
    'ìµœì¢… í™•ì¸',
  ];
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('íšŒì› íƒˆí‡´'),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
      ),
      body: Stepper(
        currentStep: _currentStep,
        onStepContinue: _handleStepContinue,
        onStepCancel: _handleStepCancel,
        steps: [
          Step(
            title: Text(_deletionSteps[0]),
            content: _buildStep1Content(),
            isActive: _currentStep >= 0,
          ),
          Step(
            title: Text(_deletionSteps[1]),
            content: _buildStep2Content(),
            isActive: _currentStep >= 1,
          ),
          Step(
            title: Text(_deletionSteps[2]),
            content: _buildStep3Content(),
            isActive: _currentStep >= 2,
          ),
        ],
      ),
    );
  }
  
  Widget _buildStep1Content() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'ğŸ˜¢ ì •ë§ ë– ë‚˜ì‹œë‚˜ìš”?',
          style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 16),
        const Text('íšŒì› íƒˆí‡´ ì‹œ ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:'),
        const SizedBox(height: 12),
        _buildInfoCard(
          icon: Icons.delete_forever,
          title: 'ê°œì¸ì •ë³´ ì‚­ì œ',
          description: 'ì´ë©”ì¼, ë‹‰ë„¤ì„ ë“± ëª¨ë“  ê°œì¸ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤',
        ),
        _buildInfoCard(
          icon: Icons.feed,
          title: 'ì‘ì„± ì½˜í…ì¸ ',
          description: 'í”¼ë“œì™€ ëŒ“ê¸€ì€ ìµëª…ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤',
        ),
        _buildInfoCard(
          icon: Icons.restore,
          title: 'ë³µêµ¬ ë¶ˆê°€',
          description: 'íƒˆí‡´ í›„ì—ëŠ” ê³„ì •ì„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
        ),
      ],
    );
  }
  
  Widget _buildStep2Content() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'ğŸ“Š ë°ì´í„° ì²˜ë¦¬ ë°©ì‹',
          style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 16),
        DataTable(
          columns: const [
            DataColumn(label: Text('ë°ì´í„° ìœ í˜•')),
            DataColumn(label: Text('ì²˜ë¦¬ ë°©ì‹')),
          ],
          rows: const [
            DataRow(cells: [
              DataCell(Text('ê°œì¸ì •ë³´')),
              DataCell(Text('ì™„ì „ ì‚­ì œ')),
            ]),
            DataRow(cells: [
              DataCell(Text('í”¼ë“œ/ëŒ“ê¸€')),
              DataCell(Text('ìµëª…í™” ë³´ì¡´')),
            ]),
            DataRow(cells: [
              DataCell(Text('íŒ”ë¡œìš° ê´€ê³„')),
              DataCell(Text('ëª¨ë‘ í•´ì œ')),
            ]),
            DataRow(cells: [
              DataCell(Text('í™œë™ ì ìˆ˜')),
              DataCell(Text('ì´ˆê¸°í™”')),
            ]),
          ],
        ),
      ],
    );
  }
  
  Widget _buildStep3Content() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'âš ï¸ ìµœì¢… í™•ì¸',
          style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 16),
        CheckboxListTile(
          value: _agreedToDelete,
          onChanged: (value) => setState(() => _agreedToDelete = value ?? false),
          title: const Text('ìœ„ ë‚´ìš©ì„ ëª¨ë‘ í™•ì¸í–ˆìœ¼ë©°, íƒˆí‡´ì— ë™ì˜í•©ë‹ˆë‹¤'),
          controlAffinity: ListTileControlAffinity.leading,
        ),
        const SizedBox(height: 24),
        if (_agreedToDelete)
          ElevatedButton(
            onPressed: _isProcessing ? null : _processAccountDeletion,
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              minimumSize: const Size(double.infinity, 48),
            ),
            child: _isProcessing
                ? const CircularProgressIndicator(color: Colors.white)
                : const Text('íšŒì› íƒˆí‡´í•˜ê¸°'),
          ),
      ],
    );
  }
  
  Widget _buildInfoCard({
    required IconData icon,
    required String title,
    required String description,
  }) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      child: ListTile(
        leading: Icon(icon, color: Colors.orange),
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
        subtitle: Text(description),
      ),
    );
  }
  
  void _handleStepContinue() {
    if (_currentStep < _deletionSteps.length - 1) {
      setState(() => _currentStep++);
    }
  }
  
  void _handleStepCancel() {
    if (_currentStep > 0) {
      setState(() => _currentStep--);
    } else {
      Navigator.pop(context);
    }
  }
  
  Future<void> _processAccountDeletion() async {
    setState(() => _isProcessing = true);
    
    try {
      // 1. ì„œë²„ì— íƒˆí‡´ ìš”ì²­
      final response = await Supabase.instance.client
          .rpc('delete_user_account', params: {
            'user_id': Supabase.instance.client.auth.currentUser!.id,
          });
      
      // 2. ë¡œì»¬ ë°ì´í„° ì •ë¦¬
      await _clearLocalData();
      
      // 3. ë¡œê·¸ì•„ì›ƒ
      await Supabase.instance.client.auth.signOut();
      
      // 4. ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì´ë™
      if (mounted) {
        Navigator.pushNamedAndRemoveUntil(
          context,
          '/goodbye',
          (route) => false,
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: $e')),
        );
      }
    } finally {
      setState(() => _isProcessing = false);
    }
  }
  
  Future<void> _clearLocalData() async {
    // SharedPreferences, ìºì‹œ ë“± ë¡œì»¬ ë°ì´í„° ì •ë¦¬
    // êµ¬í˜„ ìƒëµ
  }
}
```

### [í•„ìˆ˜] ë°±ì—”ë“œ íƒˆí‡´ ì²˜ë¦¬

```python
# íŒŒì¼: backend/api/user/account_deletion.py
from flask import jsonify, request
from supabase import create_client
import datetime

def delete_user_account(user_id: str):
    """ì‚¬ìš©ì ê³„ì • ì™„ì „ ì‚­ì œ ì²˜ë¦¬"""
    
    try:
        supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
        
        # 1. ì‚¬ìš©ì ì½˜í…ì¸  ìµëª…í™”
        # í”¼ë“œ ì‘ì„±ìë¥¼ 'deleted_user'ë¡œ ë³€ê²½
        supabase.table('feeds').update({
            'user_id': 'deleted_user',
            'user_nickname': 'íƒˆí‡´í•œ ì‚¬ìš©ì'
        }).eq('user_id', user_id).execute()
        
        # ëŒ“ê¸€ ì‘ì„±ì ìµëª…í™”
        supabase.table('comments').update({
            'user_id': 'deleted_user',
            'user_nickname': 'íƒˆí‡´í•œ ì‚¬ìš©ì'
        }).eq('user_id', user_id).execute()
        
        # 2. íŒ”ë¡œìš° ê´€ê³„ ì‚­ì œ
        supabase.table('follows').delete().or_(
            f'follower_id.eq.{user_id}',
            f'following_id.eq.{user_id}'
        ).execute()
        
        # 3. ì°¨ë‹¨ ê´€ê³„ ì‚­ì œ
        supabase.table('blocks').delete().or_(
            f'blocker_id.eq.{user_id}',
            f'blocked_id.eq.{user_id}'
        ).execute()
        
        # 4. ë¶ë§ˆí¬ ì‚­ì œ
        supabase.table('bookmarks').delete().eq('user_id', user_id).execute()
        
        # 5. í™œë™ ë¡œê·¸ ì‚­ì œ
        supabase.table('activity_logs').delete().eq('user_id', user_id).execute()
        
        # 6. ì‚¬ìš©ì í”„ë¡œí•„ ì‚­ì œ
        supabase.table('user_profiles').delete().eq('user_id', user_id).execute()
        
        # 7. Auth ì‚¬ìš©ì ì‚­ì œ
        supabase.auth.admin.delete_user(user_id)
        
        # 8. íƒˆí‡´ ë¡œê·¸ ê¸°ë¡
        supabase.table('deletion_logs').insert({
            'deleted_at': datetime.datetime.now().isoformat(),
            'user_id_hash': hash(user_id),  # ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ í•´ì‹œë§Œ ì €ì¥
            'reason': 'user_requested'
        }).execute()
        
        return jsonify({
            'success': True,
            'message': 'ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'
        }), 200
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500
```

## 4. ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì°¨ë‹¨ ê¸°ëŠ¥ ê²€ì¦
- [ ] ì°¨ë‹¨ ì‹œ ìƒí˜¸ íŒ”ë¡œìš° ì¦‰ì‹œ í•´ì œ
- [ ] ì°¨ë‹¨ëœ ì‚¬ìš©ìì˜ í”¼ë“œê°€ í”¼ë“œ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§
- [ ] ì°¨ë‹¨ëœ ì‚¬ìš©ìì˜ ëŒ“ê¸€ì´ ë³´ì´ì§€ ì•ŠìŒ
- [ ] ì°¨ë‹¨ëœ ì‚¬ìš©ìê°€ ë‚´ í”„ë¡œí•„ ì ‘ê·¼ ë¶ˆê°€
- [ ] ì°¨ë‹¨ ëª©ë¡ì—ì„œ ì°¨ë‹¨ í•´ì œ ê°€ëŠ¥
- [ ] ì°¨ë‹¨ í•´ì œ í›„ ì •ìƒì ìœ¼ë¡œ í”¼ë“œ í‘œì‹œ

### âœ… íƒˆí‡´ í”„ë¡œì„¸ìŠ¤ ê²€ì¦
- [ ] 3ë‹¨ê³„ íƒˆí‡´ í”Œë¡œìš° ì •ìƒ ì‘ë™
- [ ] ê° ë‹¨ê³„ë³„ ì•ˆë‚´ ë¬¸êµ¬ ëª…í™•í•¨
- [ ] ìµœì¢… ë™ì˜ ì²´í¬ë°•ìŠ¤ í•„ìˆ˜
- [ ] ê°œì¸ì •ë³´ ì™„ì „ ì‚­ì œ í™•ì¸
- [ ] ì‘ì„± ì½˜í…ì¸  ìµëª…í™” í™•ì¸
- [ ] íŒ”ë¡œìš°/ì°¨ë‹¨ ê´€ê³„ ëª¨ë‘ í•´ì œ
- [ ] íƒˆí‡´ í›„ ì¬ê°€ì… ì‹œ ìƒˆ ê³„ì •ìœ¼ë¡œ ì²˜ë¦¬
- [ ] íƒˆí‡´ ì™„ë£Œ í˜ì´ì§€ ì •ìƒ í‘œì‹œ

### âœ… ì—£ì§€ ì¼€ì´ìŠ¤
- [ ] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬
- [ ] íƒˆí‡´ ì¤‘ ì•± ì¢…ë£Œ ì‹œ ë°ì´í„° ì¼ê´€ì„±
- [ ] ëŒ€ëŸ‰ ë°ì´í„° ë³´ìœ  ì‚¬ìš©ì íƒˆí‡´ ì²˜ë¦¬
- [ ] ë™ì‹œ ë‹¤ë°œì  ì°¨ë‹¨ ìš”ì²­ ì²˜ë¦¬

### ğŸ” ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸
- ì°¨ë‹¨/íƒˆí‡´ ë¡œê·¸ ì •ìƒ ê¸°ë¡
- íƒˆí‡´ ì‚¬ìœ  í†µê³„ ìˆ˜ì§‘
- ë¹„ì •ìƒì ì¸ ì°¨ë‹¨ íŒ¨í„´ ê°ì§€