# ğŸ“‹ 2.2 API ì‘ë‹µ í˜•ì‹ ë° ì—ëŸ¬ì½”ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [í‘œì¤€ ì‘ë‹µ í˜•ì‹](#2-í‘œì¤€-ì‘ë‹µ-í˜•ì‹)
3. [ì—ëŸ¬ ì‘ë‹µ í˜•ì‹](#3-ì—ëŸ¬-ì‘ë‹µ-í˜•ì‹)
4. [HTTP ìƒíƒœ ì½”ë“œ](#4-http-ìƒíƒœ-ì½”ë“œ)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”
ëª¨ë“  API ì‘ë‹µì˜ ì¼ê´€ëœ í˜•ì‹ê³¼ ì—ëŸ¬ ì²˜ë¦¬ ë°©ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ì¼ê´€ëœ JSON ì‘ë‹µ êµ¬ì¡°
- âœ… ëª…í™•í•œ ì—ëŸ¬ ì½”ë“œ ì²´ê³„
- âœ… ë‹¤êµ­ì–´ ì—ëŸ¬ ë©”ì‹œì§€

## 2. í‘œì¤€ ì‘ë‹µ í˜•ì‹

### [í•„ìˆ˜] ì„±ê³µ ì‘ë‹µ
```json
{
  "status": "success",
  "data": {
    // ì‹¤ì œ ì‘ë‹µ ë°ì´í„°
  },
  "message": "ì„±ê³µ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)",
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000000Z",
    "version": "1.0"
  }
}
```

### [í•„ìˆ˜] í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ
```json
{
  "status": "success",
  "data": {
    "items": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "totalPages": 5,
      "hasNext": true,
      "hasPrev": false
    }
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000000Z",
    "version": "1.0"
  }
}
```

### [í•„ìˆ˜] ì‘ë‹µ í¬ë§·í„° (Flask)
```python
# íŒŒì¼: backend/utils/response_formatter.py
from datetime import datetime, timezone
from typing import Any, Dict, Optional, Tuple
from flask import jsonify

class ResponseFormatter:
    """í‘œì¤€í™”ëœ API ì‘ë‹µ ìƒì„±"""
    
    @staticmethod
    def success(data: Any = None, message: Optional[str] = None, meta: Optional[Dict] = None) -> Tuple[Any, int]:
        """ì„±ê³µ ì‘ë‹µ ìƒì„±"""
        response = {"status": "success"}
        
        if data is not None:
            response["data"] = data
            
        if message:
            response["message"] = message
            
        # ë©”íƒ€ ì •ë³´ ì¶”ê°€
        if meta is None:
            meta = {}
        meta.update({
            "timestamp": datetime.now(timezone.utc).isoformat() + "Z",
            "version": "1.0"
        })
        response["meta"] = meta
        
        return jsonify(response), 200
    
    @staticmethod
    def error(error_code: str, message: str, details: Optional[Dict] = None, status_code: int = 400) -> Tuple[Any, int]:
        """ì—ëŸ¬ ì‘ë‹µ ìƒì„±"""
        response = {
            "status": "error",
            "error": {
                "code": error_code,
                "message": message
            }
        }
        
        if details:
            response["error"]["details"] = details
            
        response["meta"] = {
            "timestamp": datetime.now(timezone.utc).isoformat() + "Z",
            "version": "1.0"
        }
        
        return jsonify(response), status_code
    
    @staticmethod
    def paginated(items: list, page: int, limit: int, total: int, meta: Optional[Dict] = None) -> Tuple[Any, int]:
        """í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ ìƒì„±"""
        total_pages = (total + limit - 1) // limit if limit > 0 else 0
        
        data = {
            "items": items,
            "pagination": {
                "page": page,
                "limit": limit,
                "total": total,
                "totalPages": total_pages,
                "hasNext": page < total_pages,
                "hasPrev": page > 1
            }
        }
        
        return ResponseFormatter.success(data, meta=meta)
```

## 3. ì—ëŸ¬ ì‘ë‹µ í˜•ì‹

### [í•„ìˆ˜] ì—ëŸ¬ ì‘ë‹µ êµ¬ì¡°
```json
{
  "status": "error",
  "error": {
    "code": "UNAUTHORIZED",
    "message": "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤",
    "details": {
      "field": "idToken",
      "reason": "Invalid token format"
    }
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000000Z",
    "version": "1.0"
  }
}
```

### [í•„ìˆ˜] ì—ëŸ¬ ì½”ë“œ ì •ì˜
```python
# íŒŒì¼: backend/core/errors/error_codes.py
from enum import Enum

class ErrorCode(Enum):
    """í‘œì¤€í™”ëœ ì—ëŸ¬ ì½”ë“œ"""
    
    # Auth (1xxx)
    AUTH_INVALID_CREDENTIALS = ("1001", "ì˜ëª»ëœ ì¸ì¦ ì •ë³´ì…ë‹ˆë‹¤")
    AUTH_USER_NOT_FOUND = ("1002", "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    AUTH_TOKEN_EXPIRED = ("1003", "ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
    AUTH_EMAIL_ALREADY_IN_USE = ("1004", "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤")
    AUTH_NICKNAME_ALREADY_IN_USE = ("1005", "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤")
    
    # Network (2xxx)
    NETWORK_TIMEOUT = ("2001", "ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤")
    NETWORK_OFFLINE = ("2002", "ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”")
    NETWORK_SERVER_ERROR = ("2003", "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
    
    # Data (3xxx)
    DATA_NOT_FOUND = ("3001", "ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    DATA_INVALID = ("3002", "ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤")
    DATA_CONFLICT = ("3003", "ë°ì´í„° ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
    
    # Permission (4xxx)
    PERMISSION_DENIED = ("4001", "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤")
    PERMISSION_LOCATION = ("4002", "ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
    PERMISSION_CAMERA = ("4003", "ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
    
    # Business Logic (5xxx)
    BUSINESS_DUPLICATE_FEED = ("5001", "24ì‹œê°„ ì´ë‚´ì— ì´ë¯¸ ë“±ë¡í•œ ë©”ë‰´ì…ë‹ˆë‹¤")
    BUSINESS_INVALID_LOCATION = ("5002", "í˜„ì¬ ìœ„ì¹˜ì—ì„œë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    BUSINESS_QUOTA_EXCEEDED = ("5003", "ì¼ì¼ ë“±ë¡ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤")
    BUSINESS_NO_FOOD_DETECTED = ("5004", "ìŒì‹ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
    BUSINESS_FEED_LOCKED = ("5007", "2ì‹œê°„ì´ ì§€ë‚˜ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    
    # Validation (6xxx)
    VALIDATION_EMAIL_FORMAT = ("6001", "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    VALIDATION_NICKNAME_LENGTH = ("6002", "ë‹‰ë„¤ì„ì€ 2-20ì ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")
    
    # External Service (7xxx)
    EXTERNAL_VISION_API_ERROR = ("7001", "ì´ë¯¸ì§€ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
    EXTERNAL_OCR_ERROR = ("7002", "ì˜ìˆ˜ì¦ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
    EXTERNAL_MAPS_ERROR = ("7003", "ì§€ë„ ì„œë¹„ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
    
    def __init__(self, code: str, message: str):
        self.code = code
        self.message = message
```

### [í•„ìˆ˜] ì—ëŸ¬ í•¸ë“¤ëŸ¬
```python
# íŒŒì¼: backend/utils/error_handler.py
from flask import Flask, request
from werkzeug.exceptions import HTTPException
from core.logging.logger import logger
from utils.response_formatter import ResponseFormatter

def register_error_handlers(app: Flask):
    """ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë“±ë¡"""
    
    @app.errorhandler(400)
    def bad_request(e):
        logger.warning(f"Bad request: {request.url}")
        return ResponseFormatter.error(
            "BAD_REQUEST",
            "ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤",
            status_code=400
        )
    
    @app.errorhandler(401)
    def unauthorized(e):
        logger.warning(f"Unauthorized access: {request.url}")
        return ResponseFormatter.unauthorized()
    
    @app.errorhandler(403)
    def forbidden(e):
        logger.warning(f"Forbidden access: {request.url}")
        return ResponseFormatter.forbidden()
    
    @app.errorhandler(404)
    def not_found(e):
        logger.info(f"Resource not found: {request.url}")
        return ResponseFormatter.not_found()
    
    @app.errorhandler(422)
    def unprocessable_entity(e):
        logger.warning(f"Unprocessable entity: {request.url}")
        
        # Werkzeugì˜ ValidationErrorì¸ ê²½ìš°
        if hasattr(e, 'data') and 'messages' in e.data:
            return ResponseFormatter.validation_error(e.data['messages'])
            
        return ResponseFormatter.error(
            "UNPROCESSABLE_ENTITY",
            "ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
            status_code=422
        )
    
    @app.errorhandler(500)
    def internal_error(e):
        logger.error(f"Internal server error: {request.url}", error=e)
        
        debug_info = str(e) if app.config.get('DEBUG') else None
        return ResponseFormatter.internal_error(debug_info=debug_info)
    
    @app.errorhandler(Exception)
    def handle_exception(e):
        # HTTP ì˜ˆì™¸ëŠ” ê¸°ë³¸ í•¸ë“¤ëŸ¬ë¡œ
        if isinstance(e, HTTPException):
            return e
            
        # ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸ ë¡œê¹…
        logger.error(f"Unhandled exception: {request.url}", error=e)
        
        # ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì²˜ë¦¬
        from core.errors import AppException
        if isinstance(e, AppException):
            return ResponseFormatter.error(
                error_code=e.code,
                message=e.message,
                details={'details': e.details} if e.details else None,
                status_code=_get_status_code_for_error(e.code)
            )
        
        # ê¸°íƒ€ ì˜ˆì™¸
        debug_info = f"{type(e).__name__}: {str(e)}" if app.config.get('DEBUG') else None
        return ResponseFormatter.internal_error(debug_info=debug_info)

def _get_status_code_for_error(error_code: str) -> int:
    """ì—ëŸ¬ ì½”ë“œì— ë”°ë¥¸ HTTP ìƒíƒœ ì½”ë“œ ë°˜í™˜"""
    if error_code.startswith('1'):  # Auth
        return 401
    elif error_code.startswith('2'):  # Network
        return 503
    elif error_code.startswith('3'):  # Data
        return 404
    elif error_code.startswith('4'):  # Permission
        return 403
    elif error_code.startswith('5'):  # Business Logic
        return 422
    elif error_code.startswith('6'):  # Validation
        return 400
    elif error_code.startswith('7'):  # External Service
        return 502
    else:
        return 500
```

### [í•„ìˆ˜] í—¬í¼ ë©”ì„œë“œ
```python
# ResponseFormatter í´ë˜ìŠ¤ì— ì¶”ê°€ëœ í—¬í¼ ë©”ì„œë“œë“¤
@staticmethod
def created(data: Any = None, message: Optional[str] = None) -> Tuple[Any, int]:
    """ìƒì„± ì„±ê³µ ì‘ë‹µ (201)"""
    response = {"status": "success"}
    if data is not None:
        response["data"] = data
    if message:
        response["message"] = message or "ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
    return jsonify(response), 201

@staticmethod
def no_content() -> Tuple[str, int]:
    """ë‚´ìš© ì—†ìŒ ì‘ë‹µ (204) - ì‚­ì œ ë“±"""
    return "", 204

@staticmethod
def validation_error(errors: Dict[str, str], message: str = "ì…ë ¥ê°’ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤") -> Tuple[Any, int]:
    """ê²€ì¦ ì—ëŸ¬ ì‘ë‹µ (422)"""
    return ResponseFormatter.error(
        error_code="VALIDATION_ERROR",
        message=message,
        details={"fields": errors},
        status_code=422
    )

@staticmethod
def unauthorized(message: str = "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤") -> Tuple[Any, int]:
    """ì¸ì¦ ì‹¤íŒ¨ ì‘ë‹µ (401)"""
    return ResponseFormatter.error(
        error_code="UNAUTHORIZED",
        message=message,
        status_code=401
    )

@staticmethod
def forbidden(message: str = "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤") -> Tuple[Any, int]:
    """ê¶Œí•œ ì—†ìŒ ì‘ë‹µ (403)"""
    return ResponseFormatter.error(
        error_code="FORBIDDEN",
        message=message,
        status_code=403
    )

@staticmethod
def not_found(resource: str = "ë¦¬ì†ŒìŠ¤", message: Optional[str] = None) -> Tuple[Any, int]:
    """ë¦¬ì†ŒìŠ¤ ì—†ìŒ ì‘ë‹µ (404)"""
    return ResponseFormatter.error(
        error_code="NOT_FOUND",
        message=message or f"{resource}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
        status_code=404
    )
```

## 4. HTTP ìƒíƒœ ì½”ë“œ

### [í•„ìˆ˜] ìƒíƒœ ì½”ë“œ ì‚¬ìš© ê·œì¹™
| ìƒíƒœ ì½”ë“œ | ì‚¬ìš© ì‹œì  | ì˜ˆì‹œ |
|-----------|-----------|------|
| 200 OK | ì„±ê³µì ì¸ GET, PUT, PATCH | í”¼ë“œ ì¡°íšŒ ì„±ê³µ |
| 201 Created | ì„±ê³µì ì¸ POST | í”¼ë“œ ìƒì„± ì„±ê³µ |
| 204 No Content | ì„±ê³µì ì¸ DELETE | í”¼ë“œ ì‚­ì œ ì„±ê³µ |
| 400 Bad Request | ì˜ëª»ëœ ìš”ì²­ í˜•ì‹ | í•„ìˆ˜ í•„ë“œ ëˆ„ë½ |
| 401 Unauthorized | ì¸ì¦ ì‹¤íŒ¨ | í† í° ì—†ìŒ/ë§Œë£Œ |
| 403 Forbidden | ê¶Œí•œ ì—†ìŒ | ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ìˆ˜ì • ì‹œë„ |
| 404 Not Found | ë¦¬ì†ŒìŠ¤ ì—†ìŒ | ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”¼ë“œ |
| 405 Method Not Allowed | í—ˆìš©ë˜ì§€ ì•Šì€ ë©”ì„œë“œ | POSTë§Œ ê°€ëŠ¥í•œ ì—”ë“œí¬ì¸íŠ¸ì— GET ìš”ì²­ |
| 409 Conflict | ì¶©ëŒ ë°œìƒ | ì¤‘ë³µ ì¶”ì²œ ì‹œë„ |
| 422 Unprocessable Entity | ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨ | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ìœ„ë°˜ |
| 429 Too Many Requests | ìš”ì²­ í•œë„ ì´ˆê³¼ | API í˜¸ì¶œ ì œí•œ |
| 500 Internal Server Error | ì„œë²„ ì˜¤ë¥˜ | ì˜ˆì™¸ ì²˜ë¦¬ ì‹¤íŒ¨ |
| 502 Bad Gateway | ì™¸ë¶€ ì„œë¹„ìŠ¤ ì˜¤ë¥˜ | Vision API ì˜¤ë¥˜ |
| 503 Service Unavailable | ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€ | ì„œë²„ ê³¼ë¶€í•˜ |

### [í•„ìˆ˜] ì—ëŸ¬ ì½”ë“œë³„ HTTP ìƒíƒœ ë§¤í•‘
| ì—ëŸ¬ ì½”ë“œ ë²”ìœ„ | HTTP ìƒíƒœ ì½”ë“œ | ì¹´í…Œê³ ë¦¬ |
|----------------|----------------|----------|
| 1xxx | 401 | ì¸ì¦ ê´€ë ¨ |
| 2xxx | 503 | ë„¤íŠ¸ì›Œí¬/ì„œë²„ |
| 3xxx | 404 | ë°ì´í„° ê´€ë ¨ |
| 4xxx | 403 | ê¶Œí•œ ê´€ë ¨ |
| 5xxx | 422 | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |
| 6xxx | 400 | ìœ íš¨ì„± ê²€ì¦ |
| 7xxx | 502 | ì™¸ë¶€ ì„œë¹„ìŠ¤ |

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  ì‘ë‹µì´ í‘œì¤€ í˜•ì‹ì„ ë”°ë¥´ëŠ”ê°€?
- [ ] ì—ëŸ¬ ì½”ë“œê°€ ì²´ê³„ì ìœ¼ë¡œ ë¶„ë¥˜ë˜ëŠ”ê°€?
- [ ] HTTP ìƒíƒœ ì½”ë“œê°€ ì ì ˆí•œê°€?
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì‚¬ìš©ì ì¹œí™”ì ì¸ê°€?
- [ ] ë¡œê¹…ì´ ì ì ˆíˆ êµ¬í˜„ë˜ì—ˆëŠ”ê°€?

### ì‘ë‹µ í…ŒìŠ¤íŠ¸
```python
# ì„±ê³µ ì‘ë‹µ í…ŒìŠ¤íŠ¸
def test_success_response():
    response, status_code = ResponseFormatter.success({
        "id": "user123",
        "name": "í…ŒìŠ¤íŠ¸"
    })
    
    data = response.get_json()
    assert data["status"] == "success"
    assert "timestamp" in data["meta"]
    assert status_code == 200

# ì—ëŸ¬ ì‘ë‹µ í…ŒìŠ¤íŠ¸
def test_error_response():
    response, status_code = ResponseFormatter.error(
        "UNAUTHORIZED",
        "ì¸ì¦ ì‹¤íŒ¨",
        status_code=401
    )
    
    data = response.get_json()
    assert data["status"] == "error"
    assert data["error"]["code"] == "UNAUTHORIZED"
    assert status_code == 401

# í˜ì´ì§€ë„¤ì´ì…˜ í…ŒìŠ¤íŠ¸
def test_pagination_response():
    response, status_code = ResponseFormatter.paginated(
        items=[{"id": 1}, {"id": 2}],
        page=1,
        limit=20,
        total=100
    )
    
    data = response.get_json()
    assert data["data"]["pagination"]["totalPages"] == 5
    assert data["data"]["pagination"]["hasNext"] == True
```