# ğŸ’¯ 8.2 í™œë™ ì ìˆ˜ ê³„ì‚°

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [í•µì‹¬ êµ¬í˜„](#2-í•µì‹¬-êµ¬í˜„)
3. [ë³´ìƒ ì‹œìŠ¤í…œ](#3-ë³´ìƒ-ì‹œìŠ¤í…œ)
4. [ê²€ì¦](#4-ê²€ì¦)

## 1. ê°œìš”

ì‚¬ìš©ì í™œë™ì— ëŒ€í•œ ì´ì›í™”ëœ ì ìˆ˜ ì‹œìŠ¤í…œê³¼ 2ì‹œê°„ ì ê¸ˆ, ì¼ì¼ ë°˜ì‘ ë³´ìƒì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ì´ì›í™” ì ìˆ˜ (ë ˆë²¨ì—…/ì¸í”Œë£¨ì–¸ì„œ)
- âœ… 2ì‹œê°„ ì ê¸ˆ ì‹œìŠ¤í…œ
- âœ… ì¼ì¼ ë°˜ì‘ ë³´ìƒ (5~50ì )

## 2. í•µì‹¬ êµ¬í˜„

### [í•„ìˆ˜] ì ìˆ˜ ì²´ê³„ ì •ì˜
```dart
// íŒŒì¼: lib/core/constants/activity_points.dart
class ActivityPoints {
  // ê¸°ë³¸ í™œë™ ì ìˆ˜
  static const basePoints = {
    // í”¼ë“œ ê´€ë ¨
    'feed_create': 3,                    // í”¼ë“œ ë“±ë¡
    'feed_first_place': 10,              // ìµœì´ˆ ë“±ë¡ ë³´ë„ˆìŠ¤
    'feed_ocr_bonus': 5,                 // OCR ì¶”ê°€ ë³´ë„ˆìŠ¤
    
    // ì¶”ì²œ/ë¶ë§ˆí¬
    'recommend_give': 1,                 // ì¶”ì²œí•˜ê¸°
    'bookmark_add': 1,                   // ë¶ë§ˆí¬ ì¶”ê°€
    
    // ì¼ì¼ ë¡œê·¸ì¸
    'daily_login': 1,                    // ì¼ì¼ ì ‘ì†
  };
  
  // 2ì‹œê°„ ì ê¸ˆ ëŒ€ìƒ í™œë™
  static const lockedActivities = [
    'feed_create',
    'feed_first_place',
    'feed_ocr_bonus',
  ];
  
  // ì¼ì¼ í•œë„
  static const dailyLimits = {
    'recommend_give': 50,
    'bookmark_add': 30,
    'reaction_reward': 50,  // ì¼ì¼ ë°˜ì‘ ë³´ìƒ ìµœëŒ€ì¹˜
  };
  
  // ë“±ê¸‰ë³„ í•„ìš” í¬ì¸íŠ¸ (ë ˆë²¨ì—…ìš©)
  static const gradeThresholds = {
    2: 100,    // ë¹„ë¹”ë°¥
    3: 300,    // ì‚¼ê²¹ì‚´
    4: 600,    // ê°ˆë¹„íƒ•
    5: 1000,   // ëª¨ë‘ íšŒ
    6: 1500,   // ì”ì¹«ìƒ
    7: 2000,   // ìˆ˜ëìƒ
  };
}

// ì ìˆ˜ íƒ€ì… êµ¬ë¶„
enum PointType {
  levelUp,      // 1~7ë“±ê¸‰ìš©
  influencer,   // 8~10ë“±ê¸‰ ì„ ë°œìš©
}
```

### [í•„ìˆ˜] ì ìˆ˜ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/services/point_service.dart
class PointService {
  // ì ìˆ˜ ë¶€ì—¬ (2ì‹œê°„ ì ê¸ˆ ê³ ë ¤)
  Future<PointResult> awardPoints({
    required String userId,
    required String activityType,
    String? targetId,  // í”¼ë“œ ID ë“±
  }) async {
    // 1. í™œë™ ìœ íš¨ì„± ê²€ì¦
    if (!await _validateActivity(userId, activityType)) {
      return PointResult(success: false, message: 'ì¼ì¼ í•œë„ ì´ˆê³¼');
    }
    
    // 2. ê¸°ë³¸ ì ìˆ˜ ê³„ì‚°
    final points = ActivityPoints.basePoints[activityType] ?? 0;
    if (points == 0) return PointResult(success: false);
    
    // 3. ì ê¸ˆ ëŒ€ìƒ í™œë™ì¸ì§€ í™•ì¸
    if (ActivityPoints.lockedActivities.contains(activityType)) {
      // 2ì‹œê°„ ì ê¸ˆ ë ˆì½”ë“œ ìƒì„±
      await _createPendingRecord(
        userId: userId,
        activityType: activityType,
        points: points,
        targetId: targetId,
      );
      
      return PointResult(
        success: true,
        points: points,
        isPending: true,
        message: '2ì‹œê°„ í›„ ì ìˆ˜ê°€ í™•ì •ë©ë‹ˆë‹¤',
      );
    }
    
    // 4. ì¦‰ì‹œ ë¶€ì—¬
    await _grantPoints(userId, points, PointType.levelUp);
    return PointResult(success: true, points: points);
  }
  
  // 2ì‹œê°„ ì ê¸ˆ ë ˆì½”ë“œ ìƒì„±
  Future<void> _createPendingRecord({
    required String userId,
    required String activityType,
    required int points,
    String? targetId,
  }) async {
    final record = PendingPointRecord(
      id: generateId(),
      userId: userId,
      activityType: activityType,
      points: points,
      targetId: targetId,
      createdAt: DateTime.now(),
      expiresAt: DateTime.now().add(Duration(hours: 2)),
      status: 'pending',
    );
    
    // Mock ì €ì¥
    pendingRecords[record.id] = record;
    
    // 2ì‹œê°„ í›„ ìë™ í™•ì • ìŠ¤ì¼€ì¤„
    Future.delayed(Duration(hours: 2), () {
      _confirmPendingPoints(record.id);
    });
  }
  
  // ì ê¸ˆ í¬ì¸íŠ¸ í™•ì •
  Future<void> _confirmPendingPoints(String recordId) async {
    final record = pendingRecords[recordId];
    if (record == null || record.status != 'pending') return;
    
    // ëŒ€ìƒ(í”¼ë“œ ë“±)ì´ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
    if (record.targetId != null) {
      final exists = await _checkTargetExists(
        record.activityType, 
        record.targetId!
      );
      if (!exists) {
        record.status = 'cancelled';
        return;
      }
    }
    
    // ì ìˆ˜ ë¶€ì—¬
    await _grantPoints(record.userId, record.points, PointType.levelUp);
    record.status = 'confirmed';
    
    // ì¸í”Œë£¨ì–¸ì„œ ì ìˆ˜ë„ ë™ì‹œ ì ë¦½
    if (record.activityType == 'feed_create') {
      await _grantPoints(record.userId, record.points, PointType.influencer);
    }
  }
  
  // ì‹¤ì œ ì ìˆ˜ ë¶€ì—¬
  Future<void> _grantPoints(
    String userId, 
    int points, 
    PointType type,
  ) async {
    final user = users[userId]!;
    
    if (type == PointType.levelUp) {
      user.levelUpPoints += points;
      // ë“±ê¸‰ ì²´í¬
      _checkGradeUpgrade(user);
    } else {
      user.influencerPoints += points;
    }
    
    // í™œë™ ê¸°ë¡
    activityLogs.add(ActivityLog(
      userId: userId,
      points: points,
      type: type,
      timestamp: DateTime.now(),
    ));
  }
  
  // ë“±ê¸‰ ìƒìŠ¹ ì²´í¬
  void _checkGradeUpgrade(UserData user) {
    int newGrade = 1;
    
    ActivityPoints.gradeThresholds.forEach((grade, threshold) {
      if (user.levelUpPoints >= threshold) {
        newGrade = grade;
      }
    });
    
    if (newGrade > user.grade) {
      user.grade = newGrade;
      // ë“±ê¸‰ ìƒìŠ¹ ì•Œë¦¼
      _notifyGradeUp(user.id, newGrade);
    }
  }
}
```

## 3. ë³´ìƒ ì‹œìŠ¤í…œ

### [í•„ìˆ˜] ì¼ì¼ ë°˜ì‘ ë³´ìƒ
```dart
// íŒŒì¼: lib/services/daily_reward_service.dart
class DailyRewardService {
  // ì¼ì¼ ë°˜ì‘ ë³´ìƒ ê³„ì‚° ë° ì§€ê¸‰
  Future<void> calculateDailyRewards() async {
    final now = DateTime.now();
    final yesterday = DateTime(now.year, now.month, now.day - 1);
    
    for (final userId in users.keys) {
      final reactions = await _getUserDailyReactions(userId, yesterday);
      
      if (reactions.totalCount > 0) {
        // ë³´ìƒ ê³„ì‚° (5~50ì )
        final reward = _calculateReward(reactions);
        
        // ë ˆë²¨ì—… í¬ì¸íŠ¸ë¡œ ì§€ê¸‰
        await pointService._grantPoints(
          userId, 
          reward, 
          PointType.levelUp
        );
        
        // ì•Œë¦¼
        _notifyDailyReward(userId, reward, reactions);
      }
    }
  }
  
  // ë³´ìƒ ê³„ì‚° ë¡œì§
  int _calculateReward(DailyReactions reactions) {
    // ê¸°ë³¸ 5ì 
    int reward = 5;
    
    // ì¶”ì²œ ìˆ˜ì— ë”°ë¼ ì¶”ê°€ (ìµœëŒ€ 30ì )
    reward += min(30, reactions.recommendCount * 2);
    
    // ë¶ë§ˆí¬ ìˆ˜ì— ë”°ë¼ ì¶”ê°€ (ìµœëŒ€ 10ì )
    reward += min(10, reactions.bookmarkCount);
    
    // ëŒ“ê¸€ ìˆ˜ì— ë”°ë¼ ì¶”ê°€ (ìµœëŒ€ 5ì )
    reward += min(5, reactions.commentCount);
    
    // ìµœëŒ€ 50ì  ì œí•œ
    return min(50, reward);
  }
  
  // ì‚¬ìš©ìì˜ ì¼ì¼ ë°˜ì‘ ì¡°íšŒ
  Future<DailyReactions> _getUserDailyReactions(
    String userId,
    DateTime date,
  ) async {
    // Mock ë°ì´í„°
    return DailyReactions(
      recommendCount: Random().nextInt(20),
      bookmarkCount: Random().nextInt(10),
      commentCount: Random().nextInt(5),
      totalCount: 0,  // ê³„ì‚°ë¨
    );
  }
  
  void _notifyDailyReward(
    String userId,
    int reward,
    DailyReactions reactions,
  ) {
    notifications.add(Notification(
      userId: userId,
      type: 'daily_reward',
      title: 'ì¼ì¼ ë°˜ì‘ ë³´ìƒ ğŸ',
      body: 'ì–´ì œ ë°›ì€ ë°˜ì‘ìœ¼ë¡œ $reward APë¥¼ íšë“í–ˆì–´ìš”!',
      data: {
        'reward': reward,
        'reactions': reactions.toMap(),
      },
    ));
  }
}

// ì¼ì¼ ë°˜ì‘ ë°ì´í„°
class DailyReactions {
  final int recommendCount;
  final int bookmarkCount;
  final int commentCount;
  
  DailyReactions({
    required this.recommendCount,
    required this.bookmarkCount,
    required this.commentCount,
  });
  
  int get totalCount => recommendCount + bookmarkCount + commentCount;
  
  Map<String, int> toMap() => {
    'recommendCount': recommendCount,
    'bookmarkCount': bookmarkCount,
    'commentCount': commentCount,
  };
}
```

### [í•„ìˆ˜] ì ìˆ˜ í˜„í™© UI
```dart
// íŒŒì¼: lib/widgets/point_status_widget.dart
class PointStatusWidget extends StatelessWidget {
  final String userId;
  
  const PointStatusWidget({required this.userId});
  
  @override
  Widget build(BuildContext context) {
    final user = users[userId]!;
    final pendingPoints = _getPendingPoints(userId);
    
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // í˜„ì¬ í¬ì¸íŠ¸
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text('ë ˆë²¨ì—… í¬ì¸íŠ¸', style: TextStyle(fontSize: 16)),
                Text(
                  '${user.levelUpPoints} AP',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFFFF6B35),
                  ),
                ),
              ],
            ),
            
            // ëŒ€ê¸° ì¤‘ì¸ í¬ì¸íŠ¸
            if (pendingPoints > 0) ...[
              SizedBox(height: 8),
              Row(
                children: [
                  Icon(Icons.schedule, size: 16, color: Colors.orange),
                  SizedBox(width: 4),
                  Text(
                    'í™•ì • ëŒ€ê¸°: +$pendingPoints AP',
                    style: TextStyle(color: Colors.orange),
                  ),
                ],
              ),
            ],
            
            // ë“±ê¸‰ ì§„í–‰ë¥ 
            SizedBox(height: 16),
            _buildGradeProgress(user),
            
            // ì¼ì¼ í˜„í™©
            SizedBox(height: 16),
            _buildDailyStatus(userId),
          ],
        ),
      ),
    );
  }
  
  Widget _buildGradeProgress(UserData user) {
    final currentGrade = user.grade;
    final nextGrade = currentGrade + 1;
    final nextThreshold = ActivityPoints.gradeThresholds[nextGrade];
    
    if (nextThreshold == null) {
      return Text('ìµœê³  ë“±ê¸‰ ë‹¬ì„±! ğŸ‰');
    }
    
    final currentThreshold = ActivityPoints.gradeThresholds[currentGrade] ?? 0;
    final progress = (user.levelUpPoints - currentThreshold) / 
                    (nextThreshold - currentThreshold);
    
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text('ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€'),
            Text('${nextThreshold - user.levelUpPoints} AP'),
          ],
        ),
        SizedBox(height: 4),
        LinearProgressIndicator(
          value: progress.clamp(0.0, 1.0),
          backgroundColor: Colors.grey[300],
          valueColor: AlwaysStoppedAnimation(Color(0xFFFF6B35)),
        ),
      ],
    );
  }
  
  Widget _buildDailyStatus(String userId) {
    final todayRecommends = _getTodayActivityCount(userId, 'recommend_give');
    final todayBookmarks = _getTodayActivityCount(userId, 'bookmark_add');
    
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('ì˜¤ëŠ˜ì˜ í™œë™', style: TextStyle(fontWeight: FontWeight.bold)),
        SizedBox(height: 8),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceAround,
          children: [
            _buildActivityCounter(
              'ì¶”ì²œ',
              todayRecommends,
              ActivityPoints.dailyLimits['recommend_give']!,
            ),
            _buildActivityCounter(
              'ë¶ë§ˆí¬',
              todayBookmarks,
              ActivityPoints.dailyLimits['bookmark_add']!,
            ),
          ],
        ),
      ],
    );
  }
  
  Widget _buildActivityCounter(String label, int current, int max) {
    return Column(
      children: [
        Text(label, style: TextStyle(fontSize: 12, color: Colors.grey)),
        Text(
          '$current/$max',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
            color: current >= max ? Colors.red : Colors.black,
          ),
        ),
      ],
    );
  }
  
  int _getPendingPoints(String userId) {
    return pendingRecords.values
        .where((r) => r.userId == userId && r.status == 'pending')
        .fold(0, (sum, r) => sum + r.points);
  }
  
  int _getTodayActivityCount(String userId, String activityType) {
    final today = DateTime.now();
    return activityLogs
        .where((log) => 
            log.userId == userId &&
            log.timestamp.day == today.day &&
            log.timestamp.month == today.month &&
            log.timestamp.year == today.year)
        .length;
  }
}
```

### [í•„ìˆ˜] Mock ë°ì´í„°
```dart
// íŒŒì¼: lib/mock/point_mock_data.dart

// ëŒ€ê¸° ì¤‘ì¸ í¬ì¸íŠ¸ ë ˆì½”ë“œ
class PendingPointRecord {
  final String id;
  final String userId;
  final String activityType;
  final int points;
  final String? targetId;
  final DateTime createdAt;
  final DateTime expiresAt;
  String status;  // pending, confirmed, cancelled
  
  PendingPointRecord({
    required this.id,
    required this.userId,
    required this.activityType,
    required this.points,
    this.targetId,
    required this.createdAt,
    required this.expiresAt,
    required this.status,
  });
}

// í™œë™ ë¡œê·¸
class ActivityLog {
  final String userId;
  final int points;
  final PointType type;
  final DateTime timestamp;
  
  ActivityLog({
    required this.userId,
    required this.points,
    required this.type,
    required this.timestamp,
  });
}

// Mock ì €ì¥ì†Œ
final Map<String, PendingPointRecord> pendingRecords = {};
final List<ActivityLog> activityLogs = [];
final List<Notification> notifications = [];

// ì‚¬ìš©ì ë°ì´í„° í™•ì¥
extension UserDataExtension on UserData {
  int get levelUpPoints => _levelUpPoints[id] ?? 0;
  set levelUpPoints(int value) => _levelUpPoints[id] = value;
  
  int get influencerPoints => _influencerPoints[id] ?? 0;
  set influencerPoints(int value) => _influencerPoints[id] = value;
}

final Map<String, int> _levelUpPoints = {'user1': 2150};
final Map<String, int> _influencerPoints = {'user1': 3200};
```

## 4. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] í”¼ë“œ ë“±ë¡ 3ì , ìµœì´ˆ 10ì , OCR 5ì 
- [ ] ì¶”ì²œ/ë¶ë§ˆí¬ ê° 1ì 
- [ ] 2ì‹œê°„ ì ê¸ˆ ì‹œìŠ¤í…œ ë™ì‘
- [ ] ì‚­ì œ ì‹œ ì ìˆ˜ ë¯¸ì§€ê¸‰
- [ ] ì¼ì¼ ë°˜ì‘ ë³´ìƒ (5~50ì )
- [ ] ë ˆë²¨ì—…/ì¸í”Œë£¨ì–¸ì„œ ì ìˆ˜ ë¶„ë¦¬
- [ ] ì¼ì¼ í•œë„ ì²´í¬