# ğŸ¯ 8.4 ì´ë²¤íŠ¸ ë§ˆì»¤ ì‹œìŠ¤í…œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ë§ˆì»¤ íƒ€ì… ì •ì˜](#2-ë§ˆì»¤-íƒ€ì…-ì •ì˜)
3. [ì§€ë„ í‘œì‹œ ë¡œì§](#3-ì§€ë„-í‘œì‹œ-ë¡œì§)
4. [ë§ˆì»¤ ë“±ë¡ í”„ë¡œì„¸ìŠ¤](#4-ë§ˆì»¤-ë“±ë¡-í”„ë¡œì„¸ìŠ¤)
5. [ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ](#5-ìš°ì„ ìˆœìœ„-ì‹œìŠ¤í…œ)

## 1. ê°œìš”

ì§€ë„ì— í‘œì‹œë˜ëŠ” íŠ¹ë³„ ë§ˆì»¤ ì‹œìŠ¤í…œìœ¼ë¡œ ì¸ì¦ë§›ì§‘ê³¼ ì´ë²¤íŠ¸ ì •ë³´ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë…¸ì¶œí•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ìµœëŒ€ 5ê°œ ìŠ¬ë¡¯ìœ¼ë¡œ ì§€ë„ ê°€ë…ì„± ìœ ì§€
- âœ… ê±°ë¦¬ ê¸°ë°˜ ìš°ì„ ìˆœìœ„ ìë™ ì¡°ì •
- âœ… Mock ë°ì´í„°ë¡œ ì „ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

## 2. ë§ˆì»¤ íƒ€ì… ì •ì˜

### [í•„ìˆ˜] ë§ˆì»¤ íƒ€ì… ëª¨ë¸
```dart
// íŒŒì¼: lib/models/marker_type.dart
enum MarkerType {
  certified('certified', 'ì¸ì¦ë§›ì§‘', 'ğŸ…'),
  event('event', 'ì´ë²¤íŠ¸', 'ğŸŠ'),
  newMenu('new_menu', 'ì‹ ë©”ë‰´', 'ğŸ†•'),
  influencer('influencer', 'ì¸í”Œë£¨ì–¸ì„œ', 'â­');

  final String code;
  final String label;
  final String emoji;

  const MarkerType(this.code, this.label, this.emoji);
}

class EventMarker {
  final String id;
  final String restaurantId;
  final String restaurantName;
  final MarkerType type;
  final LatLng location;
  final String title;
  final String? description;
  final DateTime startDate;
  final DateTime endDate;
  final int priority;
  final bool isActive;

  EventMarker({
    required this.id,
    required this.restaurantId,
    required this.restaurantName,
    required this.type,
    required this.location,
    required this.title,
    this.description,
    required this.startDate,
    required this.endDate,
    required this.priority,
    this.isActive = true,
  });

  bool get isValid {
    final now = DateTime.now();
    return isActive && 
           now.isAfter(startDate) && 
           now.isBefore(endDate);
  }

  factory EventMarker.fromJson(Map<String, dynamic> json) {
    return EventMarker(
      id: json['id'],
      restaurantId: json['restaurant_id'],
      restaurantName: json['restaurant_name'],
      type: MarkerType.values.firstWhere(
        (e) => e.code == json['type'],
      ),
      location: LatLng(
        json['location']['lat'],
        json['location']['lng'],
      ),
      title: json['title'],
      description: json['description'],
      startDate: DateTime.parse(json['start_date']),
      endDate: DateTime.parse(json['end_date']),
      priority: json['priority'] ?? 0,
      isActive: json['is_active'] ?? true,
    );
  }
}
```

### [í•„ìˆ˜] Mock ë§ˆì»¤ ë°ì´í„°
```dart
// íŒŒì¼: lib/services/mock/mock_marker_data.dart
class MockMarkerData {
  static List<EventMarker> getMockMarkers(LatLng userLocation) {
    final now = DateTime.now();
    
    return [
      // ì¸ì¦ë§›ì§‘ ë§ˆì»¤
      EventMarker(
        id: 'marker_001',
        restaurantId: 'rest_001',
        restaurantName: 'ì§„ë¯¸í‰ì–‘ëƒ‰ë©´',
        type: MarkerType.certified,
        location: LatLng(
          userLocation.latitude + 0.002,
          userLocation.longitude + 0.001,
        ),
        title: 'ì¸ì¦ ì¶”ì²œë§›ì§‘!',
        description: 'í‰ì–‘ëƒ‰ë©´ ë§›ì§‘ìœ¼ë¡œ ì¸ì¦',
        startDate: now.subtract(Duration(days: 30)),
        endDate: now.add(Duration(days: 365)),
        priority: 100,
      ),
      
      // ì´ë²¤íŠ¸ ë§ˆì»¤
      EventMarker(
        id: 'marker_002',
        restaurantId: 'rest_002',
        restaurantName: 'ì™•ê°€íƒ•ìˆ˜ìœ¡',
        type: MarkerType.event,
        location: LatLng(
          userLocation.latitude - 0.003,
          userLocation.longitude + 0.002,
        ),
        title: 'ì˜¤í”ˆ 1ì£¼ë…„ 20% í• ì¸',
        description: 'ëª¨ë“  ë©”ë‰´ 20% í• ì¸ (~12/31)',
        startDate: now.subtract(Duration(days: 7)),
        endDate: now.add(Duration(days: 23)),
        priority: 80,
      ),
      
      // ì‹ ë©”ë‰´ ë§ˆì»¤
      EventMarker(
        id: 'marker_003',
        restaurantId: 'rest_003',
        restaurantName: 'ì²­ì¶˜ê¹€ë°¥',
        type: MarkerType.newMenu,
        location: LatLng(
          userLocation.latitude + 0.001,
          userLocation.longitude - 0.002,
        ),
        title: 'ë¶ˆê³ ê¸°ê¹€ë°¥ ì‹ ë©”ë‰´ ì¶œì‹œ',
        description: 'ì¶œì‹œ ê¸°ë… 1+1 ì´ë²¤íŠ¸',
        startDate: now.subtract(Duration(days: 3)),
        endDate: now.add(Duration(days: 11)),
        priority: 60,
      ),
    ];
  }
}
```

## 3. ì§€ë„ í‘œì‹œ ë¡œì§

### [í•„ìˆ˜] ë§ˆì»¤ í‘œì‹œ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/services/marker_display_service.dart
class MarkerDisplayService {
  static const int MAX_MARKERS_PER_TYPE = 5;
  static const double MAX_DISPLAY_DISTANCE_KM = 5.0;

  List<EventMarker> getVisibleMarkers({
    required List<EventMarker> allMarkers,
    required LatLng userLocation,
    required Set<MarkerType> enabledTypes,
  }) {
    // 1. ìœ íš¨í•œ ë§ˆì»¤ë§Œ í•„í„°ë§
    final validMarkers = allMarkers
        .where((marker) => marker.isValid)
        .where((marker) => enabledTypes.contains(marker.type))
        .toList();

    // 2. ê±°ë¦¬ ê³„ì‚° ë° í•„í„°ë§
    final markersWithDistance = validMarkers.map((marker) {
      final distance = _calculateDistance(userLocation, marker.location);
      return MapEntry(marker, distance);
    }).where((entry) => entry.value <= MAX_DISPLAY_DISTANCE_KM)
      .toList();

    // 3. ìš°ì„ ìˆœìœ„ì™€ ê±°ë¦¬ë¡œ ì •ë ¬
    markersWithDistance.sort((a, b) {
      // ìš°ì„ ìˆœìœ„ ë†’ì€ ê²ƒ ë¨¼ì €
      final priorityCompare = b.key.priority.compareTo(a.key.priority);
      if (priorityCompare != 0) return priorityCompare;
      
      // ê°™ì€ ìš°ì„ ìˆœìœ„ë©´ ê°€ê¹Œìš´ ê²ƒ ë¨¼ì €
      return a.value.compareTo(b.value);
    });

    // 4. íƒ€ì…ë³„ ìµœëŒ€ ê°œìˆ˜ ì œí•œ
    final Map<MarkerType, int> typeCount = {};
    final List<EventMarker> result = [];

    for (final entry in markersWithDistance) {
      final marker = entry.key;
      final currentCount = typeCount[marker.type] ?? 0;
      
      if (currentCount < MAX_MARKERS_PER_TYPE) {
        result.add(marker);
        typeCount[marker.type] = currentCount + 1;
      }
    }

    return result;
  }

  double _calculateDistance(LatLng from, LatLng to) {
    const double earthRadius = 6371; // km
    final double dLat = _toRadians(to.latitude - from.latitude);
    final double dLon = _toRadians(to.longitude - from.longitude);
    
    final double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_toRadians(from.latitude)) * 
        cos(_toRadians(to.latitude)) *
        sin(dLon / 2) * sin(dLon / 2);
    
    final double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    return earthRadius * c;
  }

  double _toRadians(double degree) => degree * pi / 180;
}
```

### [í•„ìˆ˜] ì§€ë„ ë§ˆì»¤ UI ì»´í¬ë„ŒíŠ¸
```dart
// íŒŒì¼: lib/widgets/map_marker_widget.dart
class MapMarkerWidget extends StatelessWidget {
  final EventMarker marker;
  final VoidCallback onTap;

  const MapMarkerWidget({
    required this.marker,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: EdgeInsets.all(8),
        decoration: BoxDecoration(
          color: _getMarkerColor(marker.type),
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 4,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              marker.type.emoji,
              style: TextStyle(fontSize: 20),
            ),
            SizedBox(width: 4),
            Text(
              marker.restaurantName,
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 12,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Color _getMarkerColor(MarkerType type) {
    switch (type) {
      case MarkerType.certified:
        return Color(0xFFFFB300); // ê¸ˆìƒ‰
      case MarkerType.event:
        return Color(0xFFE91E63); // í•‘í¬
      case MarkerType.newMenu:
        return Color(0xFF4CAF50); // ì´ˆë¡
      case MarkerType.influencer:
        return Color(0xFF2196F3); // íŒŒë‘
    }
  }
}
```

## 4. ë§ˆì»¤ ë“±ë¡ í”„ë¡œì„¸ìŠ¤

### [í•„ìˆ˜] ë§ˆì»¤ ë“±ë¡ API
```python
# íŒŒì¼: backend/api/marker_endpoints.py
from flask import Blueprint, request, jsonify
from datetime import datetime, timedelta

marker_bp = Blueprint('markers', __name__)

@marker_bp.route('/markers/register', methods=['POST'])
def register_marker():
    """ì´ë²¤íŠ¸ ë§ˆì»¤ ë“±ë¡ (Mock)"""
    data = request.get_json()
    
    # Mock ì‘ë‹µ - ì‹¤ì œë¡œëŠ” DBì— ì €ì¥
    marker = {
        'id': f'marker_{datetime.now().timestamp():.0f}',
        'restaurant_id': data['restaurant_id'],
        'type': data['type'],
        'title': data['title'],
        'description': data.get('description'),
        'start_date': data['start_date'],
        'end_date': data['end_date'],
        'location': data['location'],
        'priority': _calculate_priority(data),
        'status': 'pending',  # pending, active, expired
        'created_at': datetime.now().isoformat()
    }
    
    # Mock ìŠ¬ë¡¯ í™•ì¸
    available_slots = _check_available_slots(
        data['location'],
        data['type']
    )
    
    if available_slots > 0:
        marker['status'] = 'active'
        message = 'ë§ˆì»¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'
    else:
        marker['status'] = 'waiting'
        marker['queue_position'] = _get_queue_position(data['type'])
        message = f'ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ëŒ€ê¸° ìˆœë²ˆ: {marker["queue_position"]})'
    
    return jsonify({
        'success': True,
        'marker': marker,
        'message': message,
        'available_slots': available_slots
    })

def _calculate_priority(data):
    """ìš°ì„ ìˆœìœ„ ê³„ì‚° (Mock)"""
    base_priority = {
        'certified': 100,
        'event': 80,
        'new_menu': 60,
        'influencer': 90
    }
    return base_priority.get(data['type'], 50)

def _check_available_slots(location, marker_type):
    """ê°€ìš© ìŠ¬ë¡¯ í™•ì¸ (Mock)"""
    # ì‹¤ì œë¡œëŠ” DB ì¡°íšŒ
    return 3  # Mock: 3ê°œ ìŠ¬ë¡¯ ê°€ìš©

def _get_queue_position(marker_type):
    """ëŒ€ê¸°ì—´ ìˆœë²ˆ (Mock)"""
    import random
    return random.randint(1, 10)
```

### [í•„ìˆ˜] Flutter ë§ˆì»¤ ë“±ë¡ í™”ë©´
```dart
// íŒŒì¼: lib/screens/marker_registration_screen.dart
class MarkerRegistrationScreen extends ConsumerStatefulWidget {
  final String restaurantId;

  const MarkerRegistrationScreen({required this.restaurantId});

  @override
  _MarkerRegistrationScreenState createState() => 
      _MarkerRegistrationScreenState();
}

class _MarkerRegistrationScreenState 
    extends ConsumerState<MarkerRegistrationScreen> {
  
  MarkerType _selectedType = MarkerType.event;
  final _titleController = TextEditingController();
  final _descriptionController = TextEditingController();
  DateTime _startDate = DateTime.now();
  DateTime _endDate = DateTime.now().add(Duration(days: 7));

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('ì´ë²¤íŠ¸ ë§ˆì»¤ ë“±ë¡'),
        backgroundColor: AppColors.primaryOrange,
      ),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // ë§ˆì»¤ íƒ€ì… ì„ íƒ
            Text('ë§ˆì»¤ ì¢…ë¥˜', style: AppTextStyles.heading3),
            SizedBox(height: 8),
            Wrap(
              spacing: 8,
              children: MarkerType.values.map((type) {
                return ChoiceChip(
                  label: Text('${type.emoji} ${type.label}'),
                  selected: _selectedType == type,
                  onSelected: (selected) {
                    if (selected) {
                      setState(() => _selectedType = type);
                    }
                  },
                );
              }).toList(),
            ),
            
            SizedBox(height: 24),
            
            // ì œëª© ì…ë ¥
            TextField(
              controller: _titleController,
              decoration: InputDecoration(
                labelText: 'ì´ë²¤íŠ¸ ì œëª©',
                hintText: 'ì˜ˆ: ì˜¤í”ˆ ê¸°ë… 20% í• ì¸',
                border: OutlineInputBorder(),
              ),
            ),
            
            SizedBox(height: 16),
            
            // ì„¤ëª… ì…ë ¥
            TextField(
              controller: _descriptionController,
              maxLines: 3,
              decoration: InputDecoration(
                labelText: 'ìƒì„¸ ì„¤ëª… (ì„ íƒ)',
                hintText: 'ì´ë²¤íŠ¸ ë‚´ìš©ì„ ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”',
                border: OutlineInputBorder(),
              ),
            ),
            
            SizedBox(height: 24),
            
            // ê¸°ê°„ ì„¤ì •
            Row(
              children: [
                Expanded(
                  child: _buildDatePicker(
                    label: 'ì‹œì‘ì¼',
                    date: _startDate,
                    onChanged: (date) => setState(() => _startDate = date),
                  ),
                ),
                SizedBox(width: 16),
                Expanded(
                  child: _buildDatePicker(
                    label: 'ì¢…ë£Œì¼',
                    date: _endDate,
                    onChanged: (date) => setState(() => _endDate = date),
                  ),
                ),
              ],
            ),
            
            Spacer(),
            
            // ë“±ë¡ ë²„íŠ¼
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _registerMarker,
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryOrange,
                  padding: EdgeInsets.symmetric(vertical: 16),
                ),
                child: Text(
                  'ë§ˆì»¤ ë“±ë¡í•˜ê¸°',
                  style: TextStyle(fontSize: 16),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDatePicker({
    required String label,
    required DateTime date,
    required Function(DateTime) onChanged,
  }) {
    return InkWell(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: date,
          firstDate: DateTime.now(),
          lastDate: DateTime.now().add(Duration(days: 90)),
        );
        if (picked != null) {
          onChanged(picked);
        }
      },
      child: InputDecorator(
        decoration: InputDecoration(
          labelText: label,
          border: OutlineInputBorder(),
        ),
        child: Text(
          DateFormat('yyyy-MM-dd').format(date),
          style: TextStyle(fontSize: 16),
        ),
      ),
    );
  }

  Future<void> _registerMarker() async {
    if (_titleController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')),
      );
      return;
    }

    try {
      final result = await ref
          .read(markerServiceProvider)
          .registerMarker(
            restaurantId: widget.restaurantId,
            type: _selectedType,
            title: _titleController.text,
            description: _descriptionController.text,
            startDate: _startDate,
            endDate: _endDate,
          );

      if (result.success) {
        Navigator.pop(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(result.message)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')),
      );
    }
  }
}
```

## 5. ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ

### [í•„ìˆ˜] ìš°ì„ ìˆœìœ„ ê³„ì‚° ë¡œì§
```dart
// íŒŒì¼: lib/services/marker_priority_service.dart
class MarkerPriorityService {
  static int calculatePriority({
    required MarkerType type,
    required double distanceKm,
    required DateTime startDate,
    required bool isCertified,
  }) {
    int priority = 0;
    
    // 1. ê¸°ë³¸ íƒ€ì…ë³„ ì ìˆ˜
    switch (type) {
      case MarkerType.certified:
        priority += 100;
        break;
      case MarkerType.influencer:
        priority += 90;
        break;
      case MarkerType.event:
        priority += 80;
        break;
      case MarkerType.newMenu:
        priority += 60;
        break;
    }
    
    // 2. ê±°ë¦¬ ì ìˆ˜ (ê°€ê¹Œìš¸ìˆ˜ë¡ ë†’ìŒ)
    if (distanceKm < 0.5) {
      priority += 50;
    } else if (distanceKm < 1.0) {
      priority += 40;
    } else if (distanceKm < 2.0) {
      priority += 30;
    } else if (distanceKm < 3.0) {
      priority += 20;
    } else if (distanceKm < 5.0) {
      priority += 10;
    }
    
    // 3. ì‹ ê·œì„± ì ìˆ˜ (ìµœê·¼ì¼ìˆ˜ë¡ ë†’ìŒ)
    final daysSinceStart = DateTime.now().difference(startDate).inDays;
    if (daysSinceStart < 3) {
      priority += 30;
    } else if (daysSinceStart < 7) {
      priority += 20;
    } else if (daysSinceStart < 14) {
      priority += 10;
    }
    
    // 4. ì¸ì¦ë§›ì§‘ ê°€ì‚°ì 
    if (isCertified && type != MarkerType.certified) {
      priority += 20;
    }
    
    return priority;
  }
}
```

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ë§ˆì»¤ íƒ€ì… ì •ì˜ ì™„ë£Œ
- [ ] Mock ë°ì´í„° êµ¬ì„±
- [ ] ì§€ë„ í‘œì‹œ ë¡œì§ êµ¬í˜„
- [ ] ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸