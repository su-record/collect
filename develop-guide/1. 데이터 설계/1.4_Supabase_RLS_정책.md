## 6. ê°œë°œ ìƒíƒœ ë° í†µí•© ë°©í–¥

### í˜„ì¬ êµ¬í˜„ ìƒíƒœ

#### Python ë°±ì—”ë“œ (Mock ë°ì´í„°)
```python
# íŒŒì¼: middleware/auth.py
# í˜„ì¬ êµ¬í˜„ëœ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
@require_auth  # Bearer í† í° ê²€ì¦
@optional_auth  # ì„ íƒì  ì¸ì¦

# íŒŒì¼: models/user.py
# ì°¨ë‹¨ ê´€ê³„, íƒˆí‡´ ìƒíƒœ ë“± í•„ë“œëŠ” ì´ë¯¸ ì •ì˜ë¨
blocked_user_ids: List[UUID]
deleted_at: Optional[datetime]
is_private: bool

# íŒŒì¼: models/relations.py
# ì°¨ë‹¨, ë¶ë§ˆí¬ ë“± ê´€ê³„ ëª¨ë¸ ì´ë¯¸ ì •ì˜ë¨
class Block, Bookmark, Follow
```

### Supabase ì „í™˜ ì‹œ í†µí•© ë°©í–¥

#### 1ë‹¨ê³„: ë°ì´í„° ì´ì „
```python
# Mock ë°ì´í„° â†’ Supabase DB
# í˜„ì¬ Python ëª¨ë¸ì˜ í•„ë“œë“¤ì„ PostgreSQL ìŠ¤í‚¤ë§ˆì— ë§¤í•‘
```

#### 2ë‹¨ê³„: RLS ì •ì±… ì ìš©
```sql
-- ì´ ë¬¸ì„œì˜ RLS ì •ì±…ë“¤ì„ Supabase DBì— ì ìš©
-- Python ì½”ë“œì—ì„œëŠ” ë³„ë„ ë³´ì•ˆ ì²´í¬ ë¶ˆí•„ìš”
```

#### 3ë‹¨ê³„: Python ì½”ë“œ ìˆ˜ì •
```python
# Mock ë°ì´í„° ëŒ€ì‹  Supabase Client ì‚¬ìš©
from supabase import create_client

# RLSê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ í•„í„°ë§ ì½”ë“œ ì œê±°
# ì˜ˆ: ì°¨ë‹¨ ì‚¬ìš©ì í•„í„°ë§ì€ RLSê°€ ì²˜ë¦¬
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] PostgreSQL ìŠ¤í‚¤ë§ˆì™€ Python ëª¨ë¸ í•„ë“œ ë§¤í•‘ í™•ì¸
- [ ] RLS ì •ì±…ì´ Python ëª¨ë¸ì˜ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ ì»¤ë²„
- [ ] Mock ë°ì´í„° â†’ Supabase ì „í™˜ ê³„íš ìˆ˜ë¦½
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¤€ë¹„### [ì„ íƒ] ì¶”ê°€ ë³´ì•ˆ ì •ì±…
```sql
-- íŒŒì¼: security/07_additional_policies.sql

-- ì´ë²¤íŠ¸ ë§ˆì»¤ ì •ì±…
CREATE POLICY "Active event markers viewable by everyone" 
ON event_markers FOR SELECT 
USING (
  start_date <= NOW() 
  AND end_date >= NOW()
  AND (
    is_paid = FALSE 
    OR (is_paid = TRUE AND paid_until >= NOW())
  )
);

CREATE POLICY "Admin can manage event markers" 
ON event_markers FOR ALL 
USING (
  auth.jwt() ->> 'role' = 'service_role'
);

-- ë¹„ê³µê°œ ê³„ì • ì œí•œ
CREATE POLICY "Private user feeds limited visibility" 
ON feeds FOR SELECT 
USING (
  EXISTS (
    SELECT 1 FROM users 
    WHERE users.id = feeds.user_id 
    AND (
      users.is_private = FALSE 
      OR users.id = auth.uid()
      OR EXISTS (
        SELECT 1 FROM follows 
        WHERE follower_id = auth.uid() 
        AND following_id = users.id
      )
    )
  )
);
```# ğŸ” 1.4 Supabase RLS ì •ì±…

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [RLS í™œì„±í™”](#2-rls-í™œì„±í™”)
3. [í…Œì´ë¸”ë³„ ì •ì±…](#3-í…Œì´ë¸”ë³„-ì •ì±…)
4. [ë³´ì•ˆ í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±°](#4-ë³´ì•ˆ-í•¨ìˆ˜-ë°-íŠ¸ë¦¬ê±°)
5. [í…ŒìŠ¤íŠ¸](#5-í…ŒìŠ¤íŠ¸)
6. [ê°œë°œ ìƒíƒœ ë° í†µí•© ë°©í–¥](#6-ê°œë°œ-ìƒíƒœ-ë°-í†µí•©-ë°©í–¥)

## 1. ê°œìš”

Row Level Securityë¥¼ ì„¤ì •í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ë³´ì•ˆì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
- âœ… ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©
- âœ… ëª…í™•í•œ ì ‘ê·¼ ê·œì¹™ ì •ì˜

### âš ï¸ í˜„ì¬ ê°œë°œ ìƒíƒœ
- í˜„ì¬ ë°±ì—”ë“œëŠ” **Mock ë°ì´í„° ê¸°ë°˜**ìœ¼ë¡œ ê°œë°œë¨
- RLS ì •ì±…ì€ **Supabase ì „í™˜ ì‹œ ì ìš©** ì˜ˆì •
- Python ì½”ë“œì—ì„œëŠ” ë¯¸ë“¤ì›¨ì–´ë¡œ ê¸°ë³¸ ì¸ì¦ë§Œ ì²˜ë¦¬ ì¤‘

## 2. RLS í™œì„±í™”

### [í•„ìˆ˜] ëª¨ë“  í…Œì´ë¸” RLS í™œì„±í™”
```sql
-- íŒŒì¼: security/01_enable_rls.sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE stores ENABLE ROW LEVEL SECURITY;
ALTER TABLE menus ENABLE ROW LEVEL SECURITY;
ALTER TABLE feeds ENABLE ROW LEVEL SECURITY;
ALTER TABLE recommendations ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE follows ENABLE ROW LEVEL SECURITY;
ALTER TABLE blocks ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_markers ENABLE ROW LEVEL SECURITY;
```

## 3. í…Œì´ë¸”ë³„ ì •ì±…

### [í•„ìˆ˜] users í…Œì´ë¸” ì •ì±…
```sql
-- íŒŒì¼: security/02_users_policies.sql

-- ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥ (íƒˆí‡´ ì‚¬ìš©ì ì œì™¸)
CREATE POLICY "Active users are viewable by everyone" 
ON users FOR SELECT 
USING (deleted_at IS NULL);

-- ìì‹ ì˜ í”„ë¡œí•„ë§Œ ìˆ˜ì •
CREATE POLICY "Users can update own profile" 
ON users FOR UPDATE 
USING (auth.uid() = id)
WITH CHECK (
  auth.uid() = id 
  AND deleted_at IS NULL
);

-- íšŒì›ê°€ì… ì‹œ í”„ë¡œí•„ ìƒì„±
CREATE POLICY "Users can insert own profile" 
ON users FOR INSERT 
WITH CHECK (auth.uid() = id);

-- ìì‹ ì˜ ê³„ì •ë§Œ íƒˆí‡´ (ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸)
CREATE POLICY "Users can soft delete own account" 
ON users FOR UPDATE 
USING (auth.uid() = id)
WITH CHECK (
  auth.uid() = id 
  AND deleted_at IS NOT NULL
);
```

### [í•„ìˆ˜] feeds í…Œì´ë¸” ì •ì±…
```sql
-- íŒŒì¼: security/03_feeds_policies.sql

-- ëª¨ë“  í”¼ë“œ ì¡°íšŒ ê°€ëŠ¥ (ì°¨ë‹¨ëœ ì‚¬ìš©ì ì œì™¸)
CREATE POLICY "Feeds viewable except blocked users" 
ON feeds FOR SELECT 
USING (
  NOT EXISTS (
    SELECT 1 FROM blocks 
    WHERE blocker_id = auth.uid() 
    AND blocked_id = feeds.user_id
  )
);

-- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì‘ì„±
CREATE POLICY "Authenticated users can create feeds" 
ON feeds FOR INSERT 
WITH CHECK (
  auth.role() = 'authenticated' 
  AND auth.uid() = user_id
);

-- ì‘ì„±ìë§Œ ìˆ˜ì • (2ì‹œê°„ ì ê¸ˆ í›„ ë¶ˆê°€)
CREATE POLICY "Users can update own feeds before lock" 
ON feeds FOR UPDATE 
USING (
  auth.uid() = user_id 
  AND is_points_locked = FALSE
)
WITH CHECK (
  auth.uid() = user_id 
  AND is_points_locked = FALSE
);

-- ì‘ì„±ìë§Œ ì‚­ì œ (2ì‹œê°„ ë‚´)
CREATE POLICY "Users can delete own feeds within 2 hours" 
ON feeds FOR DELETE 
USING (
  auth.uid() = user_id 
  AND created_at > NOW() - INTERVAL '2 hours'
);
```

### [í•„ìˆ˜] stores & menus ì •ì±…
```sql
-- íŒŒì¼: security/04_stores_menus_policies.sql

-- stores ì •ì±…
CREATE POLICY "Stores are viewable by everyone" 
ON stores FOR SELECT USING (true);

CREATE POLICY "Authenticated users can create stores" 
ON stores FOR INSERT 
WITH CHECK (auth.role() = 'authenticated');

-- menus ì •ì±…
CREATE POLICY "Menus are viewable by everyone" 
ON menus FOR SELECT USING (true);

CREATE POLICY "Authenticated users can create menus" 
ON menus FOR INSERT 
WITH CHECK (auth.role() = 'authenticated');
```

### [í•„ìˆ˜] ê´€ê³„ í…Œì´ë¸” ì •ì±…
```sql
-- íŒŒì¼: security/05_relations_policies.sql

-- recommendations ì •ì±…
CREATE POLICY "Recommendations are viewable by everyone" 
ON recommendations FOR SELECT USING (true);

CREATE POLICY "Authenticated users can recommend" 
ON recommendations FOR INSERT 
WITH CHECK (
  auth.role() = 'authenticated' 
  AND auth.uid() = user_id
);

CREATE POLICY "Users can delete own recommendations" 
ON recommendations FOR DELETE 
USING (auth.uid() = user_id);

-- comments ì •ì±…
CREATE POLICY "Comments are viewable by everyone" 
ON comments FOR SELECT USING (true);

CREATE POLICY "Authenticated users can comment" 
ON comments FOR INSERT 
WITH CHECK (
  auth.role() = 'authenticated' 
  AND auth.uid() = user_id
);

CREATE POLICY "Users can update own comments" 
ON comments FOR UPDATE 
USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own comments" 
ON comments FOR DELETE 
USING (auth.uid() = user_id);
```

### [ì„ íƒ] ê°œì¸ ë°ì´í„° ì •ì±…
```sql
-- íŒŒì¼: security/06_private_policies.sql

-- notifications ì •ì±… (ìì‹ ì˜ ì•Œë¦¼ë§Œ)
CREATE POLICY "Users can view own notifications" 
ON notifications FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can update own notifications" 
ON notifications FOR UPDATE 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- follows ì •ì±…
CREATE POLICY "Follow relationships are public" 
ON follows FOR SELECT 
USING (true);

CREATE POLICY "Users can follow others" 
ON follows FOR INSERT 
WITH CHECK (
  auth.uid() = follower_id
  AND follower_id != following_id
);

CREATE POLICY "Users can unfollow" 
ON follows FOR DELETE 
USING (auth.uid() = follower_id);

-- blocks ì •ì±…
CREATE POLICY "Users can view own blocks" 
ON blocks FOR SELECT 
USING (
  auth.uid() = blocker_id
);

CREATE POLICY "Users can block others" 
ON blocks FOR INSERT 
WITH CHECK (
  auth.uid() = blocker_id
  AND blocker_id != blocked_id
);

CREATE POLICY "Users can unblock" 
ON blocks FOR DELETE 
USING (auth.uid() = blocker_id);

-- bookmarks ì •ì±…
CREATE POLICY "Users can view own bookmarks" 
ON bookmarks FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can create bookmarks" 
ON bookmarks FOR INSERT 
WITH CHECK (
  auth.uid() = user_id
  AND (feed_id IS NOT NULL OR place_id IS NOT NULL)
);

CREATE POLICY "Users can delete own bookmarks" 
ON bookmarks FOR DELETE 
USING (auth.uid() = user_id);
```

## 4. ë³´ì•ˆ í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±°

### [í•„ìˆ˜] ì°¨ë‹¨ ê´€ê³„ ì²˜ë¦¬
```sql
-- íŒŒì¼: security/08_block_functions.sql

-- ì°¨ë‹¨ ì‹œ íŒ”ë¡œìš° ê´€ê³„ ìë™ ì‚­ì œ
CREATE OR REPLACE FUNCTION handle_block_relationship()
RETURNS TRIGGER AS $
BEGIN
  -- ì„œë¡œ íŒ”ë¡œìš° ê´€ê³„ ì‚­ì œ
  DELETE FROM follows 
  WHERE (follower_id = NEW.blocker_id AND following_id = NEW.blocked_id)
     OR (follower_id = NEW.blocked_id AND following_id = NEW.blocker_id);
  
  RETURN NEW;
END;
$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_block_created
AFTER INSERT ON blocks
FOR EACH ROW EXECUTE FUNCTION handle_block_relationship();
```

### [í•„ìˆ˜] ì ìˆ˜ ì ê¸ˆ ì²˜ë¦¬
```sql
-- íŒŒì¼: security/09_points_lock.sql

-- í”¼ë“œ ìƒì„± 2ì‹œê°„ í›„ ì ìˆ˜ ì ê¸ˆ
CREATE OR REPLACE FUNCTION auto_lock_feed_points()
RETURNS void AS $
BEGIN
  UPDATE feeds
  SET 
    is_points_locked = TRUE,
    points_confirmed_at = NOW()
  WHERE 
    is_points_locked = FALSE
    AND created_at <= NOW() - INTERVAL '2 hours';
END;
$ LANGUAGE plpgsql SECURITY DEFINER;

-- Cron jobë¡œ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ì˜ˆì‹œ)
-- SELECT cron.schedule('lock-feed-points', '*/5 * * * *', 'SELECT auto_lock_feed_points()');
```

## 5. í…ŒìŠ¤íŠ¸

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ë¹„ì¸ì¦ ì‚¬ìš©ì ì½ê¸° ê¶Œí•œ í™•ì¸
- [ ] ì¸ì¦ ì‚¬ìš©ì ì“°ê¸° ê¶Œí•œ í™•ì¸
- [ ] íƒ€ ì‚¬ìš©ì ë°ì´í„° ìˆ˜ì • ì°¨ë‹¨ í™•ì¸
- [ ] ê°œì¸ ë°ì´í„° ë³´í˜¸ í™•ì¸
- [ ] ì°¨ë‹¨ ê´€ê³„ ì‘ë™ í™•ì¸
- [ ] íƒˆí‡´ ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ì°¨ë‹¨
- [ ] ë¹„ê³µê°œ ê³„ì • í”¼ë“œ ë³´í˜¸
- [ ] 2ì‹œê°„ ì ê¸ˆ ì‹œìŠ¤í…œ ë™ì‘

### ğŸ§ª RLS í…ŒìŠ¤íŠ¸
```sql
-- íŒŒì¼: test/test_rls.sql

-- í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ID
DO $
DECLARE
  user1_id UUID := gen_random_uuid();
  user2_id UUID := gen_random_uuid();
  user3_id UUID := gen_random_uuid();
  feed_id UUID;
BEGIN
  -- í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ìƒì„±
  INSERT INTO users (id, email, nickname, country_code) VALUES
    (user1_id, 'rls_test1@example.com', 'rlstest1', 'KR'),
    (user2_id, 'rls_test2@example.com', 'rlstest2', 'JP'),
    (user3_id, 'rls_test3@example.com', 'rlstest3', 'US');

  -- user1ìœ¼ë¡œ í”¼ë“œ ìƒì„±
  SET LOCAL auth.uid = user1_id;
  INSERT INTO feeds (id, user_id, menu_id, store_id, content, image_urls, location) 
  VALUES (
    gen_random_uuid(),
    user1_id, 
    (SELECT id FROM menus LIMIT 1),
    (SELECT id FROM stores LIMIT 1),
    'RLS í…ŒìŠ¤íŠ¸ í”¼ë“œ',
    ARRAY['test.jpg'],
    ST_GeogFromText('POINT(127.0 37.5)')
  ) RETURNING id INTO feed_id;
  
  -- user2ë¡œ user1 í”¼ë“œ ìˆ˜ì • ì‹œë„ (ì‹¤íŒ¨í•´ì•¼ í•¨)
  SET LOCAL auth.uid = user2_id;
  BEGIN
    UPDATE feeds SET content = 'Hacked!' 
    WHERE user_id = user1_id;
    RAISE EXCEPTION 'RLS ì‹¤íŒ¨: user2ê°€ user1 í”¼ë“œ ìˆ˜ì • ê°€ëŠ¥';
  EXCEPTION
    WHEN insufficient_privilege THEN
      RAISE NOTICE 'RLS ì„±ê³µ: user2ê°€ user1 í”¼ë“œ ìˆ˜ì • ë¶ˆê°€';
  END;
  
  -- user2ê°€ user1 ì°¨ë‹¨
  INSERT INTO blocks (blocker_id, blocked_id) 
  VALUES (user2_id, user1_id);
  
  -- user2ëŠ” user1 í”¼ë“œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ì•¼ í•¨
  IF EXISTS (
    SELECT 1 FROM feeds 
    WHERE id = feed_id
  ) THEN
    RAISE EXCEPTION 'RLS ì‹¤íŒ¨: ì°¨ë‹¨ëœ ì‚¬ìš©ì í”¼ë“œ ì¡°íšŒ ê°€ëŠ¥';
  ELSE
    RAISE NOTICE 'RLS ì„±ê³µ: ì°¨ë‹¨ëœ ì‚¬ìš©ì í”¼ë“œ ì¡°íšŒ ë¶ˆê°€';
  END IF;
  
  -- ë¹„ê³µê°œ ê³„ì • í…ŒìŠ¤íŠ¸
  UPDATE users SET is_private = TRUE WHERE id = user1_id;
  
  -- user3ëŠ” ë¹„ê³µê°œ user1ì˜ í”¼ë“œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ì•¼ í•¨
  SET LOCAL auth.uid = user3_id;
  IF EXISTS (
    SELECT 1 FROM feeds 
    WHERE user_id = user1_id
  ) THEN
    RAISE EXCEPTION 'RLS ì‹¤íŒ¨: ë¹„ê³µê°œ ê³„ì • í”¼ë“œ ì¡°íšŒ ê°€ëŠ¥';
  ELSE
    RAISE NOTICE 'RLS ì„±ê³µ: ë¹„ê³µê°œ ê³„ì • í”¼ë“œ ì¡°íšŒ ë¶ˆê°€';
  END IF;
  
  -- ì •ë¦¬
  DELETE FROM users WHERE id IN (user1_id, user2_id, user3_id);
END $;
```