# ğŸ—„ï¸ 1.3 PostgreSQL ìŠ¤í‚¤ë§ˆ ì„¤ê³„

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ì´ˆê¸° ì„¤ì •](#2-ì´ˆê¸°-ì„¤ì •)
3. [í…Œì´ë¸” ìƒì„±](#3-í…Œì´ë¸”-ìƒì„±)
4. [ì¸ë±ìŠ¤ ì„¤ì •](#4-ì¸ë±ìŠ¤-ì„¤ì •)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”

Fallingo ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… PostGISë¥¼ í™œìš©í•œ ìœ„ì¹˜ ê¸°ë°˜ ì„œë¹„ìŠ¤
- âœ… ê´€ê³„í˜• DBì˜ ê°•ë ¥í•œ ì¿¼ë¦¬ í™œìš©
- âœ… ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ìœ„í•œ êµ¬ì¡° ì„¤ê³„

## 2. ì´ˆê¸° ì„¤ì •

### [í•„ìˆ˜] PostGIS í™•ì¥ ì„¤ì¹˜
```sql
-- íŒŒì¼: setup/01_extensions.sql
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_trgm;  -- í…ìŠ¤íŠ¸ ê²€ìƒ‰ìš©
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";  -- UUID ìƒì„±ìš©
```

### [í•„ìˆ˜] ê¸°ë³¸ í•¨ìˆ˜ ìƒì„±
```sql
-- íŒŒì¼: setup/02_functions.sql
-- updated_at ìë™ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

## 3. í…Œì´ë¸” ìƒì„±

### [í•„ìˆ˜] users í…Œì´ë¸”
```sql
-- íŒŒì¼: schema/01_users.sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  nickname TEXT UNIQUE NOT NULL,
  country_code TEXT NOT NULL, -- KR, JP, US ë“±
  preferred_language TEXT DEFAULT 'ko', -- ko, en, ja ë“±
  profile_image_url TEXT,
  grade INTEGER DEFAULT 1 CHECK (grade BETWEEN 1 AND 10),
  activity_points INTEGER DEFAULT 0,
  influencer_points INTEGER DEFAULT 0, -- ì¸í”Œë£¨ì–¸ì„œ ì ìˆ˜
  last_activity_bonus_at TIMESTAMPTZ, -- ë§ˆì§€ë§‰ ì¼ì¼ ë³´ìƒ ì‹œê°„
  is_influencer BOOLEAN DEFAULT FALSE,
  is_private BOOLEAN DEFAULT FALSE, -- ë¹„ê³µê°œ ê³„ì •
  deleted_at TIMESTAMPTZ, -- íƒˆí‡´ ì‹œê°„
  deletion_reason TEXT, -- íƒˆí‡´ ì‚¬ìœ 
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_grade ON users(grade);
CREATE INDEX idx_users_nickname ON users(nickname);
CREATE INDEX idx_users_country_code ON users(country_code);
CREATE INDEX idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NOT NULL;

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_users_updated_at 
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

### [í•„ìˆ˜] stores í…Œì´ë¸”
```sql
-- íŒŒì¼: schema/02_stores.sql
CREATE TABLE stores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  address TEXT NOT NULL,
  location GEOGRAPHY(POINT, 4326) NOT NULL,
  phone TEXT,
  business_hours JSONB DEFAULT '{}',
  is_certified BOOLEAN DEFAULT FALSE, -- ì¸ì¦ ì¶”ì²œë§›ì§‘
  certified_at TIMESTAMPTZ, -- ì¸ì¦ ì‹œê°„
  total_menu_count INTEGER DEFAULT 0, -- ë©”ë‰´ ìˆ˜
  total_feed_count INTEGER DEFAULT 0, -- í”¼ë“œ ìˆ˜
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ê³µê°„ ì¸ë±ìŠ¤
CREATE INDEX idx_stores_location ON stores USING GIST(location);
CREATE INDEX idx_stores_name ON stores(name);
CREATE INDEX idx_stores_certified ON stores(is_certified) WHERE is_certified = TRUE;

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_stores_updated_at 
BEFORE UPDATE ON stores
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

### [í•„ìˆ˜] menus í…Œì´ë¸”
```sql
-- íŒŒì¼: schema/03_menus.sql
CREATE TABLE menus (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  price INTEGER,
  category TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(store_id, name)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_menus_store_id ON menus(store_id);
CREATE INDEX idx_menus_category ON menus(category);

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_menus_updated_at 
BEFORE UPDATE ON menus
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

### [í•„ìˆ˜] feeds í…Œì´ë¸”
```sql
-- íŒŒì¼: schema/04_feeds.sql
CREATE TABLE feeds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  menu_id UUID NOT NULL REFERENCES menus(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  image_urls TEXT[] NOT NULL CHECK (array_length(image_urls, 1) >= 1 AND array_length(image_urls, 1) <= 5),
  tags TEXT[] DEFAULT '{}',
  location GEOGRAPHY(POINT, 4326) NOT NULL,
  floor TEXT, -- ì¸µ ì •ë³´ (ë³µí•©ëª°/ê±´ë¬¼)
  shop_name TEXT, -- ê°€ê²Œëª… (ì‚¬ìš©ì ì…ë ¥)
  is_verified BOOLEAN DEFAULT FALSE,
  verification_data JSONB DEFAULT '{}',
  recommendation_count INTEGER DEFAULT 0,
  comment_count INTEGER DEFAULT 0,
  bookmark_count INTEGER DEFAULT 0,
  -- OCR ê´€ë ¨
  ocr_status TEXT DEFAULT 'none' CHECK (ocr_status IN ('none', 'pending', 'completed', 'failed')),
  ocr_processed_at TIMESTAMPTZ,
  receipt_image_url TEXT,
  -- ê¸€ë¡œë²Œ í•« í”¼ë“œ
  is_global_hot BOOLEAN DEFAULT FALSE,
  -- ì ìˆ˜ ì‹œìŠ¤í…œ
  points_confirmed_at TIMESTAMPTZ, -- 2ì‹œê°„ ì ê¸ˆ í›„ ì ìˆ˜ í™•ì • ì‹œê°„
  is_points_locked BOOLEAN DEFAULT FALSE, -- ì ìˆ˜ ì ê¸ˆ ìƒíƒœ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_feeds_user_id ON feeds(user_id);
CREATE INDEX idx_feeds_menu_id ON feeds(menu_id);
CREATE INDEX idx_feeds_store_id ON feeds(store_id);
CREATE INDEX idx_feeds_location ON feeds USING GIST(location);
CREATE INDEX idx_feeds_created_at ON feeds(created_at DESC);
CREATE INDEX idx_feeds_tags ON feeds USING GIN(tags);
CREATE INDEX idx_feeds_ocr_status ON feeds(ocr_status) WHERE ocr_status != 'none';
CREATE INDEX idx_feeds_global_hot ON feeds(is_global_hot) WHERE is_global_hot = TRUE;
CREATE INDEX idx_feeds_points_confirmed ON feeds(points_confirmed_at) WHERE points_confirmed_at IS NOT NULL;

-- íŠ¸ë¦¬ê±°
CREATE TRIGGER update_feeds_updated_at 
BEFORE UPDATE ON feeds
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

### [í•„ìˆ˜] ê´€ê³„ í…Œì´ë¸”ë“¤
```sql
-- íŒŒì¼: schema/05_relations.sql

-- ì¶”ì²œ í…Œì´ë¸”
CREATE TABLE recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  feed_id UUID NOT NULL REFERENCES feeds(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, feed_id)
);

CREATE INDEX idx_recommendations_feed_id ON recommendations(feed_id);
CREATE INDEX idx_recommendations_user_id ON recommendations(user_id);

-- ëŒ“ê¸€ í…Œì´ë¸”
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feed_id UUID NOT NULL REFERENCES feeds(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_comments_feed_id ON comments(feed_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);

-- íŒ”ë¡œìš° í…Œì´ë¸”
CREATE TABLE follows (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  follower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  following_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(follower_id, following_id),
  CHECK (follower_id != following_id)
);

CREATE INDEX idx_follows_follower_id ON follows(follower_id);
CREATE INDEX idx_follows_following_id ON follows(following_id);

-- ì°¨ë‹¨ í…Œì´ë¸”
CREATE TABLE blocks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  blocker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  blocked_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(blocker_id, blocked_id),
  CHECK (blocker_id != blocked_id)
);

CREATE INDEX idx_blocks_blocker_id ON blocks(blocker_id);
CREATE INDEX idx_blocks_blocked_id ON blocks(blocked_id);

-- ë¶ë§ˆí¬ í…Œì´ë¸”
CREATE TABLE bookmarks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  feed_id UUID REFERENCES feeds(id) ON DELETE CASCADE,
  place_id UUID REFERENCES stores(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CHECK (feed_id IS NOT NULL OR place_id IS NOT NULL),
  UNIQUE(user_id, feed_id),
  UNIQUE(user_id, place_id)
);

CREATE INDEX idx_bookmarks_user_id ON bookmarks(user_id);
CREATE INDEX idx_bookmarks_feed_id ON bookmarks(feed_id) WHERE feed_id IS NOT NULL;
CREATE INDEX idx_bookmarks_place_id ON bookmarks(place_id) WHERE place_id IS NOT NULL;
```

### [ì„ íƒ] ì¶”ê°€ í…Œì´ë¸”ë“¤
```sql
-- íŒŒì¼: schema/06_optional.sql

-- ì•Œë¦¼ í…Œì´ë¸”
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  data JSONB DEFAULT '{}',
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);

-- ì´ë²¤íŠ¸ ë§ˆì»¤ í…Œì´ë¸”
CREATE TABLE event_markers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN ('new_menu', 'discount', 'festival', 'popup')),
  title TEXT NOT NULL,
  description TEXT,
  location GEOGRAPHY(POINT, 4326) NOT NULL,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ NOT NULL,
  slot_number INTEGER CHECK (slot_number BETWEEN 1 AND 5), -- 1-5 ìŠ¬ë¡¯ ë²ˆí˜¸
  is_paid BOOLEAN DEFAULT FALSE,
  paid_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_event_markers_location ON event_markers USING GIST(location);
CREATE INDEX idx_event_markers_dates ON event_markers(start_date, end_date);
CREATE INDEX idx_event_markers_paid ON event_markers(is_paid, paid_until) WHERE is_paid = TRUE;
```

## 4. ì¸ë±ìŠ¤ ì„¤ì •

### [í•„ìˆ˜] ì¶”ê°€ ìµœì í™” ì¸ë±ìŠ¤
```sql
-- íŒŒì¼: schema/07_optimization.sql

-- ì¶”ì²œìˆ˜ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION update_recommendation_count()
RETURNS TRIGGER AS $
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE feeds SET recommendation_count = recommendation_count + 1
    WHERE id = NEW.feed_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE feeds SET recommendation_count = recommendation_count - 1
    WHERE id = OLD.feed_id;
  END IF;
  RETURN NEW;
END;
$ LANGUAGE plpgsql;

-- ëŒ“ê¸€ìˆ˜ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION update_comment_count()
RETURNS TRIGGER AS $
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE feeds SET comment_count = comment_count + 1
    WHERE id = NEW.feed_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE feeds SET comment_count = comment_count - 1
    WHERE id = OLD.feed_id;
  END IF;
  RETURN NEW;
END;
$ LANGUAGE plpgsql;

-- ë¶ë§ˆí¬ìˆ˜ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION update_bookmark_count()
RETURNS TRIGGER AS $
BEGIN
  IF TG_OP = 'INSERT' AND NEW.feed_id IS NOT NULL THEN
    UPDATE feeds SET bookmark_count = bookmark_count + 1
    WHERE id = NEW.feed_id;
  ELSIF TG_OP = 'DELETE' AND OLD.feed_id IS NOT NULL THEN
    UPDATE feeds SET bookmark_count = bookmark_count - 1
    WHERE id = OLD.feed_id;
  END IF;
  RETURN NEW;
END;
$ LANGUAGE plpgsql;

CREATE TRIGGER update_feed_recommendation_count
AFTER INSERT OR DELETE ON recommendations
FOR EACH ROW EXECUTE FUNCTION update_recommendation_count();

CREATE TRIGGER update_feed_comment_count
AFTER INSERT OR DELETE ON comments
FOR EACH ROW EXECUTE FUNCTION update_comment_count();

CREATE TRIGGER update_feed_bookmark_count
AFTER INSERT OR DELETE ON bookmarks
FOR EACH ROW EXECUTE FUNCTION update_bookmark_count();

-- ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_nearby_feeds(
  user_location GEOGRAPHY,
  radius_meters INTEGER DEFAULT 1000
)
RETURNS TABLE (
  feed_id UUID,
  distance_meters FLOAT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    f.id,
    ST_Distance(f.location, user_location) as distance_meters
  FROM feeds f
  WHERE ST_DWithin(f.location, user_location, radius_meters)
  ORDER BY distance_meters ASC;
END;
$$ LANGUAGE plpgsql;
```

## 5. ì¶”ê°€ ê³ ë ¤ì‚¬í•­

### [í•„ìˆ˜] ì‚¬ìš©ì í†µê³„ ë·°
```sql
-- íŒŒì¼: schema/08_views.sql
CREATE OR REPLACE VIEW user_stats AS
SELECT 
  u.id as user_id,
  COUNT(DISTINCT f.id) as feed_count,
  COUNT(DISTINCT fl1.follower_id) as follower_count,
  COUNT(DISTINCT fl2.following_id) as following_count,
  COUNT(DISTINCT b.id) as bookmark_count,
  SUM(f.recommendation_count) as received_recommendation_count,
  COUNT(DISTINCT f.store_id) as visited_place_count
FROM users u
LEFT JOIN feeds f ON u.id = f.user_id
LEFT JOIN follows fl1 ON u.id = fl1.following_id
LEFT JOIN follows fl2 ON u.id = fl2.follower_id
LEFT JOIN bookmarks b ON u.id = b.user_id
GROUP BY u.id;
```

### [í•„ìˆ˜] Python ëª¨ë¸ê³¼ì˜ ë§¤í•‘
```sql
-- íŒŒì¼: schema/09_comments.sql
-- Python ëª¨ë¸ê³¼ PostgreSQL ìŠ¤í‚¤ë§ˆ ë§¤í•‘ ê´€ê³„
COMMENT ON TABLE users IS 'Python: models.user.User';
COMMENT ON TABLE stores IS 'Python: models.feed.Store';
COMMENT ON TABLE menus IS 'Python: models.feed.Menu';
COMMENT ON TABLE feeds IS 'Python: models.feed.Feed';
COMMENT ON TABLE event_markers IS 'Python: models.event_marker.EventMarker';
COMMENT ON TABLE follows IS 'Python: models.relations.Follow';
COMMENT ON TABLE blocks IS 'Python: models.relations.Block';
COMMENT ON TABLE bookmarks IS 'Python: models.relations.Bookmark';
COMMENT ON TABLE recommendations IS 'Python: models.relations.FeedRecommendation';
COMMENT ON TABLE comments IS 'Python: models.relations.Comment';

-- GeoPoint ì²˜ë¦¬ ë°©ë²•
COMMENT ON COLUMN feeds.location IS 'Python GeoPoint ê°ì²´ë¡œ ë³€í™˜: PostGIS POINT <-> GeoPoint(latitude, longitude)';
COMMENT ON COLUMN stores.location IS 'Python GeoPoint ê°ì²´ë¡œ ë³€í™˜: PostGIS POINT <-> GeoPoint(latitude, longitude)';
COMMENT ON COLUMN event_markers.location IS 'Python GeoPoint ê°ì²´ë¡œ ë³€í™˜: PostGIS POINT <-> GeoPoint(latitude, longitude)';
```

## 6. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] PostGIS í™•ì¥ ì„¤ì¹˜ í™•ì¸
- [ ] ëª¨ë“  í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- [ ] ì™¸ë˜í‚¤ ê´€ê³„ ì •ìƒ ì‘ë™
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
- [ ] íŠ¸ë¦¬ê±° ë™ì‘ í…ŒìŠ¤íŠ¸
- [ ] Python ëª¨ë¸ê³¼ì˜ ì¼ì¹˜ì„± í™•ì¸

### ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„°
```sql
-- íŒŒì¼: test/seed_data.sql
-- í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì
INSERT INTO users (email, nickname, country_code, grade) VALUES
  ('test1@example.com', 'í…ŒìŠ¤íŠ¸ìœ ì €1', 'KR', 1),
  ('test2@example.com', 'í…ŒìŠ¤íŠ¸ìœ ì €2', 'JP', 3);

-- í…ŒìŠ¤íŠ¸ ì í¬
INSERT INTO stores (name, address, location) VALUES
  ('ë§›ìˆëŠ” ê¹€ì¹˜ì°Œê°œ', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', ST_GeogFromText('POINT(127.0276 37.4979)')),
  ('ìµœê³  ì‚¼ê²¹ì‚´', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', ST_GeogFromText('POINT(127.0336 37.5172)'));
```