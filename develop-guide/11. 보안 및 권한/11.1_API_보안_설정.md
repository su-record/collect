# ğŸ” 11.1 API ë³´ì•ˆ ì„¤ì •

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [API ì¸ì¦ ë¯¸ë“¤ì›¨ì–´](#2-api-ì¸ì¦-ë¯¸ë“¤ì›¨ì–´)
3. [Rate Limiting](#3-rate-limiting)
4. [CORS ì„¤ì •](#4-cors-ì„¤ì •)
5. [SQL ì¸ì ì…˜ ë°©ì§€](#5-sql-ì¸ì ì…˜-ë°©ì§€)
6. [ê²€ì¦](#6-ê²€ì¦)

## 1. ê°œìš”
Flask API ì„œë²„ì˜ ë³´ì•ˆì„ ê°•í™”í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ì„¤ì •ë“¤ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… Supabase Auth í† í° ê²€ì¦
- âœ… API ìš”ì²­ ì†ë„ ì œí•œ
- âœ… CORS ì •ì±… ì„¤ì •
- âœ… ì…ë ¥ê°’ ê²€ì¦ ë° SQL ì¸ì ì…˜ ë°©ì§€

## 2. API ì¸ì¦ ë¯¸ë“¤ì›¨ì–´

### [í•„ìˆ˜] Supabase Auth í† í° ê²€ì¦
```python
# íŒŒì¼: backend/middleware/auth.py
import functools
from flask import request, jsonify, current_app
from supabase import create_client, Client
import jwt
import os

def get_supabase_client() -> Client:
    """Supabase í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸°"""
    url = os.getenv('SUPABASE_URL', 'http://localhost:54321')
    key = os.getenv('SUPABASE_ANON_KEY', 'your-anon-key')
    return create_client(url, key)

def require_auth(f):
    """API ì¸ì¦ ë°ì½”ë ˆì´í„°"""
    @functools.wraps(f)
    def decorated_function(*args, **kwargs):
        # Authorization í—¤ë” í™•ì¸
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'error': 'UNAUTHORIZED',
                'message': 'ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤'
            }), 401
        
        try:
            # Bearer í† í° ì¶”ì¶œ
            token = auth_header.split(' ')[1]
            
            # ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” Mock í† í° í—ˆìš©
            if current_app.config.get('TESTING') or os.getenv('FLASK_ENV') == 'local':
                if token == 'mock-token-123':
                    request.user = {
                        'uid': 'mock-user-123',
                        'email': 'test@fallingo.com'
                    }
                    return f(*args, **kwargs)
            
            # Supabase JWT í† í° ê²€ì¦
            supabase = get_supabase_client()
            
            # JWT secretë¡œ í† í° ê²€ì¦
            jwt_secret = os.getenv('SUPABASE_JWT_SECRET', 'your-jwt-secret')
            decoded_token = jwt.decode(
                token, 
                jwt_secret, 
                algorithms=['HS256'],
                audience='authenticated'
            )
            
            # ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            user_response = supabase.auth.get_user(token)
            if user_response.user:
                request.user = {
                    'uid': user_response.user.id,
                    'email': user_response.user.email,
                    'user_metadata': user_response.user.user_metadata
                }
            else:
                raise Exception('User not found')
            
        except Exception as e:
            current_app.logger.error(f"Token verification failed: {str(e)}")
            return jsonify({
                'success': False,
                'error': 'INVALID_TOKEN',
                'message': 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤'
            }), 401
        
        return f(*args, **kwargs)
    
    return decorated_function
```

### [í•„ìˆ˜] ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦
```python
# íŒŒì¼: backend/middleware/admin.py
from flask import request, jsonify
from .auth import require_auth
import functools

# ê´€ë¦¬ì UID ëª©ë¡ (í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬ ê¶Œì¥)
ADMIN_UIDS = ['admin-uid-1', 'admin-uid-2']

def require_admin(f):
    """ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ ë°ì½”ë ˆì´í„°"""
    @require_auth  # ë¨¼ì € ì¸ì¦ í™•ì¸
    @functools.wraps(f)
    def decorated_function(*args, **kwargs):
        user = request.user
        
        if user['uid'] not in ADMIN_UIDS:
            return jsonify({
                'success': False,
                'error': 'FORBIDDEN',
                'message': 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤'
            }), 403
        
        return f(*args, **kwargs)
    
    return decorated_function
```

## 3. Rate Limiting

### [í•„ìˆ˜] Flask-Limiter ì„¤ì •
```python
# íŒŒì¼: backend/middleware/rate_limit.py
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from flask import current_app

def get_identifier():
    """Rate limit ì‹ë³„ì ê²°ì •"""
    # ì¸ì¦ëœ ì‚¬ìš©ìëŠ” UIDë¡œ, ì•„ë‹ˆë©´ IPë¡œ ì œí•œ
    if hasattr(request, 'user') and request.user:
        return request.user['uid']
    return get_remote_address()

# Limiter ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
limiter = Limiter(
    key_func=get_identifier,
    default_limits=["1000 per hour"],  # ê¸°ë³¸ ì œí•œ
    storage_uri="memory://"  # ë¡œì»¬: ë©”ëª¨ë¦¬, ìš´ì˜: Redis ê¶Œì¥
)

# APIë³„ ì œí•œ ì„¤ì •
RATE_LIMITS = {
    'feed_create': '10 per hour',      # í”¼ë“œ ìƒì„±
    'image_upload': '20 per hour',     # ì´ë¯¸ì§€ ì—…ë¡œë“œ
    'search': '100 per minute',        # ê²€ìƒ‰
    'ranking': '60 per minute',        # ë­í‚¹ ì¡°íšŒ
    'default': '200 per minute'        # ê¸°ë³¸ê°’
}
```

### [í•„ìˆ˜] Rate Limit ì ìš©
```python
# íŒŒì¼: backend/app.py (ìˆ˜ì •)
from flask import Flask, jsonify
from middleware.rate_limit import limiter, RATE_LIMITS

def create_app():
    app = Flask(__name__)
    
    # Rate limiter ì´ˆê¸°í™”
    limiter.init_app(app)
    
    # Rate limit ì´ˆê³¼ ì‹œ ì‘ë‹µ
    @app.errorhandler(429)
    def ratelimit_handler(e):
        return jsonify({
            'success': False,
            'error': 'RATE_LIMIT_EXCEEDED',
            'message': f'ìš”ì²­ í•œë„ ì´ˆê³¼: {e.description}',
            'retry_after': e.retry_after
        }), 429
    
    return app

# ì‚¬ìš© ì˜ˆì‹œ: routes/feed.py
@app.route('/api/feeds', methods=['POST'])
@require_auth
@limiter.limit(RATE_LIMITS['feed_create'])
def create_feed():
    # í”¼ë“œ ìƒì„± ë¡œì§
    pass
```

## 4. CORS ì„¤ì •

### [í•„ìˆ˜] Flask-CORS ì„¤ì •
```python
# íŒŒì¼: backend/config.py
import os

class Config:
    # í™˜ê²½ë³„ CORS ì„¤ì •
    CORS_ORIGINS = {
        'local': ['http://localhost:*', 'http://127.0.0.1:*'],
        'development': ['https://dev.fallingo.com'],
        'production': ['https://fallingo.com', 'https://www.fallingo.com']
    }
    
    @staticmethod
    def get_cors_config():
        env = os.getenv('FLASK_ENV', 'local')
        return {
            'origins': Config.CORS_ORIGINS.get(env, []),
            'methods': ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
            'allow_headers': ['Content-Type', 'Authorization'],
            'expose_headers': ['X-Total-Count', 'X-Page-Count'],
            'supports_credentials': True,
            'max_age': 3600
        }
```

### [í•„ìˆ˜] CORS ì ìš©
```python
# íŒŒì¼: backend/app.py (ì¶”ê°€)
from flask_cors import CORS
from config import Config

def create_app():
    app = Flask(__name__)
    
    # CORS ì„¤ì •
    cors_config = Config.get_cors_config()
    CORS(app, **cors_config)
    
    # Preflight ìš”ì²­ ì²˜ë¦¬
    @app.before_request
    def handle_preflight():
        if request.method == "OPTIONS":
            response = make_response()
            response.headers.add("Access-Control-Allow-Origin", "*")
            response.headers.add("Access-Control-Allow-Headers", "*")
            response.headers.add("Access-Control-Allow-Methods", "*")
            return response
    
    return app
```

## 5. SQL ì¸ì ì…˜ ë°©ì§€

### [í•„ìˆ˜] ì…ë ¥ê°’ ê²€ì¦
```python
# íŒŒì¼: backend/utils/validators.py
import re
from flask import jsonify
import functools

def validate_input(rules):
    """ì…ë ¥ê°’ ê²€ì¦ ë°ì½”ë ˆì´í„°"""
    def decorator(f):
        @functools.wraps(f)
        def decorated_function(*args, **kwargs):
            data = request.get_json() or {}
            
            for field, rule in rules.items():
                value = data.get(field)
                
                # í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if rule.get('required') and not value:
                    return jsonify({
                        'success': False,
                        'error': 'VALIDATION_ERROR',
                        'message': f'{field}ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤'
                    }), 400
                
                # íƒ€ì… ê²€ì¦
                if value and 'type' in rule:
                    if not isinstance(value, rule['type']):
                        return jsonify({
                            'success': False,
                            'error': 'VALIDATION_ERROR',
                            'message': f'{field}ì˜ íƒ€ì…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤'
                        }), 400
                
                # ê¸¸ì´ ê²€ì¦
                if value and 'max_length' in rule:
                    if len(str(value)) > rule['max_length']:
                        return jsonify({
                            'success': False,
                            'error': 'VALIDATION_ERROR',
                            'message': f'{field}ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤'
                        }), 400
                
                # íŒ¨í„´ ê²€ì¦
                if value and 'pattern' in rule:
                    if not re.match(rule['pattern'], str(value)):
                        return jsonify({
                            'success': False,
                            'error': 'VALIDATION_ERROR',
                            'message': f'{field}ì˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤'
                        }), 400
            
            return f(*args, **kwargs)
        
        return decorated_function
    return decorator

# ì‚¬ìš© ì˜ˆì‹œ
@app.route('/api/feeds', methods=['POST'])
@require_auth
@validate_input({
    'menu_name': {'required': True, 'type': str, 'max_length': 100},
    'content': {'required': True, 'type': str, 'max_length': 500},
    'tags': {'type': list, 'max_length': 10},
    'price': {'type': int, 'pattern': r'^\d+$'}
})
def create_feed():
    # ê²€ì¦ëœ ë°ì´í„° ì‚¬ìš©
    pass
```

### [í•„ìˆ˜] Supabase ì‚¬ìš© ì‹œ ë³´ì•ˆ
```python
# íŒŒì¼: backend/utils/supabase_security.py
from supabase import Client
import html

def sanitize_string(value):
    """ë¬¸ìì—´ ì‚´ê·  ì²˜ë¦¬"""
    if not isinstance(value, str):
        return value
    
    # HTML ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„
    value = html.escape(value)
    
    # íŠ¹ìˆ˜ë¬¸ì ì œê±° (í•„ìš”ì‹œ)
    # value = re.sub(r'[<>\"\'%;()&+]', '', value)
    
    return value.strip()

def safe_supabase_write(table, data, supabase_client):
    """ì•ˆì „í•œ Supabase ì“°ê¸°"""
    # ëª¨ë“  ë¬¸ìì—´ í•„ë“œ ì‚´ê· 
    sanitized_data = {}
    for key, value in data.items():
        if isinstance(value, str):
            sanitized_data[key] = sanitize_string(value)
        elif isinstance(value, list):
            # ë¦¬ìŠ¤íŠ¸ ë‚´ ë¬¸ìì—´ë„ ì²˜ë¦¬
            sanitized_data[key] = [
                sanitize_string(item) if isinstance(item, str) else item
                for item in value
            ]
        else:
            sanitized_data[key] = value
    
    # Supabase ì“°ê¸° (ìë™ SQL ì¸ì ì…˜ ë°©ì§€)
    response = supabase_client.table(table).insert(sanitized_data).execute()
    
    return response.data
```

### [ì„ íƒ] API í‚¤ ë³´í˜¸
```python
# íŒŒì¼: backend/config.py (ì¶”ê°€)
import os
from cryptography.fernet import Fernet

class SecureConfig:
    # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì•”í˜¸í™” í‚¤ ë¡œë“œ
    ENCRYPTION_KEY = os.getenv('ENCRYPTION_KEY', Fernet.generate_key())
    
    @staticmethod
    def encrypt_api_key(api_key):
        """API í‚¤ ì•”í˜¸í™”"""
        f = Fernet(SecureConfig.ENCRYPTION_KEY)
        return f.encrypt(api_key.encode()).decode()
    
    @staticmethod
    def decrypt_api_key(encrypted_key):
        """API í‚¤ ë³µí˜¸í™”"""
        f = Fernet(SecureConfig.ENCRYPTION_KEY)
        return f.decrypt(encrypted_key.encode()).decode()
```

## 6. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] Supabase Auth í† í°ìœ¼ë¡œ API í˜¸ì¶œ ì‹œ ì •ìƒ ë™ì‘
- [ ] ì˜ëª»ëœ í† í°ìœ¼ë¡œ í˜¸ì¶œ ì‹œ 401 ì—ëŸ¬ ë°˜í™˜
- [ ] Rate limit ì´ˆê³¼ ì‹œ 429 ì—ëŸ¬ ë° retry_after ë°˜í™˜
- [ ] CORS preflight ìš”ì²­ ì •ìƒ ì²˜ë¦¬
- [ ] ì˜ëª»ëœ ì…ë ¥ê°’ ì „ì†¡ ì‹œ 400 ì—ëŸ¬ ë°˜í™˜
- [ ] íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ë°ì´í„° ì €ì¥ ì‹œ ì´ìŠ¤ì¼€ì´í”„ í™•ì¸

### ğŸ§ª í…ŒìŠ¤íŠ¸ ì½”ë“œ
```python
# íŒŒì¼: backend/tests/test_security.py
import pytest
from app import create_app

class TestAPISecurity:
    def test_unauthorized_request(self, client):
        """ì¸ì¦ ì—†ëŠ” ìš”ì²­ í…ŒìŠ¤íŠ¸"""
        response = client.post('/api/feeds')
        assert response.status_code == 401
        assert response.json['error'] == 'UNAUTHORIZED'
    
    def test_invalid_token(self, client):
        """ì˜ëª»ëœ í† í° í…ŒìŠ¤íŠ¸"""
        headers = {'Authorization': 'Bearer invalid-token'}
        response = client.post('/api/feeds', headers=headers)
        assert response.status_code == 401
        assert response.json['error'] == 'INVALID_TOKEN'
    
    def test_rate_limit(self, client, auth_headers):
        """Rate limit í…ŒìŠ¤íŠ¸"""
        # ì œí•œ ì´ˆê³¼ê¹Œì§€ ìš”ì²­
        for i in range(11):  # feed_createëŠ” 10/hour
            response = client.post('/api/feeds', 
                                 headers=auth_headers,
                                 json={'menu_name': 'test'})
        
        assert response.status_code == 429
        assert 'retry_after' in response.json
```