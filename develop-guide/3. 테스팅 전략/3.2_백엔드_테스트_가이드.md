# ğŸ§ª 3.2 ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [API í…ŒìŠ¤íŠ¸](#2-api-í…ŒìŠ¤íŠ¸)
3. [Mock ì„¤ì •](#3-mock-ì„¤ì •)
4. [í…ŒìŠ¤íŠ¸ ì‹¤í–‰](#4-í…ŒìŠ¤íŠ¸-ì‹¤í–‰)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”
Flask ë°±ì—”ë“œì˜ ì•ˆì •ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ì²´ê³„ì ì¸ í…ŒìŠ¤íŠ¸ ì „ëµì…ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… pytest ê¸°ë°˜ í…ŒìŠ¤íŠ¸
- âœ… Mock Supabase í´ë¼ì´ì–¸íŠ¸
- âœ… API ì—”ë“œí¬ì¸íŠ¸ ì „ì²´ ê²€ì¦

### [í•„ìˆ˜] í…ŒìŠ¤íŠ¸ êµ¬ì¡°
```
backend/tests/
â”œâ”€â”€ conftest.py         # pytest ì„¤ì •
â”œâ”€â”€ test_auth.py        # ì¸ì¦ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ test_feeds.py       # í”¼ë“œ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ test_users.py       # ì‚¬ìš©ì í…ŒìŠ¤íŠ¸
â””â”€â”€ utils/              # í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹°
```

## 2. API í…ŒìŠ¤íŠ¸

### [í•„ìˆ˜] pytest ì„¤ì •
```python
# íŒŒì¼: backend/tests/conftest.py
import os
import sys
import pytest

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app import create_app
from mock_data.data_factory import MockDataFactory

@pytest.fixture
def app():
    """í…ŒìŠ¤íŠ¸ìš© Flask ì•±"""
    # í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
    os.environ['FLASK_ENV'] = 'testing'
    os.environ['APP_ENV'] = 'local'
    
    app = create_app()
    app.config['TESTING'] = True
    app.config['SECRET_KEY'] = 'test-secret-key'
    
    yield app

@pytest.fixture
def client(app):
    """í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸"""
    return app.test_client()

@pytest.fixture
def auth_headers():
    """ì¸ì¦ í—¤ë”"""
    return {
        'Authorization': 'Bearer test_token_123',
        'Content-Type': 'application/json'
    }

@pytest.fixture
def mock_user():
    """Mock ì‚¬ìš©ì ë°ì´í„°"""
    return MockDataFactory.create_user(
        user_id='test-user-123',
        grade=3,
        country_code='KR'
    )

@pytest.fixture
def api_base_url():
    """API ê¸°ë³¸ URL"""
    return '/api'
```

### [í•„ìˆ˜] Supabase Mock í´ë¼ì´ì–¸íŠ¸
```python
# íŒŒì¼: backend/tests/conftest.py (ê³„ì†)
class MockSupabaseClient:
    """Supabase í´ë¼ì´ì–¸íŠ¸ Mock"""
    
    def __init__(self):
        self.auth = MockAuthClient()
        self.table = self._table
        self._data = {}
    
    def _table(self, name):
        """í…Œì´ë¸” Mock"""
        return MockTable(name, self._data)

class MockAuthClient:
    """Supabase Auth Mock"""
    
    def sign_in_with_id_token(self, provider, token):
        """ì†Œì…œ ë¡œê·¸ì¸ Mock"""
        if token == 'valid_token':
            return {
                'user': {
                    'id': 'test-user-123',
                    'email': 'test@example.com'
                },
                'session': {
                    'access_token': 'test_access_token',
                    'refresh_token': 'test_refresh_token'
                }
            }
        else:
            raise Exception('Invalid token')
    
    def refresh_session(self, refresh_token):
        """í† í° ê°±ì‹  Mock"""
        if refresh_token == 'valid_refresh_token':
            return {
                'session': {
                    'access_token': 'new_access_token'
                }
            }
        else:
            raise Exception('Invalid refresh token')

class MockTable:
    """Supabase í…Œì´ë¸” Mock"""
    
    def __init__(self, name, data_store):
        self.name = name
        self.data_store = data_store
        if name not in data_store:
            data_store[name] = {}
    
    def select(self, *args):
        """SELECT Mock"""
        self._select_args = args
        return self
    
    def insert(self, data):
        """INSERT Mock"""
        self._insert_data = data
        return self
    
    def update(self, data):
        """UPDATE Mock"""
        self._update_data = data
        return self
    
    def delete(self):
        """DELETE Mock"""
        self._delete = True
        return self
    
    def eq(self, column, value):
        """WHERE ì¡°ê±´ Mock"""
        self._eq_filter = (column, value)
        return self
    
    def execute(self):
        """ì¿¼ë¦¬ ì‹¤í–‰ Mock"""
        if hasattr(self, '_insert_data'):
            # INSERT
            data = self._insert_data
            if 'id' not in data:
                data['id'] = f"{self.name}-{len(self.data_store[self.name])}"
            self.data_store[self.name][data['id']] = data
            return {'data': [data], 'error': None}
            
        elif hasattr(self, '_update_data'):
            # UPDATE
            if hasattr(self, '_eq_filter'):
                column, value = self._eq_filter
                for item_id, item in self.data_store[self.name].items():
                    if item.get(column) == value:
                        item.update(self._update_data)
                        return {'data': [item], 'error': None}
                        
        elif hasattr(self, '_delete'):
            # DELETE
            if hasattr(self, '_eq_filter'):
                column, value = self._eq_filter
                to_delete = []
                for item_id, item in self.data_store[self.name].items():
                    if item.get(column) == value:
                        to_delete.append(item_id)
                for item_id in to_delete:
                    del self.data_store[self.name][item_id]
                return {'data': [], 'error': None}
                
        else:
            # SELECT
            results = list(self.data_store[self.name].values())
            if hasattr(self, '_eq_filter'):
                column, value = self._eq_filter
                results = [r for r in results if r.get(column) == value]
            return {'data': results, 'error': None}

@pytest.fixture
def mock_supabase(monkeypatch):
    """Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ Mockìœ¼ë¡œ êµì²´"""
    mock_client = MockSupabaseClient()
    
    # ì‹¤ì œ importë¥¼ Mockìœ¼ë¡œ êµì²´
    def mock_create_client(*args, **kwargs):
        return mock_client
    
    monkeypatch.setattr('supabase.create_client', mock_create_client)
    
    return mock_client
```

### [í•„ìˆ˜] ì¸ì¦ API í…ŒìŠ¤íŠ¸
```python
# íŒŒì¼: backend/tests/test_auth.py
import json
import pytest

class TestAuthAPI:
    """ì¸ì¦ ê´€ë ¨ API í…ŒìŠ¤íŠ¸"""
    
    def test_login_success(self, client, mock_supabase, api_base_url):
        """ì†Œì…œ ë¡œê·¸ì¸ ì„±ê³µ í…ŒìŠ¤íŠ¸"""
        # Given
        data = {
            'provider': 'google',
            'idToken': 'valid_token'
        }
        
        # When
        response = client.post(
            f'{api_base_url}/auth/login',
            data=json.dumps(data),
            content_type='application/json'
        )
        
        # Then
        assert response.status_code == 200
        result = json.loads(response.data)
        assert result['status'] == 'success'
        assert 'accessToken' in result['data']
        assert 'refreshToken' in result['data']
        assert 'user' in result['data']
        assert result['data']['user']['id'] == 'test-user-123'
    
    def test_login_invalid_token(self, client, mock_supabase, api_base_url):
        """ì˜ëª»ëœ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„"""
        # Given
        data = {
            'provider': 'google',
            'idToken': 'invalid_token'
        }
        
        # When
        response = client.post(
            f'{api_base_url}/auth/login',
            data=json.dumps(data),
            content_type='application/json'
        )
        
        # Then
        assert response.status_code == 401
        result = json.loads(response.data)
        assert result['status'] == 'error'
        assert result['error']['code'] == '1001'  # AUTH_INVALID_CREDENTIALS
    
    def test_login_missing_fields(self, client, api_base_url):
        """í•„ìˆ˜ í•„ë“œ ëˆ„ë½ í…ŒìŠ¤íŠ¸"""
        # Given
        data = {
            'provider': 'google'
            # idToken ëˆ„ë½
        }
        
        # When
        response = client.post(
            f'{api_base_url}/auth/login',
            data=json.dumps(data),
            content_type='application/json'
        )
        
        # Then
        assert response.status_code == 400
        result = json.loads(response.data)
        assert result['status'] == 'error'
    
    def test_refresh_token_success(self, client, mock_supabase, api_base_url):
        """í† í° ê°±ì‹  ì„±ê³µ í…ŒìŠ¤íŠ¸"""
        # Given
        data = {
            'refreshToken': 'valid_refresh_token'
        }
        
        # When
        response = client.post(
            f'{api_base_url}/auth/refresh',
            data=json.dumps(data),
            content_type='application/json'
        )
        
        # Then
        assert response.status_code == 200
        result = json.loads(response.data)
        assert result['status'] == 'success'
        assert 'accessToken' in result['data']
        assert result['data']['accessToken'] == 'new_access_token'
    
    def test_logout_success(self, client, auth_headers, api_base_url):
        """ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í…ŒìŠ¤íŠ¸"""
        # When
        response = client.post(
            f'{api_base_url}/auth/logout',
            headers=auth_headers
        )
        
        # Then
        assert response.status_code == 200
        result = json.loads(response.data)
        assert result['status'] == 'success'
        assert result['message'] == 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤'
```

### [í•„ìˆ˜] í”¼ë“œ API í…ŒìŠ¤íŠ¸
```python
# íŒŒì¼: backend/tests/test_feeds.py
import json
import pytest
from unittest.mock import patch

class TestFeedsAPI:
    """í”¼ë“œ ê´€ë ¨ API í…ŒìŠ¤íŠ¸"""
    
    def test_get_feeds(self, client, mock_supabase, api_base_url):
        """í”¼ë“œ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸"""
        # Given: Mock ë°ì´í„° ì¤€ë¹„
        mock_feeds = [
            {
                'id': 'feed1',
                'user_id': 'user1',
                'content': 'ë§›ìˆì–´ìš”!',
                'created_at': '2024-01-01T00:00:00Z'
            }
        ]
        mock_supabase._data['feeds'] = {f['id']: f for f in mock_feeds}
        
        # When
        response = client.get(f'{api_base_url}/feeds?lat=37.5&lng=127.0&radius=1')
        
        # Then
        assert response.status_code == 200
        data = json.loads(response.data)
        assert data['status'] == 'success'
        assert 'feeds' in data['data']
        assert 'pagination' in data['data']
    
    def test_create_feed_success(self, client, mock_supabase, auth_headers, api_base_url):
        """í”¼ë“œ ìƒì„± ì„±ê³µ í…ŒìŠ¤íŠ¸"""
        # Given
        feed_data = {
            'restaurantId': 'rest123',
            'menuId': 'menu456',
            'imageUrls': ['https://test.com/image.jpg'],
            'content': 'ë§›ìˆì–´ìš”!',
            'tags': ['ë§¤ìš´ë§›', 'ê°€ì„±ë¹„'],
            'location': {
                'lat': 37.5,
                'lng': 127.0,
                'address': 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬'
            }
        }
        
        # When
        response = client.post(
            f'{api_base_url}/feeds',
            data=json.dumps(feed_data),
            headers=auth_headers
        )
        
        # Then
        assert response.status_code == 201
        data = json.loads(response.data)
        assert data['status'] == 'success'
        assert data['data']['content'] == 'ë§›ìˆì–´ìš”!'
    
    def test_create_feed_unauthorized(self, client, api_base_url):
        """ì¸ì¦ ì—†ì´ í”¼ë“œ ìƒì„± ì‹œë„"""
        # Given
        feed_data = {'content': 'test'}
        
        # When
        response = client.post(
            f'{api_base_url}/feeds',
            data=json.dumps(feed_data),
            content_type='application/json'
        )
        
        # Then
        assert response.status_code == 401
    
    @patch('services.vision_service.detect_food')
    def test_no_food_detected(self, mock_detect, client, auth_headers, api_base_url):
        """ìŒì‹ ë¯¸ê°ì§€ í…ŒìŠ¤íŠ¸"""
        # Given
        mock_detect.return_value = False
        feed_data = {
            'restaurantId': 'rest123',
            'menuId': 'menu456',
            'imageUrls': ['https://test.com/not-food.jpg'],
            'content': 'í…ŒìŠ¤íŠ¸',
            'tags': [],
            'location': {
                'lat': 37.5,
                'lng': 127.0,
                'address': 'ì„œìš¸'
            }
        }
        
        # When
        response = client.post(
            f'{api_base_url}/feeds',
            data=json.dumps(feed_data),
            headers=auth_headers
        )
        
        # Then
        assert response.status_code == 422
        data = json.loads(response.data)
        assert data['error']['code'] == '5004'  # BUSINESS_NO_FOOD_DETECTED
```

## 3. Mock ì„¤ì •

### [í•„ìˆ˜] Mock ì„œë¹„ìŠ¤
```python
# íŒŒì¼: backend/tests/utils/mock_services.py
from datetime import datetime

class MockVisionService:
    """Vision API ì„œë¹„ìŠ¤ Mock"""
    
    @staticmethod
    def detect_food(image_url):
        """ìŒì‹ ê°ì§€ Mock"""
        if 'food' in image_url:
            return True
        return False
    
    @staticmethod
    def extract_text(image_url):
        """OCR Mock"""
        if 'receipt' in image_url:
            return {
                'store_name': 'ë§›ìˆëŠ” ì‹ë‹¹',
                'address': 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™',
                'items': ['ê¹€ì¹˜ì°Œê°œ', 'ëœì¥ì°Œê°œ']
            }
        return None

class MockLocationService:
    """ìœ„ì¹˜ ì„œë¹„ìŠ¤ Mock"""
    
    @staticmethod
    def verify_location(lat, lng, store_lat, store_lng, threshold=0.5):
        """ìœ„ì¹˜ ê²€ì¦ Mock"""
        # ê°„ë‹¨í•œ ê±°ë¦¬ ê³„ì‚°
        distance = ((lat - store_lat) ** 2 + (lng - store_lng) ** 2) ** 0.5
        return distance <= threshold
    
    @staticmethod
    def get_address(lat, lng):
        """ì£¼ì†Œ ì¡°íšŒ Mock"""
        return f"ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ({lat}, {lng})"
```

### [í•„ìˆ˜] í…ŒìŠ¤íŠ¸ ì„¤ì •
```python
# íŒŒì¼: backend/config/settings.py (í…ŒìŠ¤íŠ¸ ì„¤ì • ì¶”ê°€)
class TestingConfig(Config):
    """í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •"""
    TESTING = True
    ENV = 'testing'
    
    # Mock ì„œë¹„ìŠ¤ ì‚¬ìš©
    USE_MOCK_SERVICES = True
    
    # í…ŒìŠ¤íŠ¸ìš© ì‹œí¬ë¦¿
    SECRET_KEY = 'test-secret-key'
    SUPABASE_URL = 'http://localhost:54321'
    SUPABASE_KEY = 'test-key'
    
    # ì™¸ë¶€ API í˜¸ì¶œ ë¹„í™œì„±í™”
    DISABLE_EXTERNAL_APIS = True
    
    # ë¡œê·¸ ë ˆë²¨
    LOG_LEVEL = 'DEBUG'
```

## 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### [í•„ìˆ˜] pytest ì‹¤í–‰
```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸
cd backend
pytest

# íŠ¹ì • íŒŒì¼ í…ŒìŠ¤íŠ¸
pytest tests/test_auth.py

# ìƒì„¸ ì¶œë ¥
pytest -v

# ì»¤ë²„ë¦¬ì§€ í¬í•¨
pytest --cov=. --cov-report=html

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ
pytest -k "test_login"

# ë§ˆì»¤ë³„ ì‹¤í–‰
pytest -m "not slow"
```

### [í•„ìˆ˜] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
```ini
# íŒŒì¼: backend/.coveragerc
[run]
source = .
omit = 
    */tests/*
    */venv/*
    */__pycache__/*
    */migrations/*
    */config/*

[report]
precision = 2
show_missing = True
skip_covered = False

[html]
directory = htmlcov

[xml]
output = coverage.xml
```

### [í•„ìˆ˜] pytest ì„¤ì •
```ini
# íŒŒì¼: backend/pytest.ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --tb=short --strict-markers
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
```

### [í•„ìˆ˜] CI/CD í†µí•©
```yaml
# íŒŒì¼: .github/workflows/backend-test.yml
name: Backend Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        cd backend
        pytest --cov=. --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
```

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
- [ ] ì¸ì¦/ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸
- [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] Mock ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 80% ì´ìƒ

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦
```python
# ì£¼ìš” ì‹œë‚˜ë¦¬ì˜¤ ì²´í¬
def test_scenarios():
    """E2E ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸"""
    scenarios = [
        "ì‚¬ìš©ì íšŒì›ê°€ì… â†’ ë¡œê·¸ì¸ â†’ í”¼ë“œ ì‘ì„±",
        "ìœ„ì¹˜ ê²€ì¦ ì‹¤íŒ¨ â†’ ì—ëŸ¬ ì²˜ë¦¬",
        "í† í° ë§Œë£Œ â†’ ê°±ì‹  â†’ ì¬ìš”ì²­",
        "ê¶Œí•œ ì—†ëŠ” ìˆ˜ì • ì‹œë„ â†’ ê±°ë¶€",
        "ìŒì‹ ë¯¸ê°ì§€ â†’ ë“±ë¡ ì‹¤íŒ¨",
        "24ì‹œê°„ ë‚´ ì¤‘ë³µ ë“±ë¡ â†’ ì°¨ë‹¨"
    ]
    
    for scenario in scenarios:
        print(f"âœ“ {scenario}")
```

### í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ
```bash
# HTML ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ìƒì„±
pytest --cov=. --cov-report=html

# ë³´ê³ ì„œ í™•ì¸
open htmlcov/index.html  # Mac/Linux
start htmlcov/index.html  # Windows
```