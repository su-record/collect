# ğŸ”‘ 4.1 Supabase Auth ì—°ë™

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [Flutter ì„¤ì •](#2-flutter-ì„¤ì •)
3. [ì¸ì¦ ì„œë¹„ìŠ¤](#3-ì¸ì¦-ì„œë¹„ìŠ¤)
4. [ë°±ì—”ë“œ ì—°ë™](#4-ë°±ì—”ë“œ-ì—°ë™)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”

Supabase Authë¥¼ Flutter ì•±ê³¼ ì—°ë™í•˜ì—¬ ì¸ì¦ ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… ì´ë©”ì¼/ì†Œì…œ ë¡œê·¸ì¸ ì§€ì›
- âœ… ìë™ ì„¸ì…˜ ê´€ë¦¬
- âœ… ë°±ì—”ë“œ í† í° ê²€ì¦

## 2. Flutter ì„¤ì •

### [í•„ìˆ˜] íŒ¨í‚¤ì§€ ì„¤ì¹˜
```yaml
# íŒŒì¼: pubspec.yaml
dependencies:
  supabase_flutter: ^2.0.0
  google_sign_in: ^6.1.5
  sign_in_with_apple: ^5.0.0
  crypto: ^3.0.3
```

### [í•„ìˆ˜] Supabase ì´ˆê¸°í™”
```dart
// íŒŒì¼: lib/main.dart
import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Supabase.initialize(
    url: const String.fromEnvironment(
      'SUPABASE_URL',
      defaultValue: 'http://localhost:54321',
    ),
    anonKey: const String.fromEnvironment(
      'SUPABASE_ANON_KEY',
      defaultValue: 'your-anon-key-here',
    ),
    authOptions: const FlutterAuthClientOptions(
      authFlowType: AuthFlowType.pkce,
      autoRefreshToken: true,
    ),
  );
  
  runApp(const MyApp());
}

// ì „ì—­ ì ‘ê·¼
final supabase = Supabase.instance.client;
```

## 3. ì¸ì¦ ì„œë¹„ìŠ¤

### [í•„ìˆ˜] ê¸°ë³¸ ì¸ì¦ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/services/auth_service.dart
import 'package:supabase_flutter/supabase_flutter.dart';
import 'dart:math';

class AuthService {
  final SupabaseClient _supabase = Supabase.instance.client;
  
  // í˜„ì¬ ì‚¬ìš©ì
  User? get currentUser => _supabase.auth.currentUser;
  
  // ì¸ì¦ ìƒíƒœ ìŠ¤íŠ¸ë¦¼
  Stream<AuthState> get authStateChanges => 
      _supabase.auth.onAuthStateChange;

  // ì´ë©”ì¼ íšŒì›ê°€ì…
  Future<AuthResponse> signUpWithEmail({
    required String email,
    required String password,
    required String nickname,
  }) async {
    // 1. Auth íšŒì›ê°€ì…
    final authResponse = await _supabase.auth.signUp(
      email: email,
      password: password,
      data: {'nickname': nickname},
    );

    if (authResponse.user != null) {
      // 2. í”„ë¡œí•„ ìƒì„±
      await _supabase.from('users').insert({
        'id': authResponse.user!.id,
        'email': email,
        'nickname': nickname,
        'grade': 1,
        'activity_points': 0,
      });
    }

    return authResponse;
  }

  // ì´ë©”ì¼ ë¡œê·¸ì¸
  Future<AuthResponse> signInWithEmail({
    required String email,
    required String password,
  }) async {
    return await _supabase.auth.signInWithPassword(
      email: email,
      password: password,
    );
  }

  // ë¡œê·¸ì•„ì›ƒ
  Future<void> signOut() async {
    await _supabase.auth.signOut();
  }
}
```

### [ì„ íƒ] ì†Œì…œ ë¡œê·¸ì¸
```dart
// íŒŒì¼: lib/services/social_auth_service.dart
import 'package:google_sign_in/google_sign_in.dart';
import 'package:sign_in_with_apple/sign_in_with_apple.dart';
import 'package:crypto/crypto.dart';
import 'dart:convert';

extension SocialAuth on AuthService {
  // Google ë¡œê·¸ì¸
  Future<AuthResponse> signInWithGoogle() async {
    final GoogleSignIn googleSignIn = GoogleSignIn(
      clientId: const String.fromEnvironment('GOOGLE_CLIENT_ID'),
    );
    
    final googleUser = await googleSignIn.signIn();
    if (googleUser == null) throw Exception('Google ë¡œê·¸ì¸ ì·¨ì†Œ');
    
    final googleAuth = await googleUser.authentication;
    
    final response = await _supabase.auth.signInWithIdToken(
      provider: OAuthProvider.google,
      idToken: googleAuth.idToken!,
      accessToken: googleAuth.accessToken,
    );
    
    // í”„ë¡œí•„ ìƒì„±
    if (response.user != null) {
      await _createProfileIfNotExists(
        userId: response.user!.id,
        email: response.user!.email!,
        nickname: googleUser.displayName ?? 'User${Random().nextInt(9999)}',
        profileImageUrl: googleUser.photoUrl,
      );
    }
    
    return response;
  }
  
  // í”„ë¡œí•„ ìƒì„± í—¬í¼
  Future<void> _createProfileIfNotExists({
    required String userId,
    required String email,
    required String nickname,
    String? profileImageUrl,
  }) async {
    final existing = await _supabase
        .from('users')
        .select()
        .eq('id', userId)
        .maybeSingle();
        
    if (existing == null) {
      await _supabase.from('users').insert({
        'id': userId,
        'email': email,
        'nickname': nickname,
        'profile_image_url': profileImageUrl,
        'grade': 1,
        'activity_points': 0,
      });
    }
  }
}
```

### [í•„ìˆ˜] Provider ì„¤ì •
```dart
// íŒŒì¼: lib/providers/auth_provider.dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../services/auth_service.dart';

// AuthService Provider
final authServiceProvider = Provider<AuthService>((ref) {
  return AuthService();
});

// í˜„ì¬ ì‚¬ìš©ì Provider
final currentUserProvider = StreamProvider<User?>((ref) {
  final authService = ref.watch(authServiceProvider);
  return authService.authStateChanges.map((state) => state.session?.user);
});

// ì¸ì¦ ìƒíƒœ Provider
final isAuthenticatedProvider = Provider<bool>((ref) {
  final user = ref.watch(currentUserProvider);
  return user.maybeWhen(
    data: (user) => user != null,
    orElse: () => false,
  );
});
```

## 4. ë°±ì—”ë“œ ì—°ë™

### [í•„ìˆ˜] Flask í† í° ê²€ì¦
```python
# íŒŒì¼: backend/middleware/auth.py
from functools import wraps
from flask import request, jsonify
from supabase import create_client
import os

# Supabase í´ë¼ì´ì–¸íŠ¸
supabase = create_client(
    os.getenv('SUPABASE_URL', 'http://localhost:54321'),
    os.getenv('SUPABASE_SERVICE_ROLE_KEY')
)

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_header = request.headers.get('Authorization')
        
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'error': 'Missing token'}), 401
        
        token = auth_header.split(' ')[1]
        
        try:
            # í† í° ê²€ì¦
            user = supabase.auth.get_user(token)
            request.current_user = user.user
            request.user_id = user.user.id
        except Exception as e:
            return jsonify({'error': 'Invalid token'}), 401
        
        return f(*args, **kwargs)
    
    return decorated_function
```

### [í•„ìˆ˜] API ìš”ì²­ í—¬í¼
```dart
// íŒŒì¼: lib/services/api_service.dart
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:supabase_flutter/supabase_flutter.dart';

class ApiService {
  final String baseUrl = const String.fromEnvironment(
    'API_BASE_URL',
    defaultValue: 'http://localhost:5000/api',
  );
  
  Future<Map<String, String>> _getHeaders() async {
    final session = Supabase.instance.client.auth.currentSession;
    
    return {
      'Content-Type': 'application/json',
      if (session != null) 'Authorization': 'Bearer ${session.accessToken}',
    };
  }
  
  Future<http.Response> get(String endpoint) async {
    final headers = await _getHeaders();
    return http.get(
      Uri.parse('$baseUrl$endpoint'),
      headers: headers,
    );
  }
  
  Future<http.Response> post(String endpoint, Map<String, dynamic> body) async {
    final headers = await _getHeaders();
    return http.post(
      Uri.parse('$baseUrl$endpoint'),
      headers: headers,
      body: jsonEncode(body),
    );
  }
}
```

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì´ë©”ì¼ íšŒì›ê°€ì… ì‘ë™
- [ ] ì´ë©”ì¼ ë¡œê·¸ì¸ ì‘ë™
- [ ] ë¡œê·¸ì•„ì›ƒ ì‘ë™
- [ ] í† í° ìë™ ê°±ì‹  í™•ì¸
- [ ] Backend API ì¸ì¦ í™•ì¸

### ğŸ§ª ì¸ì¦ í…ŒìŠ¤íŠ¸
```dart
// íŒŒì¼: test/auth_test.dart
void testAuth() async {
  final authService = AuthService();
  
  // íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸
  try {
    await authService.signUpWithEmail(
      email: 'test@example.com',
      password: 'password123',
      nickname: 'testuser',
    );
    print('íšŒì›ê°€ì… ì„±ê³µ');
  } catch (e) {
    print('íšŒì›ê°€ì… ì‹¤íŒ¨: $e');
  }
  
  // ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
  try {
    await authService.signInWithEmail(
      email: 'test@example.com',
      password: 'password123',
    );
    print('ë¡œê·¸ì¸ ì„±ê³µ');
    print('í˜„ì¬ ì‚¬ìš©ì: ${authService.currentUser?.email}');
  } catch (e) {
    print('ë¡œê·¸ì¸ ì‹¤íŒ¨: $e');
  }
}
```