# ğŸ” 4.2 ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [Google ë¡œê·¸ì¸](#2-google-ë¡œê·¸ì¸)
3. [Apple ë¡œê·¸ì¸](#3-apple-ë¡œê·¸ì¸)
4. [í”Œë«í¼ ì„¤ì •](#4-í”Œë«í¼-ì„¤ì •)
5. [ê²€ì¦](#5-ê²€ì¦)

## 1. ê°œìš”

Supabase Authë¥¼ í†µí•œ ì†Œì…œ ë¡œê·¸ì¸ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… Google/Apple ë¡œê·¸ì¸ ì§€ì›
- âœ… Supabase Auth í†µí•©
- âœ… ìë™ í”„ë¡œí•„ ìƒì„±

## 2. Google ë¡œê·¸ì¸

### [í•„ìˆ˜] Google Sign In ì„¤ì •
```dart
// íŒŒì¼: lib/services/google_auth_service.dart
import 'package:google_sign_in/google_sign_in.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'dart:math';

class GoogleAuthService {
  final _googleSignIn = GoogleSignIn(
    scopes: ['email', 'profile'],
    // Web í´ë¼ì´ì–¸íŠ¸ ID í•„ìš” (iOS/Android ë‘˜ ë‹¤)
    clientId: const String.fromEnvironment('GOOGLE_CLIENT_ID'),
  );
  
  final _supabase = Supabase.instance.client;
  
  Future<AuthResponse> signIn() async {
    try {
      // 1. Google ë¡œê·¸ì¸ í”Œë¡œìš°
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
      
      if (googleUser == null) {
        throw Exception('Google ë¡œê·¸ì¸ ì·¨ì†Œë¨');
      }
      
      // 2. ì¸ì¦ í† í° íšë“
      final GoogleSignInAuthentication googleAuth = 
          await googleUser.authentication;
      
      // 3. Supabaseë¡œ ì¸ì¦
      final response = await _supabase.auth.signInWithIdToken(
        provider: OAuthProvider.google,
        idToken: googleAuth.idToken!,
        accessToken: googleAuth.accessToken,
      );
      
      // 4. í”„ë¡œí•„ ìƒì„±/ì—…ë°ì´íŠ¸
      if (response.user != null) {
        await _ensureUserProfile(
          userId: response.user!.id,
          email: response.user!.email!,
          displayName: googleUser.displayName,
          photoUrl: googleUser.photoUrl,
        );
      }
      
      return response;
      
    } catch (error) {
      throw _handleAuthError(error);
    }
  }
  
  Future<void> signOut() async {
    await _googleSignIn.signOut();
  }
  
  // í”„ë¡œí•„ í™•ì¸ ë° ìƒì„±
  Future<void> _ensureUserProfile({
    required String userId,
    required String email,
    String? displayName,
    String? photoUrl,
  }) async {
    // ê¸°ì¡´ í”„ë¡œí•„ í™•ì¸
    final existing = await _supabase
        .from('users')
        .select()
        .eq('id', userId)
        .maybeSingle();
    
    if (existing == null) {
      // ë‹‰ë„¤ì„ ìƒì„±
      final nickname = displayName ?? 'User${Random().nextInt(9999)}';
      
      // í”„ë¡œí•„ ìƒì„±
      await _supabase.from('users').insert({
        'id': userId,
        'email': email,
        'nickname': await _generateUniqueNickname(nickname),
        'profile_image_url': photoUrl,
        'grade': 1,
        'activity_points': 0,
      });
    }
  }
  
  // ê³ ìœ  ë‹‰ë„¤ì„ ìƒì„±
  Future<String> _generateUniqueNickname(String base) async {
    String nickname = base;
    int suffix = 1;
    
    while (true) {
      final exists = await _supabase
          .from('users')
          .select('id')
          .eq('nickname', nickname)
          .maybeSingle();
      
      if (exists == null) break;
      
      nickname = '$base$suffix';
      suffix++;
    }
    
    return nickname;
  }
  
  Exception _handleAuthError(dynamic error) {
    if (error.toString().contains('popup_closed')) {
      return Exception('ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤');
    }
    return Exception('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: $error');
  }
}
```

## 3. Apple ë¡œê·¸ì¸

### [í•„ìˆ˜] Apple Sign In ì„¤ì •
```dart
// íŒŒì¼: lib/services/apple_auth_service.dart
import 'package:sign_in_with_apple/sign_in_with_apple.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:crypto/crypto.dart';
import 'dart:convert';
import 'dart:math';

class AppleAuthService {
  final _supabase = Supabase.instance.client;
  
  Future<AuthResponse> signIn() async {
    try {
      // 1. Nonce ìƒì„±
      final rawNonce = _generateNonce();
      final hashedNonce = sha256.convert(utf8.encode(rawNonce)).toString();
      
      // 2. Apple ë¡œê·¸ì¸ ìš”ì²­
      final credential = await SignInWithApple.getAppleIDCredential(
        scopes: [
          AppleIDAuthorizationScopes.email,
          AppleIDAuthorizationScopes.fullName,
        ],
        nonce: hashedNonce,
      );
      
      // 3. Supabase ì¸ì¦
      final response = await _supabase.auth.signInWithIdToken(
        provider: OAuthProvider.apple,
        idToken: credential.identityToken!,
        nonce: rawNonce,
      );
      
      // 4. í”„ë¡œí•„ ìƒì„±
      if (response.user != null) {
        await _ensureUserProfile(
          userId: response.user!.id,
          email: credential.email ?? response.user!.email,
          fullName: _buildFullName(credential),
        );
      }
      
      return response;
      
    } catch (error) {
      throw _handleAuthError(error);
    }
  }
  
  // ì „ì²´ ì´ë¦„ ìƒì„±
  String? _buildFullName(AuthorizationCredentialAppleID credential) {
    final parts = [
      credential.givenName,
      credential.familyName,
    ].where((part) => part != null && part.isNotEmpty);
    
    return parts.isEmpty ? null : parts.join(' ');
  }
  
  // í”„ë¡œí•„ ìƒì„±
  Future<void> _ensureUserProfile({
    required String userId,
    String? email,
    String? fullName,
  }) async {
    final existing = await _supabase
        .from('users')
        .select()
        .eq('id', userId)
        .maybeSingle();
    
    if (existing == null) {
      final nickname = fullName ?? 'AppleUser${Random().nextInt(9999)}';
      
      await _supabase.from('users').insert({
        'id': userId,
        'email': email ?? '$userId@privaterelay.appleid.com',
        'nickname': nickname,
        'grade': 1,
        'activity_points': 0,
      });
    }
  }
  
  // Nonce ìƒì„±
  String _generateNonce([int length = 32]) {
    const charset = 
        '0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-._';
    final random = Random.secure();
    return List.generate(
      length, 
      (_) => charset[random.nextInt(charset.length)]
    ).join();
  }
  
  Exception _handleAuthError(dynamic error) {
    if (error is SignInWithAppleAuthorizationException) {
      switch (error.code) {
        case AuthorizationErrorCode.canceled:
          return Exception('Apple ë¡œê·¸ì¸ ì·¨ì†Œë¨');
        case AuthorizationErrorCode.failed:
          return Exception('Apple ë¡œê·¸ì¸ ì‹¤íŒ¨');
        case AuthorizationErrorCode.notHandled:
          return Exception('Apple ë¡œê·¸ì¸ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        default:
          return Exception('Apple ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}');
      }
    }
    return Exception('Apple ë¡œê·¸ì¸ ì‹¤íŒ¨: $error');
  }
}
```

### [í•„ìˆ˜] í†µí•© ì†Œì…œ ë¡œê·¸ì¸ ì„œë¹„ìŠ¤
```dart
// íŒŒì¼: lib/services/social_auth_service.dart
import 'package:flutter/foundation.dart';
import 'google_auth_service.dart';
import 'apple_auth_service.dart';

enum SocialProvider { google, apple }

class SocialAuthService {
  final _googleAuth = GoogleAuthService();
  final _appleAuth = AppleAuthService();
  
  Future<AuthResponse> signIn(SocialProvider provider) async {
    switch (provider) {
      case SocialProvider.google:
        return await _googleAuth.signIn();
      case SocialProvider.apple:
        return await _appleAuth.signIn();
    }
  }
  
  Future<void> signOut() async {
    await _googleAuth.signOut();
    // Appleì€ ë³„ë„ ë¡œê·¸ì•„ì›ƒ ë¶ˆí•„ìš”
  }
  
  // í”Œë«í¼ë³„ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œë°”ì´ë”
  List<SocialProvider> get availableProviders {
    final providers = [SocialProvider.google];
    
    // iOSì—ì„œë§Œ Apple ë¡œê·¸ì¸ í‘œì‹œ
    if (defaultTargetPlatform == TargetPlatform.iOS) {
      providers.add(SocialProvider.apple);
    }
    
    return providers;
  }
}
```

## 4. í”Œë«í¼ ì„¤ì •

### [í•„ìˆ˜] iOS ì„¤ì •
```xml
<!-- íŒŒì¼: ios/Runner/Info.plist -->
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <!-- Google Sign-In -->
            <string>com.googleusercontent.apps.YOUR_IOS_CLIENT_ID</string>
            <!-- Supabase ë¦¬ë‹¤ì´ë ‰íŠ¸ -->
            <string>com.example.fallingo</string>
        </array>
    </dict>
</array>

<!-- Google Sign-In ì„¤ì • -->
<key>GIDClientID</key>
<string>YOUR_IOS_CLIENT_ID</string>
```

### [í•„ìˆ˜] Android ì„¤ì •
```xml
<!-- íŒŒì¼: android/app/src/main/AndroidManifest.xml -->
<activity
    android:name="com.linusu.flutter_web_auth_2.CallbackActivity"
    android:exported="true">
    <intent-filter android:label="flutter_web_auth_2">
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data android:scheme="com.example.fallingo" />
    </intent-filter>
</activity>
```

### [í•„ìˆ˜] Supabase ëŒ€ì‹œë³´ë“œ ì„¤ì •
```yaml
# Supabase Dashboard > Authentication > Providers

Google:
  enabled: true
  client_id: "YOUR_WEB_CLIENT_ID"
  secret: "YOUR_CLIENT_SECRET"
  
Apple:
  enabled: true
  client_id: "com.example.fallingo"
  secret: "YOUR_APPLE_SECRET_KEY"
```

## 5. ê²€ì¦

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] Google ë¡œê·¸ì¸ ì‘ë™
- [ ] Apple ë¡œê·¸ì¸ ì‘ë™ (iOS)
- [ ] í”„ë¡œí•„ ìë™ ìƒì„±
- [ ] ì¤‘ë³µ ë‹‰ë„¤ì„ ì²˜ë¦¬
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë™ì‘

### ğŸ§ª ì†Œì…œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
```dart
// íŒŒì¼: lib/screens/test_social_login.dart
class TestSocialLogin extends ConsumerWidget {
  final _socialAuth = SocialAuthService();
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            // Google ë¡œê·¸ì¸ ë²„íŠ¼
            ElevatedButton.icon(
              onPressed: () async {
                try {
                  final response = await _socialAuth.signIn(
                    SocialProvider.google
                  );
                  print('Google ë¡œê·¸ì¸ ì„±ê³µ: ${response.user?.email}');
                } catch (e) {
                  print('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: $e');
                }
              },
              icon: Icon(Icons.g_mobiledata),
              label: Text('Googleë¡œ ë¡œê·¸ì¸'),
            ),
            
            // Apple ë¡œê·¸ì¸ ë²„íŠ¼ (iOSë§Œ)
            if (_socialAuth.availableProviders.contains(SocialProvider.apple))
              SignInWithAppleButton(
                onPressed: () async {
                  try {
                    final response = await _socialAuth.signIn(
                      SocialProvider.apple
                    );
                    print('Apple ë¡œê·¸ì¸ ì„±ê³µ: ${response.user?.id}');
                  } catch (e) {
                    print('Apple ë¡œê·¸ì¸ ì‹¤íŒ¨: $e');
                  }
                },
              ),
          ],
        ),
      ),
    );
  }
}
```