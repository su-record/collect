# ğŸ“Š 6.4 ìƒíƒœ ê´€ë¦¬ ì•„í‚¤í…ì²˜

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [Riverpod ê¸°ë³¸ ì„¤ì •](#2-riverpod-ê¸°ë³¸-ì„¤ì •)
3. [Provider êµ¬ì¡° ì„¤ê³„](#3-provider-êµ¬ì¡°-ì„¤ê³„)
4. [ìƒíƒœ ê´€ë¦¬ êµ¬í˜„](#4-ìƒíƒœ-ê´€ë¦¬-êµ¬í˜„)
5. [ì‹¤ì „ ì˜ˆì œ](#5-ì‹¤ì „-ì˜ˆì œ)

## 1. ê°œìš”

FallingoëŠ” **Riverpod**ì„ ì‚¬ìš©í•˜ì—¬ ì•±ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. Riverpodì€ Providerì˜ ê°œì„ ëœ ë²„ì „ìœ¼ë¡œ, ì»´íŒŒì¼ íƒ€ì„ ì•ˆì „ì„±ê³¼ ë” ë‚˜ì€ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
- âœ… íƒ€ì… ì•ˆì „í•œ ìƒíƒœ ê´€ë¦¬
- âœ… ì˜ì¡´ì„± ì£¼ì… ìë™í™”
- âœ… í…ŒìŠ¤íŠ¸ ìš©ì´ì„±

## 2. Riverpod ê¸°ë³¸ ì„¤ì •

### [í•„ìˆ˜] íŒ¨í‚¤ì§€ ì„¤ì¹˜
```yaml
# íŒŒì¼: pubspec.yaml
dependencies:
  flutter_riverpod: ^2.4.0
  riverpod_annotation: ^2.3.0

dev_dependencies:
  riverpod_generator: ^2.3.0
  build_runner: ^2.4.0
```

### [í•„ìˆ˜] ì•± ì§„ì…ì  ì„¤ì •
```dart
// íŒŒì¼: lib/main.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:fallingo/app.dart';

void main() {
  runApp(
    ProviderScope(
      child: FallingoApp(),
    ),
  );
}
```

## 3. Provider êµ¬ì¡° ì„¤ê³„

### [í•„ìˆ˜] Provider ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
lib/
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ auth_provider.dart
â”‚   â”‚   â””â”€â”€ auth_state.dart
â”‚   â”œâ”€â”€ feed/
â”‚   â”‚   â”œâ”€â”€ feed_provider.dart
â”‚   â”‚   â””â”€â”€ feed_state.dart
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ user_provider.dart
â”‚   â”‚   â””â”€â”€ user_state.dart
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ location_provider.dart
â”‚       â””â”€â”€ app_state_provider.dart
```

## 4. ìƒíƒœ ê´€ë¦¬ êµ¬í˜„

### [í•„ìˆ˜] ì¸ì¦ ìƒíƒœ ê´€ë¦¬
```dart
// íŒŒì¼: lib/providers/auth/auth_state.dart
import 'package:freezed_annotation/freezed_annotation.dart';
import 'package:fallingo/models/user.dart';

part 'auth_state.freezed.dart';

@freezed
class AuthState with _$AuthState {
  const factory AuthState({
    @Default(false) bool isLoading,
    @Default(false) bool isAuthenticated,
    User? currentUser,
    String? error,
  }) = _AuthState;
}
```

```dart
// íŒŒì¼: lib/providers/auth/auth_provider.dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:fallingo/services/auth_service.dart';
import 'auth_state.dart';

part 'auth_provider.g.dart';

@riverpod
class Auth extends _$Auth {
  @override
  AuthState build() {
    return const AuthState();
  }

  Future<void> signInWithGoogle() async {
    state = state.copyWith(isLoading: true, error: null);
    
    try {
      final authService = ref.read(authServiceProvider);
      final user = await authService.signInWithGoogle();
      
      state = state.copyWith(
        isLoading: false,
        isAuthenticated: true,
        currentUser: user,
      );
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: e.toString(),
      );
    }
  }

  void signOut() async {
    state = state.copyWith(isLoading: true);
    
    try {
      final authService = ref.read(authServiceProvider);
      await authService.signOut();
      
      state = const AuthState();
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: e.toString(),
      );
    }
  }
}

// í˜„ì¬ ì‚¬ìš©ì Provider
@riverpod
User? currentUser(CurrentUserRef ref) {
  final authState = ref.watch(authProvider);
  return authState.currentUser;
}

// ì¸ì¦ ìƒíƒœ Provider
@riverpod
bool isAuthenticated(IsAuthenticatedRef ref) {
  final authState = ref.watch(authProvider);
  return authState.isAuthenticated;
}
```

### [í•„ìˆ˜] í”¼ë“œ ìƒíƒœ ê´€ë¦¬
```dart
// íŒŒì¼: lib/providers/feed/feed_provider.dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:fallingo/models/feed.dart';
import 'package:fallingo/services/feed_service.dart';

part 'feed_provider.g.dart';

// í”¼ë“œ ëª©ë¡ Provider
@riverpod
class FeedList extends _$FeedList {
  @override
  Future<List<Feed>> build() async {
    final location = ref.watch(locationProvider);
    final feedService = ref.read(feedServiceProvider);
    
    return feedService.getNearbyFeeds(
      latitude: location.latitude,
      longitude: location.longitude,
      radius: 1000, // 1km
    );
  }

  Future<void> refresh() async {
    ref.invalidateSelf();
  }

  Future<void> addFeed(Feed feed) async {
    final feedService = ref.read(feedServiceProvider);
    await feedService.createFeed(feed);
    ref.invalidateSelf();
  }
}

// ê°œë³„ í”¼ë“œ Provider (Family)
@riverpod
Future<Feed?> feedDetail(FeedDetailRef ref, String feedId) async {
  final feedService = ref.read(feedServiceProvider);
  return feedService.getFeedById(feedId);
}

// í”¼ë“œ í•„í„° Provider
@riverpod
class FeedFilter extends _$FeedFilter {
  @override
  FeedFilterOptions build() {
    return FeedFilterOptions(
      categories: [],
      radius: 1000,
      sortBy: SortBy.distance,
    );
  }

  void updateCategories(List<String> categories) {
    state = state.copyWith(categories: categories);
  }

  void updateRadius(int radius) {
    state = state.copyWith(radius: radius);
  }
}
```

### [í•„ìˆ˜] ìœ„ì¹˜ ì •ë³´ Provider
```dart
// íŒŒì¼: lib/providers/common/location_provider.dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:geolocator/geolocator.dart';

part 'location_provider.g.dart';

@riverpod
class Location extends _$Location {
  @override
  Future<Position> build() async {
    // ìœ„ì¹˜ ê¶Œí•œ í™•ì¸
    final permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      await Geolocator.requestPermission();
    }
    
    // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    return await Geolocator.getCurrentPosition();
  }

  Future<void> updateLocation() async {
    state = const AsyncValue.loading();
    state = await AsyncValue.guard(() async {
      return await Geolocator.getCurrentPosition();
    });
  }
}

// ìœ„ì¹˜ ìŠ¤íŠ¸ë¦¼ Provider
@riverpod
Stream<Position> locationStream(LocationStreamRef ref) {
  return Geolocator.getPositionStream(
    locationSettings: const LocationSettings(
      accuracy: LocationAccuracy.high,
      distanceFilter: 100, // 100ë¯¸í„°ë§ˆë‹¤ ì—…ë°ì´íŠ¸
    ),
  );
}
```

## 5. ì‹¤ì „ ì˜ˆì œ

### [í•„ìˆ˜] UIì—ì„œ Provider ì‚¬ìš©
```dart
// íŒŒì¼: lib/screens/feed/feed_screen.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class FeedScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final feedListAsync = ref.watch(feedListProvider);
    
    return Scaffold(
      appBar: AppBar(title: Text('Fallingo')),
      body: feedListAsync.when(
        data: (feeds) => RefreshIndicator(
          onRefresh: () => ref.refresh(feedListProvider.future),
          child: ListView.builder(
            itemCount: feeds.length,
            itemBuilder: (context, index) {
              final feed = feeds[index];
              return FeedCard(feed: feed);
            },
          ),
        ),
        loading: () => Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'),
              TextButton(
                onPressed: () => ref.refresh(feedListProvider),
                child: Text('ë‹¤ì‹œ ì‹œë„'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

### [ì„ íƒ] Consumer ìœ„ì ¯ ì‚¬ìš© íŒ¨í„´
```dart
// íŒŒì¼: lib/widgets/user_profile_widget.dart

// 1. ConsumerWidget ì‚¬ìš©
class UserProfileWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final user = ref.watch(currentUserProvider);
    
    if (user == null) {
      return Text('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    }
    
    return Column(
      children: [
        CircleAvatar(
          backgroundImage: NetworkImage(user.profileImage),
        ),
        Text(user.nickname),
        Text('ë“±ê¸‰: ${user.grade}'),
      ],
    );
  }
}

// 2. Consumer ì‚¬ìš© (ë¶€ë¶„ ë¦¬ë¹Œë“œ)
class PartialRebuildExample extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text('ì •ì  ì»¨í…ì¸ '),
        Consumer(
          builder: (context, ref, child) {
            final feedCount = ref.watch(feedListProvider).valueOrNull?.length ?? 0;
            return Text('í”¼ë“œ ê°œìˆ˜: $feedCount');
          },
        ),
      ],
    );
  }
}
```

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ProviderScopeë¡œ ì•± ê°ì‹¸ê¸°
- [ ] Provider íŒŒì¼ êµ¬ì¡° ìƒì„±
- [ ] ì½”ë“œ ìƒì„± ì‹¤í–‰ (`flutter pub run build_runner build`)
- [ ] AsyncValueë¡œ ë¹„ë™ê¸° ìƒíƒœ ì²˜ë¦¬
- [ ] ref.refresh()ë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨